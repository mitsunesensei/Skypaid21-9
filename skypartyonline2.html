<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Launcher - Windows XP Style</title>
    
    <!-- Firebase removed - using Railway API instead -->
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
            background: linear-gradient(135deg, #5A7FCC 0%, #4A6FB5 50%, #345995 100%);
            height: 100vh;
            overflow: hidden;
            cursor: default;
        }
        
        .desktop {
            height: 100vh;
            width: 100vw;
            position: relative;
            background: transparent;
        }
        
        .window {
            position: absolute;
            background: #ece9d8;
            border: 1px outset #ece9d8;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            min-width: 800px;
            min-height: 600px;
        }
        
        .title-bar {
            height: 32px;
            background: linear-gradient(to bottom, #0a246a 0%, #0a246a 8%, #3985d6 25%, #4a95e6 65%, #1553a3 100%);
            display: flex;
            align-items: center;
            padding: 0 6px;
            color: white;
            font-weight: bold;
            font-size: 12px;
            -webkit-app-region: drag;
            cursor: move;
        }
        
        .title-bar-icon {
            width: 20px;
            height: 20px;
            background: #ff6b6b;
            margin-right: 6px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            -webkit-app-region: no-drag;
        }
        
        .title-bar-text {
            flex: 1;
        }
        
        .window-controls {
            display: flex;
            gap: 1px;
            -webkit-app-region: no-drag;
        }
        
        .window-control {
            width: 22px;
            height: 18px;
            background: linear-gradient(to bottom, #e6e6e6 0%, #d0d0d0 100%);
            border: 1px outset #e6e6e6;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }
        
        .window-control:active {
            border: 1px inset #e6e6e6;
        }
        
        .window-control.minimize {
            background: linear-gradient(to bottom, #4a90e2 0%, #357abd 100%);
            color: white;
        }
        
        .window-control.maximize {
            background: linear-gradient(to bottom, #4a90e2 0%, #357abd 100%);
            color: white;
        }
        
        .window-control.close {
            background: linear-gradient(to bottom, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .menu-bar {
            height: 22px;
            background: #ece9d8;
            border-bottom: 1px solid #c0c0c0;
            display: flex;
            align-items: center;
            padding: 0 4px;
        }
        
        .menu-item {
            padding: 4px 8px;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background: #316ac5;
            color: white;
        }
        
        .content {
            height: calc(100% - 54px);
            background: #ece9d8;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 200px;
            background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
            border-right: 1px solid #c0c0c0;
            padding: 8px;
        }
        
        .sidebar-section {
            margin-bottom: 16px;
        }
        
        .sidebar-title {
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .sidebar-item {
            padding: 4px 8px;
            cursor: pointer;
            border: 1px solid transparent;
            margin: 1px 0;
            font-size: 11px;
        }
        
        .sidebar-item:hover {
            background: #316ac5;
            color: white;
        }
        
        .sidebar-item.active {
            background: #316ac5;
            color: white;
        }
        
        .main-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        .form-input {
            width: 200px;
            height: 20px;
            border: 1px inset #c0c0c0;
            padding: 2px 4px;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
        }
        
        .xp-button {
            background: linear-gradient(to bottom, #f0f0f0 0%, #d0d0d0 100%);
            border: 1px outset #d0d0d0;
            padding: 8px 20px;
            font-family: 'Tahoma', sans-serif;
            font-size: 12px;
            cursor: pointer;
            margin-right: 8px;
            font-weight: bold;
            min-width: 60px;
        }
        
        .xp-button:active {
            border: 1px inset #d0d0d0;
        }
        
        .xp-button.primary {
            background: linear-gradient(to bottom, #4a90e2 0%, #357abd 100%);
            color: white;
            border: 1px outset #4a90e2;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }
        
        .game-card {
            background: white;
            border: 2px inset #ece9d8;
            padding: 0;
            cursor: pointer;
            text-align: center;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 180px;
            display: flex;
            align-items: flex-end;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
        }

        .game-card:hover {
            border: 2px outset #316ac5;
        }

        .game-card-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            padding: 4px 8px;
            backdrop-filter: blur(2px);
            font-size: 10px;
        }

        .game-card.disabled {
            background: #d0d0d0 !important;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .game-card.disabled:hover {
            border: 2px inset #ece9d8;
        }

        .game-card.disabled .game-card-content {
            background: rgba(0, 0, 0, 0.2);
            color: #666;
        }

        .game-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            margin: 0 auto 8px;
            border: 2px outset #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        .game-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .game-status {
            font-size: 9px;
            color: #666;
        }
        
        .wallet-panel {
            background: white;
            border: 2px inset #ece9d8;
            padding: 12px;
            margin-bottom: 16px;
        }
        
        .wallet-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }
        
        .status-indicator.connected {
            background: #44ff44;
        }
        
        .credits-display {
            background: #f0f0f0;
            border: 1px inset #c0c0c0;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            color: #1f4e79;
        }
        
        .user-info {
            background: white;
            border: 1px inset #c0c0c0;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 10px;
            position: relative;
            padding-left: 32px;
        }

        .user-info.logged-in {
            padding-left: 40px;
        }

        .user-info-avatar {
            position: absolute;
            top: 2px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border: 1px outset #d0d0d0;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0.9;
        }

        .user-info-avatar.logged-in {
            width: 32px;
            height: 32px;
            font-size: 18px;
            border-radius: 4px;
        }

        .credits-info {
            background: white;
            border: 1px inset #c0c0c0;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 10px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .credits-amount {
            font-weight: bold;
            color: #1f4e79;
            font-size: 11px;
        }

        .credits-topup {
            width: 20px;
            height: 20px;
            background: linear-gradient(to bottom, #f0f0f0 0%, #d0d0d0 100%);
            border: 1px outset #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #1f4e79;
        }

        .credits-topup:hover {
            background: linear-gradient(to bottom, #e0e0e0 0%, #c0c0c0 100%);
        }

        .credits-topup:active {
            border: 1px inset #d0d0d0;
        }

        .credits-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .credits-option {
            background: white;
            border: 2px outset #ece9d8;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .credits-option:hover {
            background: #f0f8ff;
            border: 2px outset #316ac5;
        }

        .credits-option:active {
            border: 2px inset #ece9d8;
            background: #e8f4fd;
        }

        .credits-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .credits-package-title {
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .credits-package-price {
            color: #228b22;
            font-weight: bold;
            font-size: 11px;
        }

        .activation-code-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .activation-code-box {
            width: 60px;
            height: 20px;
            border: 1px inset #c0c0c0;
            padding: 2px 4px;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .activation-code-box:focus {
            outline: none;
            border: 1px inset #316ac5;
            background: #f0f8ff;
        }

        .activation-separator {
            font-weight: bold;
            color: #1f4e79;
            font-size: 12px;
        }

        .activation-code-box.activated {
            background: #d0d0d0;
            color: #666;
            border: 1px inset #a0a0a0;
            cursor: not-allowed;
        }

        .activation-code-box.activated:focus {
            border: 1px inset #a0a0a0;
            background: #d0d0d0;
        }

        .activation-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .activation-checkmark {
            font-size: 16px;
            color: #228b22;
        }

        .activation-cancel-btn {
            background: linear-gradient(to bottom, #ff6b6b 0%, #ee5a52 100%);
            border: 1px outset #ff6b6b;
            padding: 4px 8px;
            font-family: 'Tahoma', sans-serif;
            font-size: 10px;
            cursor: pointer;
            color: white;
            margin-left: 8px;
        }

        .activation-cancel-btn:hover {
            background: linear-gradient(to bottom, #ff5252 0%, #e53935 100%);
        }

        .activation-cancel-btn:active {
            border: 1px inset #ff6b6b;
        }

        /* Notification Dot Styles */
        .notification-dot {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            border: 1px solid white;
            z-index: 10;
        }

        .conversation-notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 6px;
            height: 6px;
            background: #ff4444;
            border-radius: 50%;
            border: 1px solid white;
            z-index: 10;
        }

        /* Registration Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        .modal-window {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ece9d8;
            border: 2px outset #ece9d8;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.4);
            min-width: 500px;
            min-height: 400px;
            max-width: 90vw;
            max-height: 90vh;
        }

        .modal-title-bar {
            height: 28px;
            background: linear-gradient(to bottom, #0a246a 0%, #0a246a 8%, #3985d6 25%, #4a95e6 65%, #1553a3 100%);
            display: flex;
            align-items: center;
            padding: 0 6px;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .modal-title-bar-icon {
            width: 20px;
            height: 20px;
            background: #4ecdc4;
            margin-right: 6px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .modal-title-bar-text {
            flex: 1;
        }

        .modal-window-controls {
            display: flex;
            gap: 1px;
        }

        .modal-window-control {
            width: 20px;
            height: 16px;
            background: linear-gradient(to bottom, #e6e6e6 0%, #d0d0d0 100%);
            border: 1px outset #e6e6e6;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-window-control:active {
            border: 1px inset #e6e6e6;
        }

        .modal-content {
            padding: 12px;
            height: calc(100% - 28px);
            overflow: hidden;
        }

        .registration-step {
            display: none;
        }

        .registration-step.active {
            display: block;
        }

        .step-indicator {
            text-align: center;
            margin-bottom: 16px;
            font-size: 10px;
            color: #666;
        }

        .modal-form-group {
            margin-bottom: 12px;
        }

        .modal-form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 11px;
        }

        .modal-form-input {
            width: 100%;
            height: 20px;
            border: 1px inset #c0c0c0;
            padding: 2px 4px;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 12px;
        }

        /* Field Error Styles */
        .field-error {
            color: #dc3545 !important;
            border-color: #dc3545 !important;
            background-color: #fff5f5 !important;
        }

        .error-message {
            color: #dc3545;
            font-size: 10px;
            margin-top: 4px;
            margin-bottom: 8px;
            font-weight: bold;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .success-message {
            text-align: center;
            padding: 20px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Logout Modal Styles */
        .logout-modal {
            width: 400px;
            height: 220px;
            min-width: 400px;
            min-height: 220px;
            max-width: 400px;
            max-height: 220px;
        }

        .logout-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            height: 100%;
            text-align: center;
            overflow: hidden;
        }

        .logout-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .logout-question {
            font-size: 16px;
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 24px;
            line-height: 1.4;
        }

        .logout-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
        }

        .logout-cancel {
            padding: 10px 20px;
            font-size: 13px;
            min-width: 80px;
        }

        .logout-confirm {
            padding: 10px 20px;
            font-size: 13px;
            min-width: 80px;
        }

        /* Profile Panel Styles */
        .profile-panel {
            display: none;
        }

        .profile-panel.active {
            display: block;
        }

        .avatar-box {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            border: 3px outset #d0d0d0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 16px;
            cursor: pointer;
        }

        .avatar-box:hover {
            background: linear-gradient(135deg, #5eddd6, #54b09d);
        }

        .profile-username {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 16px;
        }

        .recent-games {
            background: white;
            border: 2px inset #ece9d8;
            padding: 12px;
            margin-top: 16px;
        }

        .recent-games-title {
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .recent-game-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .recent-game-item:last-child {
            border-bottom: none;
        }

        .recent-game-icon {
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            border: 1px outset #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
        }

        .recent-game-name {
            flex: 1;
            color: #333;
        }

        .recent-game-time {
            color: #666;
            font-size: 9px;
        }

        .profile-buttons {
            display: flex;
            gap: 8px;
            margin: 16px 0;
            justify-content: center;
        }

        .profile-button {
            background: linear-gradient(to bottom, #f0f0f0 0%, #d0d0d0 100%);
            border: 2px outset #d0d0d0;
            padding: 8px 12px;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 80px;
            justify-content: center;
            transition: all 0.1s ease;
        }

        .profile-button:hover {
            background: linear-gradient(to bottom, #e0e0e0 0%, #c0c0c0 100%);
        }

        .profile-button:active {
            border: 2px inset #d0d0d0;
            background: linear-gradient(to bottom, #d0d0d0 0%, #b0b0b0 100%);
        }

        .profile-button-icon {
            font-size: 14px;
        }

        /* Profile Panel Top Right Buttons */
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .profile-title {
            color: #1f4e79;
            margin: 0;
        }

        .profile-top-buttons {
            display: flex;
            gap: 4px;
        }

        .profile-top-button {
            width: 28px;
            height: 28px;
            background: linear-gradient(to bottom, #f0f0f0 0%, #d0d0d0 100%);
            border: 2px outset #d0d0d0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.1s ease;
        }

        .profile-top-button:hover {
            background: linear-gradient(to bottom, #e0e0e0 0%, #c0c0c0 100%);
        }

        .profile-top-button:active {
            border: 2px inset #d0d0d0;
            background: linear-gradient(to bottom, #d0d0d0 0%, #b0b0b0 100%);
        }

        /* Character Mini Card Styles */
        .character-mini-card {
            background: white;
            border: 2px outset #ece9d8;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s ease;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .character-mini-card:hover {
            border: 2px outset #316ac5;
            background: #f0f8ff;
        }

        .character-mini-card:active {
            border: 2px inset #ece9d8;
            background: #e8f4fd;
        }

        .character-mini-card.disabled {
            background: #d0d0d0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .character-mini-card.disabled:hover {
            border: 2px outset #ece9d8;
            background: #d0d0d0;
        }

        .character-mini-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .character-mini-name {
            font-size: 9px;
            font-weight: bold;
            color: #1f4e79;
        }

        /* Character Card Styles */
        .character-card {
            background: white;
            border: 2px outset #ece9d8;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .character-card:hover {
            border: 2px outset #316ac5;
            background: #f0f8ff;
        }

        .character-card:active {
            border: 2px inset #ece9d8;
            background: #e8f4fd;
        }

        .character-card.disabled {
            background: #d0d0d0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .character-card.disabled:hover {
            border: 2px outset #ece9d8;
            background: #d0d0d0;
        }

        .character-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .character-name {
            font-size: 12px;
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 4px;
        }

        .character-status {
            font-size: 10px;
            color: #666;
        }

        .character-status.owned {
            color: #228b22;
            font-weight: bold;
        }

        .character-status.selected {
            color: #316ac5;
            font-weight: bold;
        }

        /* Universal Custom Popup System */
        .custom-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .custom-popup {
            background: #ece9d8;
            border: 2px outset #ece9d8;
            box-shadow: 4px 4px 8px rgba(0,0,0,0.4);
            min-width: 300px;
            max-width: 500px;
            text-align: center;
            padding: 20px;
        }

        .custom-popup-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .custom-popup-title {
            font-size: 16px;
            font-weight: bold;
            color: #1f4e79;
            margin-bottom: 12px;
        }

        .custom-popup-message {
            font-size: 12px;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .custom-popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .custom-popup-input {
            width: 100%;
            height: 24px;
            border: 1px inset #c0c0c0;
            padding: 2px 4px;
            font-family: 'Tahoma', sans-serif;
            font-size: 11px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div class="desktop">
        <div class="window" id="gameWindow">
            <div class="title-bar">
                <div class="title-bar-icon">üéÆ</div>
                <div class="title-bar-text">SkyParty (Unactivated)</div>
                <div class="window-controls">
                    <div class="window-control minimize" onclick="minimizeWindow()">_</div>
                    <div class="window-control maximize" onclick="maximizeWindow()">‚ñ°</div>
                    <div class="window-control close" onclick="closeWindow()">√ó</div>
                </div>
            </div>
            
            <div class="menu-bar">
                <div class="menu-item">File</div>
                <div class="menu-item">View</div>
                <div class="menu-item">Games</div>
                <div class="menu-item">Wallet</div>
                <div class="menu-item">Help</div>
            </div>
            
            <div class="content">
                <div class="sidebar">
                    <div class="user-info" id="userInfo">
                        <div class="user-info-avatar" id="userInfoAvatar">üë§</div>
                        <div><strong>Status:</strong> Not Logged In</div>
                    </div>
                    
                    <div class="credits-info" id="creditsInfo">
                        <div class="credits-amount" id="creditsAmountSidebar">0 GC</div>
                        <div class="credits-topup" onclick="openCreditsPopup()">+</div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title" id="sidebarTitle">Account</div>
                        <div class="sidebar-item active" onclick="showSection('login')" id="loginSidebarItem">üë§ Login</div>
                        <div class="sidebar-item" onclick="showSection('profile')" id="profileSidebarItem" style="display: none;">üë§ Profile</div>
                        <div class="sidebar-item" onclick="showSection('dashboard')">üéÆ Game</div>
                        <div class="sidebar-item" onclick="showSection('shop')">üõí Shop</div>
                        <div class="sidebar-item" onclick="showSection('usersearch')">üîç Search Users</div>
                        <div class="sidebar-item" onclick="showSection('wallet')">üí∞ Crypto Wallet</div>
                        <div class="sidebar-item" onclick="openLogoutModal()" id="logoutBtn" style="display: none;">üö™ Logout</div>
                    </div>
                    
                    <div class="sidebar-section">
                        <div class="sidebar-title">Quick Access</div>
                        <div class="sidebar-item" onclick="showSection('activation')">üîë Activation</div>
                        <div class="sidebar-item" onclick="showSection('earnings')">üìä P2E Earnings</div>
                        <div class="sidebar-item">‚öôÔ∏è Settings</div>
                    </div>
                </div>
                
                <div class="main-content">
                    <!-- Activation Section -->
                    <div class="section" id="activation">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">Software Activation</h2>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; margin-bottom: 16px; border-radius: 3px;" id="activationWarning">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 16px;">‚ö†Ô∏è</span>
                                <strong>SkyParty is currently unactivated</strong>
                            </div>
                            <p style="margin: 8px 0 0 24px; font-size: 10px; color: #856404;">
                                Some features may be limited. Enter your activation code to unlock full functionality.
                            </p>
                        </div>

                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Enter Activation Code</h3>
                            <div class="form-group">
                                <label class="form-label">Activation Code:</label>
                                <div class="activation-code-container">
                                    <input type="text" class="activation-code-box" id="activationCode1" maxlength="4" oninput="moveToNext(1, event)" onkeydown="handleKeyDown(1, event)" onpaste="handlePaste(event)">
                                    <span class="activation-separator">-</span>
                                    <input type="text" class="activation-code-box" id="activationCode2" maxlength="4" oninput="moveToNext(2, event)" onkeydown="handleKeyDown(2, event)" onpaste="handlePaste(event)">
                                    <span class="activation-separator">-</span>
                                    <input type="text" class="activation-code-box" id="activationCode3" maxlength="4" oninput="moveToNext(3, event)" onkeydown="handleKeyDown(3, event)" onpaste="handlePaste(event)">
                                    <span class="activation-separator">-</span>
                                    <input type="text" class="activation-code-box" id="activationCode4" maxlength="4" oninput="moveToNext(4, event)" onkeydown="handleKeyDown(4, event)" onpaste="handlePaste(event)">
                                </div>
                            </div>
                            <div class="form-group">
                                <button class="xp-button primary" onclick="activateSoftware()" id="activateBtn">Activate</button>
                            </div>
                            <div class="activation-status" id="activationStatus" style="display: none;">
                                <span class="activation-checkmark">‚úÖ</span>
                                <span style="color: #228b22; font-weight: bold; font-size: 11px;">Activated Successfully</span>
                                <button class="activation-cancel-btn" onclick="cancelActivation()">Cancel</button>
                            </div>
                        </div>

                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">License Information</h3>
                            <div style="font-size: 10px; line-height: 1.4;">
                                <div><strong>Product:</strong> SkyParty Game Launcher</div>
                                <div><strong>Version:</strong> 1.0.0</div>
                                <div><strong>Status:</strong> <span style="color: #dc3545;" id="licenseStatus">Unactivated</span></div>
                                <div><strong>License Type:</strong> <span id="licenseType">Evaluation (Limited Features)</span></div>
                                <div><strong>Days Remaining:</strong> <span id="licenseDays">30 days</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Login Section -->
                    <div class="section active" id="login">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">User Login</h2>
                        <div class="form-group">
                            <label class="form-label">Username:</label>
                            <div class="error-message" id="loginUsernameError">Please fill in this field</div>
                            <input type="text" class="form-input" id="username" placeholder="Enter username">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password:</label>
                            <div class="error-message" id="loginPasswordError">Please fill in this field</div>
                            <input type="password" class="form-input" id="password" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <button class="xp-button primary" onclick="login()">Login</button>
                            <button class="xp-button" onclick="register()">Register</button>
                        </div>
                    </div>

                    <!-- Profile Section -->
                    <div class="section profile-panel" id="profile">
                        <div class="profile-header">
                            <h2 class="profile-title">Profile</h2>
                            <div class="profile-top-buttons">
                                <div class="profile-top-button" onclick="openDM()" title="Direct Messages" style="position: relative;">
                                    üí¨
                                    <div id="dmNotificationDot" class="notification-dot" style="display: none;"></div>
                                </div>
                                <div class="profile-top-button" onclick="showSection('mailbox')" title="Mailbox" style="position: relative;">
                                    üìÆ
                                    <div id="mailboxNotificationDot" class="notification-dot" style="display: none;"></div>
                                </div>
                                <div class="profile-top-button" onclick="openWallet()" title="Wallet">
                                    üí∞
                                </div>
                            </div>
                        </div>
                        
                        <div class="avatar-box" id="bigProfileAvatar" onclick="showSection('characters')" style="cursor: pointer;" title="Click to change character">
                            üë§
                        </div>
                        
                        <div class="profile-buttons">
                            <button class="profile-button" onclick="openMyBase()">
                                <span class="profile-button-icon">üè†</span>
                                My Base
                            </button>
                            <button class="profile-button" onclick="openFriends()">
                                <span class="profile-button-icon">üë•</span>
                                Friends
                            </button>
                            <button class="profile-button" onclick="showSection('inventory')">
                                <span class="profile-button-icon">üéí</span>
                                Inventory
                            </button>
                        </div>
                        
                        <div class="profile-username" id="profileUsername">
                            Username
                        </div>
                        
                        <div class="recent-games">
                            <div class="recent-games-title">Recent Games</div>
                            <div class="recent-game-item">
                                <div class="recent-game-icon">üéÆ</div>
                                <div class="recent-game-name">Main Story Mode</div>
                                <div class="recent-game-time">2h ago</div>
                            </div>
                            <div class="recent-game-item">
                                <div class="recent-game-icon">üéØ</div>
                                <div class="recent-game-name">Play to Earn - Game 1</div>
                                <div class="recent-game-time">1d ago</div>
                            </div>
                            <div class="recent-game-item">
                                <div class="recent-game-icon">üé≤</div>
                                <div class="recent-game-name">Play to Earn - Game 2</div>
                                <div class="recent-game-time">3d ago</div>
                            </div>
                            <div class="recent-game-item">
                                <div class="recent-game-icon">üé™</div>
                                <div class="recent-game-name">Event - Game 1</div>
                                <div class="recent-game-time">1w ago</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Section -->
                    <div class="section" id="dashboard">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">Welcome to Your Game Universe</h2>
                        
                        <div class="wallet-panel">
                            <div class="wallet-status">
                                <div class="status-indicator" id="walletIndicator"></div>
                                <span><strong>Wallet Status:</strong> <span id="walletStatus">Disconnected</span></span>
                            </div>
                            <div class="credits-display">
                                Game Credits: <span id="creditsAmount">0</span> GC
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #32cd32, #228b22); border: 2px outset #32cd32; padding: 12px; margin-bottom: 16px; text-align: center; max-width: 300px;">
                            <button class="xp-button" style="background: linear-gradient(to bottom, #90ee90 0%, #32cd32 100%); color: black; border: 1px outset #90ee90; font-weight: bold;" onclick="launchMainGame()">üéÆ Run Story Mode</button>
                        </div>
                        
                        <h3 style="color: #1f4e79; margin-bottom: 12px;">üèÜ Play to Earn</h3>
                        <div class="game-grid">
                            <div class="game-card" onclick="launchGame('p2e1')" style="background-image: url('https://raw.githubusercontent.com/mitsunesensei/pictures/main/tstone.jpg');">
                                <div class="game-card-content">
                                    <div class="game-title">Game 1</div>
                                    <div class="game-status">Earn up to 50 GC</div>
                                </div>
                            </div>
                        </div>

                        <h3 style="color: #1f4e79; margin-bottom: 12px; margin-top: 24px;">üéâ Events</h3>
                        <div class="game-grid">
                            <div class="game-card disabled" style="background-image: url('https://raw.githubusercontent.com/mitsunesensei/pictures/main/tstone.jpg');">
                                <div class="game-card-content">
                                    <div class="game-title">No Events</div>
                                    <div class="game-status">Check back later</div>
                                </div>
                            </div>
                        </div>

                        <h3 style="color: #1f4e79; margin-bottom: 12px; margin-top: 24px;">üë§ User Games</h3>
                        <div class="game-grid">
                            <div class="game-card disabled" style="background-image: url('https://raw.githubusercontent.com/mitsunesensei/pictures/main/tstone.jpg');">
                                <div class="game-card-content">
                                    <div class="game-title">No User Games</div>
                                    <div class="game-status">Create your own</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Shop Section -->
                    <div class="section" id="shop">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">üõí Shop</h2>
                        <p style="margin-bottom: 16px;">Browse and purchase characters, items, and upgrades:</p>
                        
                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Categories</h3>
                            <div class="game-grid">
                                <div class="game-card" onclick="showSection('characters')">
                                    <div class="game-icon" style="background: linear-gradient(135deg, #4ecdc4, #44a08d);">üë•</div>
                                    <div class="game-title">Characters</div>
                                    <div class="game-status">Browse & Buy</div>
                                </div>
                                <div class="game-card disabled">
                                    <div class="game-icon" style="background: linear-gradient(135deg, #d0d0d0, #a0a0a0);">üîí</div>
                                    <div class="game-title">Coming Soon</div>
                                    <div class="game-status">Locked</div>
                                </div>
                                <div class="game-card disabled">
                                    <div class="game-icon" style="background: linear-gradient(135deg, #d0d0d0, #a0a0a0);">üîí</div>
                                    <div class="game-title">Coming Soon</div>
                                    <div class="game-status">Locked</div>
                                </div>
                                <div class="game-card disabled">
                                    <div class="game-icon" style="background: linear-gradient(135deg, #d0d0d0, #a0a0a0);">üîí</div>
                                    <div class="game-title">Coming Soon</div>
                                    <div class="game-status">Locked</div>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <!-- User Search Section -->
                    <div class="section" id="usersearch">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">üîç Search Users</h2>
                        <p style="margin-bottom: 16px;">Find and connect with other players in the SkyParty community:</p>
                        
                        <!-- Search Bar -->
                        <div class="wallet-panel" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 12px;">Search Players</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="form-input" id="userSearch" placeholder="Enter username to search..." style="flex: 1;" oninput="searchUsers()">
                                <button class="xp-button" onclick="clearUserSearch()">Clear</button>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div class="wallet-panel" id="userSearchResults" style="display: none;">
                            <h3 style="margin-bottom: 12px;">Search Results</h3>
                            <div id="userResultsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                                <!-- User results will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Recent Searches -->
                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Recent Searches</h3>
                            <div style="font-size: 11px; color: #666; text-align: center; padding: 20px;">
                                No recent searches yet. Start searching for users above!
                            </div>
                        </div>
                    </div>
                    
                    <!-- Characters Section -->
                    <div class="section" id="characters">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">üë• Characters</h2>
                        <p style="margin-bottom: 16px;">Choose your character - your character defines your avatar appearance:</p>
                        
                        <!-- Search Bar -->
                        <div class="wallet-panel" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 12px;">Search Characters</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="form-input" id="characterSearch" placeholder="Search for characters..." style="flex: 1;" oninput="searchCharacters()">
                                <button class="xp-button" onclick="clearCharacterSearch()">Clear</button>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div class="wallet-panel" id="searchResultsPanel" style="display: none;">
                            <h3 style="margin-bottom: 12px;">Search Results</h3>
                            <div id="searchResults" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <!-- Search results will be populated here -->
                            </div>
                        </div>
                        
                        <!-- All Characters -->
                        <div class="wallet-panel" id="allCharactersPanel">
                            <h3 style="margin-bottom: 12px;">All Characters</h3>
                            <div id="allCharacters" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                                <!-- Characters will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Wallet Section -->
                    <div class="section" id="wallet">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">Crypto Wallet</h2>
                        
                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Wallet Connection</h3>
                            <div class="wallet-status">
                                <div class="status-indicator" id="walletIndicator2"></div>
                                <span>Status: <span id="walletStatus2">Disconnected</span></span>
                            </div>
                            <button class="xp-button primary" onclick="connectWallet()">Connect Wallet</button>
                            <button class="xp-button">Disconnect</button>
                        </div>
                        
                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Balance</h3>
                            <div style="display: flex; gap: 16px;">
                                <div style="flex: 1;">
                                    <div class="form-label">Game Credits (GC)</div>
                                    <div class="credits-display" id="gcBalance">0 GC</div>
                                </div>
                                <div style="flex: 1;">
                                    <div class="form-label">Crypto Tokens</div>
                                    <div class="credits-display" id="tokenBalance">0.00 ETH</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Earnings Section -->
                    <div class="section" id="earnings">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">Play-to-Earn Dashboard</h2>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Today's Earnings</h3>
                                <div class="credits-display">125 GC</div>
                            </div>
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Total Earned</h3>
                                <div class="credits-display">2,847 GC</div>
                            </div>
                        </div>
                    </div>

                    <!-- Mailbox Section -->
                    <div class="section" id="mailbox">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">üìÆ Mailbox</h2>
                        <p style="margin-bottom: 16px;">Receive gifts, items, and messages from other players:</p>
                        
                        <!-- Mailbox Stats -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Unread Items</h3>
                                <div class="credits-display" id="unreadMailCount">0</div>
                </div>
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Total Received</h3>
                                <div class="credits-display" id="totalMailCount">0</div>
                            </div>
                        </div>

                        <!-- Mailbox Actions -->
                        <div class="wallet-panel" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 12px;">Mailbox Actions</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="xp-button" onclick="acceptAllGifts()">Accept All</button>
                                <button class="xp-button" onclick="rejectAllGifts()">Reject All</button>
                                <button class="xp-button primary" onclick="refreshMailbox()">Refresh</button>
                            </div>
                        </div>

                        <!-- Mail Items List -->
                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Mail Items</h3>
                            <div id="mailboxItems" style="max-height: 400px; overflow-y: auto;">
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <div style="font-size: 48px; margin-bottom: 16px;">üìÆ</div>
                                    <div>No mail items yet</div>
                                    <div style="font-size: 10px; margin-top: 8px;">Gifts and items from other players will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Section -->
                    <div class="section" id="inventory">
                        <h2 style="color: #1f4e79; margin-bottom: 16px;">üéí Inventory</h2>
                        <p style="margin-bottom: 16px;">Manage your items, characters, and collectibles:</p>
                        
                        <!-- Inventory Stats -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Total Items</h3>
                                <div class="credits-display" id="totalItemsCount">0</div>
                            </div>
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Characters</h3>
                                <div class="credits-display" id="charactersCount">0</div>
                            </div>
                            <div class="wallet-panel">
                                <h3 style="margin-bottom: 8px;">Other Items</h3>
                                <div class="credits-display" id="otherItemsCount">0</div>
                            </div>
                        </div>

                        <!-- Search Bar -->
                        <div class="wallet-panel" style="margin-bottom: 16px;">
                            <h3 style="margin-bottom: 12px;">Search Items</h3>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="form-input" id="inventorySearch" placeholder="Search for items..." style="flex: 1;" oninput="searchInventory()">
                                <button class="xp-button" onclick="clearInventorySearch()">Clear</button>
                            </div>
                        </div>

                        <!-- Inventory Items Grid -->
                        <div class="wallet-panel">
                            <h3 style="margin-bottom: 12px;">Your Items</h3>
                            <div id="inventoryItems" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto;">
                                <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                                    <div style="font-size: 48px; margin-bottom: 16px;">üéí</div>
                                    <div>No items in inventory yet</div>
                                    <div style="font-size: 10px; margin-top: 8px;">Items from shop purchases, gifts, and game rewards will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Credits Purchase Modal -->
    <div class="modal-overlay" id="creditsModal">
        <div class="modal-window">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon">üí∞</div>
                <div class="modal-title-bar-text">Purchase Game Credits</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeCreditsModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <h3 style="color: #1f4e79; margin-bottom: 16px;">Choose Credit Package</h3>
                <p style="margin-bottom: 16px; font-size: 11px; color: #666;">Select how many Game Credits you'd like to purchase:</p>
                
                <div class="credits-grid">
                    <div class="credits-option" onclick="purchaseCreditsPackage(500).catch(console.error)">
                        <div class="credits-icon">üí∏</div>
                        <div class="credits-package-title">500 GC</div>
                        <div class="credits-package-price">$4.99</div>
                    </div>
                    <div class="credits-option" onclick="purchaseCreditsPackage(1000).catch(console.error)">
                        <div class="credits-icon">üí∏</div>
                        <div class="credits-package-title">1000 GC</div>
                        <div class="credits-package-price">$8.99</div>
                    </div>
                    <div class="credits-option" onclick="purchaseCreditsPackage(2000).catch(console.error)">
                        <div class="credits-icon">üí∏</div>
                        <div class="credits-package-title">2000 GC</div>
                        <div class="credits-package-price">$15.99</div>
                    </div>
                    <div class="credits-option" onclick="purchaseCreditsPackage(5000).catch(console.error)">
                        <div class="credits-icon">üí∏</div>
                        <div class="credits-package-title">5000 GC</div>
                        <div class="credits-package-price">$29.99</div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button class="xp-button" onclick="closeCreditsModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Modal -->
    <div class="modal-overlay" id="registrationModal">
        <div class="modal-window">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon">üë§</div>
                <div class="modal-title-bar-text">Create New Account</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeRegistrationModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <!-- Step 1: Registration Form -->
                <div class="registration-step active" id="registrationForm">
                    <div class="step-indicator">Step 1 of 2: Account Information</div>
                    <h3 style="color: #1f4e79; margin-bottom: 16px;">Create Your Account</h3>
                    
                    <div class="modal-form-group">
                        <label class="modal-form-label">Username:</label>
                        <div class="error-message" id="usernameError">Please fill in this field</div>
                        <input type="text" class="modal-form-input" id="regUsername" placeholder="Choose a username">
                    </div>
                    
                    <div class="modal-form-group">
                        <label class="modal-form-label">Date of Birth:</label>
                        <div class="error-message" id="dateError">Please fill in this field</div>
                        <input type="date" class="modal-form-input" id="regDateOfBirth">
                    </div>
                    
                    <div class="modal-form-group">
                        <label class="modal-form-label">Email:</label>
                        <div class="error-message" id="emailError">Please fill in this field</div>
                        <input type="email" class="modal-form-input" id="regEmail" placeholder="Enter your email address">
                    </div>
                    
                    <div class="modal-form-group">
                        <label class="modal-form-label">Password:</label>
                        <div class="error-message" id="passwordError">Please fill in this field</div>
                        <input type="password" class="modal-form-input" id="regPassword" placeholder="Create a password (6+ characters)">
                    </div>
                    
                    <div class="modal-buttons">
                        <button class="xp-button" onclick="closeRegistrationModal()">Cancel</button>
                        <button class="xp-button primary" onclick="nextRegistrationStep()">Next</button>
                    </div>
                </div>
                
                <!-- Step 2: Success Message -->
                <div class="registration-step" id="registrationSuccess">
                    <div class="step-indicator">Step 2 of 2: Complete</div>
                    <div class="success-message">
                        <div class="success-icon">üéâ</div>
                        <h3 style="color: #1f4e79; margin-bottom: 16px;">You're All Set Up!</h3>
                        <p style="margin-bottom: 16px;">Your account has been created successfully.</p>
                        <p style="margin-bottom: 24px; font-weight: bold; color: #1f4e79;">You can login now!</p>
                        
                        <div class="modal-buttons">
                            <button class="xp-button primary" onclick="closeRegistrationModal()">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Details Modal -->
    <div class="modal-overlay" id="characterDetailsModal">
        <div class="modal-window">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon" id="characterModalIcon">üê±</div>
                <div class="modal-title-bar-text" id="characterModalTitle">Character Details</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeCharacterDetailsModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
                    <div id="characterDetailIcon" style="font-size: 48px;"></div>
                    <div>
                        <h3 id="characterDetailName" style="margin: 0; color: #1f4e79;"></h3>
                        <div id="characterDetailStatus" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
                        <div id="characterDetailQuantity" style="font-size: 11px; color: #316ac5; margin-top: 4px; font-weight: bold;"></div>
                    </div>
                </div>
                
                <div class="wallet-panel">
                    <h4 style="color: #1f4e79; margin-bottom: 8px;">Description</h4>
                    <div id="characterDetailDescription" style="font-size: 11px; line-height: 1.4; margin-bottom: 16px;"></div>
                    
                    <div class="modal-buttons">
                        <button class="xp-button" onclick="closeCharacterDetailsModal()">Cancel</button>
                        <button class="xp-button" id="characterSelectBtn">Select</button>
                        <button class="xp-button primary" id="characterGiftBtn">Gift</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Sending Modal -->
    <div class="modal-overlay" id="giftSendingModal">
        <div class="modal-window" style="max-width: 500px;">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon">üéÅ</div>
                <div class="modal-title-bar-text">Send Gift</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeGiftSendingModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <h3 style="color: #1f4e79; margin-bottom: 16px;">Send this to:</h3>
                
                <!-- Gift Item Display -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="giftItemIcon" style="font-size: 32px;">üéÅ</div>
                        <div>
                            <div id="giftItemName" style="font-weight: bold; color: #1f4e79; font-size: 14px;">Character Name</div>
                            <div style="font-size: 10px; color: #666;">Ready to send</div>
                        </div>
                    </div>
                </div>
                
                <!-- Recipient Search -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <h4 style="color: #1f4e79; margin-bottom: 12px;">Search Recipient</h4>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" class="form-input" id="giftRecipientSearch" placeholder="Search for username..." style="flex: 1;" oninput="searchGiftRecipients()">
                        <button class="xp-button" onclick="clearGiftRecipientSearch()">Clear</button>
                    </div>
                    
                    <!-- Search Results -->
                    <div id="giftRecipientResults" style="margin-top: 12px; display: none;">
                        <div id="giftRecipientList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                            <!-- Recipient results will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Selected Recipient -->
                <div id="giftSelectedRecipient" class="wallet-panel" style="margin-bottom: 16px; display: none;">
                    <h4 style="color: #1f4e79; margin-bottom: 8px;">Selected Recipient</h4>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="giftSelectedRecipientAvatar" style="font-size: 24px;">üë§</span>
                        <div>
                            <div id="giftSelectedRecipientName" style="font-weight: bold; color: #1f4e79;">Username</div>
                            <div style="font-size: 10px; color: #666;">Ready to receive gift</div>
                        </div>
                    </div>
                </div>
                
                <!-- Gift Message -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <h4 style="color: #1f4e79; margin-bottom: 8px;">Gift Message (Optional)</h4>
                    <textarea class="form-input" id="giftMessage" placeholder="Add a personal message..." rows="3" style="resize: vertical;"></textarea>
                </div>
                
                <!-- Action Buttons -->
                <div class="modal-buttons">
                    <button class="xp-button" onclick="closeGiftSendingModal()">Cancel</button>
                    <button class="xp-button primary" id="sendGiftBtn" onclick="sendGiftToRecipient()" style="display: none;">Send Gift</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Acceptance Modal -->
    <div class="modal-overlay" id="giftAcceptanceModal">
        <div class="modal-window" style="max-width: 500px;">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon">üéÅ</div>
                <div class="modal-title-bar-text">Gift Received</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeGiftAcceptanceModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <h3 style="color: #1f4e79; margin-bottom: 16px;">You received a gift!</h3>
                
                <!-- Gift Details -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div id="giftAcceptanceIcon" style="font-size: 48px;">üéÅ</div>
                        <div>
                            <div id="giftAcceptanceFrom" style="font-weight: bold; color: #1f4e79; font-size: 14px; margin-bottom: 4px;">From: Username</div>
                            <div id="giftAcceptanceItem" style="font-size: 12px; color: #666; margin-bottom: 4px;">Character Name</div>
                            <div id="giftAcceptanceMessage" style="font-size: 11px; color: #888; font-style: italic;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Gift Description -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <h4 style="color: #1f4e79; margin-bottom: 8px;">Gift Details</h4>
                    <div id="giftAcceptanceDescription" style="font-size: 11px; line-height: 1.4; margin-bottom: 8px;"></div>
                    <div style="font-size: 10px; color: #666;">
                        <div>‚Ä¢ Accept: Add to your inventory</div>
                        <div>‚Ä¢ Reject: Return to sender</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="modal-buttons">
                    <button class="xp-button" onclick="closeGiftAcceptanceModal()">Cancel</button>
                    <button class="xp-button" onclick="rejectGiftFromModal()" style="background: #ff4444; color: white;">Reject</button>
                    <button class="xp-button primary" onclick="acceptGiftFromModal()">Accept</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal-overlay" id="userProfileModal">
        <div class="modal-window" style="max-width: 500px;">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon" id="userProfileIcon">üë§</div>
                <div class="modal-title-bar-text" id="userProfileTitle">User Profile</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeUserProfileModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <!-- Profile Header -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <div id="userProfileAvatar" style="font-size: 64px; margin-bottom: 12px;">üë§</div>
                    <h3 id="userProfileName" style="margin: 0; color: #1f4e79; margin-bottom: 8px;">Username</h3>
                    <div id="userProfileStatus" style="font-size: 11px; color: #666;">Online</div>
                </div>
                
                <!-- Add Friend Button -->
                <div style="margin-bottom: 16px;">
                    <button class="xp-button" onclick="addFriend()" style="font-size: 12px; padding: 8px 16px; width: 100%;">
                        ‚ûï Add Friend
                    </button>
                </div>
                
                <!-- Profile Stats -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <h4 style="color: #1f4e79; margin-bottom: 12px;">Profile Stats</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 11px;">
                        <div>
                            <div style="font-weight: bold; color: #1f4e79;">Level</div>
                            <div id="userProfileLevel">15</div>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #1f4e79;">Games Played</div>
                            <div id="userProfileGames">127</div>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #1f4e79;">Total Credits</div>
                            <div id="userProfileCredits">2,847 GC</div>
                        </div>
                        <div>
                            <div style="font-weight: bold; color: #1f4e79;">Join Date</div>
                            <div id="userProfileJoinDate">Dec 2024</div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px;">
                    <button class="xp-button" onclick="visitUserBase()" style="font-size: 10px;">
                        üè† Visit Base
                    </button>
                    <button class="xp-button" onclick="sendDirectMessage()" style="font-size: 10px;">
                        üí¨ Send DM
                    </button>
                    <button class="xp-button" onclick="sendGift()" style="font-size: 10px;">
                        üéÅ Send Gift
                    </button>
                    <button class="xp-button" onclick="reportUser()" style="font-size: 10px; background: linear-gradient(to bottom, #ff6b6b, #ee5a52);">
                        üö© Report
                    </button>
                </div>
                
                <!-- Recent Activity -->
                <div class="wallet-panel">
                    <h4 style="color: #1f4e79; margin-bottom: 8px;">Recent Activity</h4>
                    <div style="font-size: 10px; color: #666;">
                        <div style="margin-bottom: 4px;">‚Ä¢ Played "Main Story Mode" - 2 hours ago</div>
                        <div style="margin-bottom: 4px;">‚Ä¢ Earned 45 GC from P2E Game 1</div>
                        <div style="margin-bottom: 4px;">‚Ä¢ Purchased Fox character</div>
                        <div>‚Ä¢ Joined SkyParty community</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Direct Messages Modal - Instagram Style -->
    <div class="modal-overlay" id="dmModal">
        <div class="modal-window" style="max-width: 900px; width: 95%; height: 600px;">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon">üí¨</div>
                <div class="modal-title-bar-text">Direct Messages</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeDMModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content" style="height: calc(100% - 24px); padding: 0; display: flex;">
                <!-- Left Sidebar - Conversations List -->
                <div id="dmSidebar" style="width: 300px; border-right: 1px solid #d0d0d0; background: #f8f8f8; display: flex; flex-direction: column;">
                    <!-- Header with New Message Button -->
                    <div style="padding: 12px; border-bottom: 1px solid #d0d0d0; background: white;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <h3 style="color: #1f4e79; margin: 0; flex: 1;">Messages</h3>
                            <button class="xp-button" onclick="showNewMessageComposer()" style="padding: 4px 8px; font-size: 10px;">‚úèÔ∏è New</button>
                        </div>
                        
                        <!-- Search Bar -->
                        <input type="text" class="form-input" id="dmConversationSearch" placeholder="Search conversations..." style="width: 100%; font-size: 10px;" oninput="searchConversations()">
                    </div>
                    
                    <!-- Conversations List -->
                    <div id="dmConversationsList" style="flex: 1; overflow-y: auto;">
                        <!-- Conversations will be populated here -->
                    </div>
                </div>
                
                <!-- Right Side - Chat Interface -->
                <div id="dmChatArea" style="flex: 1; display: flex; flex-direction: column;">
                    <!-- Welcome Screen -->
                    <div id="dmWelcomeScreen" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f8f8;">
                        <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.5;">üí¨</div>
                        <h3 style="color: #1f4e79; margin-bottom: 8px;">Your Messages</h3>
                        <p style="color: #666; font-size: 11px; text-align: center; max-width: 300px;">
                            Send and receive messages with other SkyParty users.<br>
                            Click "New" to start a conversation.
                        </p>
                    </div>
                    
                    <!-- Chat Interface (Hidden by default) -->
                    <div id="dmChatInterface" style="flex: 1; display: none; flex-direction: column; height: 100%; min-height: 0;">
                        <!-- Chat Header -->
                        <div id="dmChatHeader" style="padding: 12px; border-bottom: 1px solid #d0d0d0; background: white; display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            <span id="dmChatAvatar" style="font-size: 24px;">üë§</span>
                            <div style="flex: 1;">
                                <div id="dmChatName" style="font-weight: bold; color: #1f4e79; font-size: 12px;"></div>
                                <div id="dmChatStatus" style="font-size: 9px; color: #666;">Online</div>
                            </div>
                            <button class="xp-button" onclick="showWelcomeScreen()" style="padding: 2px 6px; font-size: 10px;">‚Üê Back</button>
                        </div>
                        
                        <!-- Messages Area -->
                        <div id="dmMessagesArea" style="flex: 1; padding: 12px; overflow-y: auto; background: #f8f8f8; min-height: 0; max-height: calc(100% - 120px);">
                            <!-- Messages will be populated here -->
                        </div>
                        
                        <!-- Message Input Area -->
                        <div id="dmMessageInput" style="padding: 12px; border-top: 1px solid #d0d0d0; background: white; flex-shrink: 0;">
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="text" class="form-input" id="dmMessageText" placeholder="Type a message..." style="flex: 1; font-size: 11px;" onkeypress="handleMessageKeyPress(event)">
                                <button class="xp-button primary" onclick="sendChatMessage().catch(console.error)" style="padding: 4px 12px; font-size: 10px;">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Message Composer Modal -->
    <div class="modal-overlay" id="newMessageModal">
        <div class="modal-window" style="max-width: 500px;">
            <div class="modal-title-bar">
                <div class="modal-title-bar-icon">‚úèÔ∏è</div>
                <div class="modal-title-bar-text">New Message</div>
                <div class="modal-window-controls">
                    <div class="modal-window-control" onclick="closeNewMessageModal()">√ó</div>
                </div>
            </div>
            
            <div class="modal-content">
                <h3 style="color: #1f4e79; margin-bottom: 12px;">Start a Conversation</h3>
                
                <!-- Recipient Selection -->
                <div class="wallet-panel" style="margin-bottom: 16px;">
                    <h4 style="color: #1f4e79; margin-bottom: 8px;">To:</h4>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" class="form-input" id="dmRecipientSearch" placeholder="Search users..." style="flex: 1;" oninput="searchDMRecipients()">
                        <button class="xp-button" onclick="clearDMRecipientSearch()">Clear</button>
                    </div>
                    
                    <!-- Recipient Search Results -->
                    <div id="dmRecipientResults" style="display: none; margin-top: 8px;">
                        <div id="dmRecipientList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px;">
                            <!-- Recipient results will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Selected Recipient -->
                    <div id="dmSelectedRecipient" style="display: none; margin-top: 8px; padding: 8px; background: #f0f8ff; border: 1px solid #316ac5; border-radius: 3px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="dmSelectedRecipientAvatar" style="font-size: 16px;">üë§</span>
                            <span id="dmSelectedRecipientName" style="font-weight: bold; color: #1f4e79;"></span>
                            <button class="xp-button" onclick="clearSelectedRecipient()" style="margin-left: auto; padding: 2px 6px; font-size: 10px;">√ó</button>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="modal-buttons" style="margin-top: 12px;">
                    <button class="xp-button" onclick="closeNewMessageModal()">Cancel</button>
                    <button class="xp-button primary" onclick="startNewConversation().catch(console.error)" id="startConversationBtn" style="display: none;">Start Conversation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal-overlay" id="logoutModal">
        <div class="modal-window logout-modal">
            <div class="modal-content logout-content">
                <div class="logout-icon">üö™</div>
                <div class="logout-question">Are you sure you want to logout?</div>
                <div class="logout-buttons">
                    <button class="xp-button logout-cancel" onclick="closeLogoutModal()">Cancel</button>
                    <button class="xp-button primary logout-confirm" onclick="confirmLogout()">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Universal Custom Popup System -->
    <div class="custom-popup-overlay" id="customPopupOverlay">
        <div class="custom-popup">
            <div class="custom-popup-icon" id="customPopupIcon">‚ÑπÔ∏è</div>
            <div class="custom-popup-title" id="customPopupTitle">Information</div>
            <div class="custom-popup-message" id="customPopupMessage">Message</div>
            <input type="text" class="custom-popup-input" id="customPopupInput" style="display: none;" placeholder="Enter text...">
            <div class="custom-popup-buttons" id="customPopupButtons">
                <button class="xp-button" onclick="closeCustomPopup()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        // Firebase removed - using Railway API for all authentication and data
        console.log('üöÄ Using Railway API for authentication and data storage');

        let isLoggedIn = false;
        let walletConnected = false;
        let gameCredits = 0;
        let currentUser = '';
        let isActivated = false;

        // Character System Variables
        let currentCharacter = 'kitty';
        let ownedCharacters = ['kitty'];

        // Character Database - All Available Characters
        let characterDatabase = [
            { id: 'kitty', name: 'Kitty', icon: 'üê±', price: 0, description: 'A cute and friendly kitty character. Perfect for beginners!', owned: true },
            { id: 'dragon', name: 'Dragon', icon: 'üêâ', price: 500, description: 'A powerful dragon with mystical abilities.', owned: false },
            { id: 'robot', name: 'Robot', icon: 'ü§ñ', price: 300, description: 'An advanced AI robot companion.', owned: false },
            { id: 'ninja', name: 'Ninja', icon: 'ü•∑', price: 400, description: 'A stealthy ninja warrior.', owned: false },
            { id: 'wizard', name: 'Wizard', icon: 'üßô', price: 600, description: 'A wise wizard with magical powers.', owned: false },
            { id: 'pirate', name: 'Pirate', icon: 'üè¥‚Äç‚ò†Ô∏è', price: 350, description: 'A swashbuckling pirate adventurer.', owned: false },
            { id: 'bear', name: 'Bear', icon: 'üêª', price: 250, description: 'A strong and cuddly bear companion.', owned: false },
            { id: 'unicorn', name: 'Unicorn', icon: 'ü¶Ñ', price: 800, description: 'A magical unicorn with healing powers.', owned: false },
            { id: 'rabbit', name: 'Rabbit', icon: 'üê∞', price: 200, description: 'A quick and agile rabbit friend.', owned: false },
            { id: 'fox', name: 'Fox', icon: 'ü¶ä', price: 300, description: 'A clever and cunning fox.', owned: false },
            { id: 'owl', name: 'Owl', icon: 'ü¶â', price: 400, description: 'A wise owl with night vision.', owned: false },
            { id: 'wolf', name: 'Wolf', icon: 'üê∫', price: 450, description: 'A loyal wolf pack leader.', owned: false }
        ];

        // Character System Functions
        function updateCharacterDatabase() {
            // Update owned status for all characters
            characterDatabase.forEach(character => {
                character.owned = ownedCharacters.includes(character.id);
            });
        }

        function loadCharacterData() {
            if (!currentUser) return;
            
            // Load character data from local storage
            const characterData = localStorage.getItem(`characterData_${currentUser}`);
            if (characterData) {
                try {
                    const data = JSON.parse(characterData);
                    currentCharacter = data.currentCharacter || 'kitty';
                    ownedCharacters = data.ownedCharacters || ['kitty'];
                    gameCredits = data.gameCredits || 150;
                    
                    console.log('‚úÖ Loaded character data:', { currentCharacter, ownedCharacters, gameCredits });
                } catch (error) {
                    console.error('Error loading character data:', error);
                    // Reset to defaults on error
                    currentCharacter = 'kitty';
                    ownedCharacters = ['kitty'];
                    gameCredits = 150;
                }
            } else {
                // Set defaults for new users
                currentCharacter = 'kitty';
                ownedCharacters = ['kitty'];
                gameCredits = 150;
            }
            
            // Update character database with ownership status
            updateCharacterDatabase();
        }

        async function saveCharacterData() {
            if (!currentUser) return;
            
            const characterData = {
                currentCharacter: currentCharacter,
                ownedCharacters: ownedCharacters,
                gameCredits: gameCredits,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to local storage
            localStorage.setItem(`characterData_${currentUser}`, JSON.stringify(characterData));
            
            // Save to Railway database if logged in
            if (currentUserId) {
                await updateUserData(characterData);
            }
            
            console.log('‚úÖ Saved character data:', characterData);
        }

        function updateAvatar() {
            const character = characterDatabase.find(char => char.id === currentCharacter);
            const avatarEmoji = character ? character.icon : 'üê±';
            
            // Update ALL avatar displays consistently
            updateAllAvatarDisplays(avatarEmoji);
            
            // Store in localStorage for quick access
            localStorage.setItem('userAvatar', avatarEmoji);
            
            console.log('üîÑ Updated avatar to:', avatarEmoji, 'for character:', currentCharacter);
        }

        function updateAllAvatarDisplays(avatarEmoji) {
            // 1. Status avatar (user info box)
            const userInfoAvatar = document.getElementById('userInfoAvatar');
            if (userInfoAvatar) {
                userInfoAvatar.textContent = avatarEmoji;
            }
            
            // 2. Profile avatar (main profile section)
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar) {
                profileAvatar.textContent = avatarEmoji;
            }
            
            // 3. Profile sidebar avatar
            const profileSidebarAvatar = document.getElementById('profileSidebarAvatar');
            if (profileSidebarAvatar) {
                profileSidebarAvatar.textContent = avatarEmoji;
            }
            
            // 4. Big profile avatar (the large avatar in profile section)
            const bigProfileAvatar = document.getElementById('bigProfileAvatar');
            if (bigProfileAvatar) {
                bigProfileAvatar.textContent = avatarEmoji;
            }
            
            // 5. Profile section avatar (alternative ID)
            const profileSectionAvatar = document.getElementById('profileSectionAvatar');
            if (profileSectionAvatar) {
                profileSectionAvatar.textContent = avatarEmoji;
            }
            
            // 6. Any other avatar displays that might exist
            const allAvatarElements = document.querySelectorAll('[data-avatar="current-user"]');
            allAvatarElements.forEach(element => {
                element.textContent = avatarEmoji;
            });
            
            // 7. Update any profile-related avatar elements by class
            const profileAvatarElements = document.querySelectorAll('.profile-avatar, .user-avatar, .main-avatar, .avatar-box');
            profileAvatarElements.forEach(element => {
                element.textContent = avatarEmoji;
            });
            
            console.log('‚úÖ Updated all avatar displays to:', avatarEmoji);
        }

        // Unified function to get current user's avatar (synchronous)
        function getCurrentUserAvatar() {
            const character = characterDatabase.find(char => char.id === currentCharacter);
            return character ? character.icon : 'üê±';
        }

        // Unified function to get any user's avatar (async, for other users)
        async function getUserAvatar(username) {
            // If this is the current user, use synchronous method
            if (username === await getCurrentUsername()) {
                return getCurrentUserAvatar();
            }
            
            // For other users, use the existing async method
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(username)}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.users && result.users.length > 0) {
                        const user = result.users.find(u => u.username === username);
                        console.log('üîç getUserAvatar - User data from Railway:', user);
                        if (user && user.currentCharacter) {
                            console.log('üîç getUserAvatar - Current character ID:', user.currentCharacter);
                            // Find character in database to get the correct emoji
                            const character = characterDatabase.find(char => char.id === user.currentCharacter);
                            console.log('üîç getUserAvatar - Found character:', character);
                            if (character) {
                                console.log('‚úÖ Got avatar from Railway API:', character.icon);
                                return character.icon;
                            } else {
                                console.log('‚ùå Character not found in database for ID:', user.currentCharacter);
                            }
                        } else {
                            console.log('‚ùå No currentCharacter found for user:', username);
                        }
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not get avatar from Railway API:', error);
            }
            
            // Fallback: Try local mappings
            try {
                const mappings = await getUsernameMappings();
                const userEmail = mappings[username];
                console.log('üîç getUserAvatar - Local mappings for', username, ':', userEmail);
                
                if (userEmail) {
                    // Get user's character data from local storage
                    const userStorageKey = `characterData_${userEmail}`;
                    const savedData = localStorage.getItem(userStorageKey);
                    console.log('üîç getUserAvatar - Local storage data:', savedData);
            
                    if (savedData) {
                        try {
                            const characterData = JSON.parse(savedData);
                            const userCharacter = characterData.currentCharacter || 'kitty';
                            console.log('üîç getUserAvatar - User character from local storage:', userCharacter);
                    
                            // Find character in database to get the correct emoji
                            const character = characterDatabase.find(char => char.id === userCharacter);
                            console.log('üîç getUserAvatar - Found character in local fallback:', character);
                            if (character) {
                                console.log('‚ö†Ô∏è Got avatar from local storage (fallback):', character.icon);
                                return character.icon;
                            }
                        } catch (error) {
                            console.log('Error parsing character data for user:', username, error);
                        }
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not get avatar from local mappings:', error);
            }
            
            // Default avatar
            console.log('‚ùå Using default avatar for:', username);
            return 'üê±'; // Default to kitty emoji for new users
        }

        // Username-Email mapping functions
        async function storeUsernameMapping(username, email) {
            const mappings = await getUsernameMappings();
            mappings[username] = email;
            await saveData('usernameMappings', mappings);
            console.log('Stored username mapping:', username, '->', email);
        }

        // Activation status functions
        async function saveActivationStatus(email, activationCode) {
            const activations = await getActivationStatuses();
            activations[email] = {
                activated: true,
                activationCode: activationCode,
                activatedDate: new Date().toISOString()
            };
            await saveData('activationStatuses', activations);
            console.log('Saved activation for:', email, 'with code:', activationCode);
        }

        async function getActivationStatuses() {
            const stored = await loadData('activationStatuses');
            return stored || {};
        }

        async function getActivationStatus(email) {
            const activations = await getActivationStatuses();
            return activations[email] || { activated: false };
        }

        async function clearActivationStatus(email) {
            const activations = await getActivationStatuses();
            delete activations[email];
            await saveData('activationStatuses', activations);
            console.log('Cleared activation for:', email);
        }

        // Debug function to see all activation statuses
        async function debugActivationStatuses() {
            const activations = await getActivationStatuses();
            console.log('All activation statuses:', activations);
            return activations;
        }

        // Function to manually restore activation status (for debugging)
        async function restoreActivationStatus() {
            if (currentUser) {
                const activationStatus = await getActivationStatus(currentUser);
                console.log('Manually checking activation for:', currentUser);
                console.log('Activation status:', activationStatus);
                
                if (activationStatus.activated) {
                    isActivated = true;
                    restoreActivationUI();
                    console.log('Activation status restored successfully');
                } else {
                    isActivated = false;
                    console.log('User is not activated');
                }
            } else {
                console.log('No current user to check activation for');
            }
        }

        // Function to reset activation for current user (for debugging)
        async function resetCurrentUserActivation() {
            if (currentUser) {
                await clearActivationStatus(currentUser);
                isActivated = false;
                console.log('Reset activation for current user:', currentUser);
                
                // Reset UI to unactivated state
                document.querySelector('.title-bar-text').textContent = 'SkyParty (Unactivated)';
                
                // Re-enable activation code boxes
                for (let i = 1; i <= 4; i++) {
                    const box = document.getElementById(`activationCode${i}`);
                    box.classList.remove('activated');
                    box.disabled = false;
                    box.value = '';
                }
                
                // Show activate button and hide activation status
                document.getElementById('activateBtn').style.display = 'block';
                document.getElementById('activationStatus').style.display = 'none';
                
                // Show activation warning
                document.getElementById('activationWarning').style.display = 'block';
                
                // Update license information
                document.getElementById('licenseStatus').textContent = 'Unactivated';
                document.getElementById('licenseStatus').style.color = '#dc3545';
                document.getElementById('licenseType').textContent = 'Evaluation (Limited Features)';
                document.getElementById('licenseDays').textContent = '30 days';
                
                alert('Activation status reset for current user. You can now activate with a new code.');
            }
        }

        function restoreActivationUI() {
            // Update title bar - remove "(Unactivated)" text
            document.querySelector('.title-bar-text').textContent = 'SkyParty';
            
            // Disable activation code boxes and make them gray
            for (let i = 1; i <= 4; i++) {
                const box = document.getElementById(`activationCode${i}`);
                box.classList.add('activated');
                box.disabled = true;
            }
            
            // Hide activate button and show activation status
            document.getElementById('activateBtn').style.display = 'none';
            document.getElementById('activationStatus').style.display = 'flex';
            
            // Hide activation warning
            document.getElementById('activationWarning').style.display = 'none';
            
            // Update license information
            document.getElementById('licenseStatus').textContent = 'Activated';
            document.getElementById('licenseStatus').style.color = '#228b22';
            document.getElementById('licenseType').textContent = 'Full License (All Features)';
            document.getElementById('licenseDays').textContent = 'Unlimited';
        }

        // Railway API Configuration
        const RAILWAY_API_URL = 'https://skyparty-desktop-production.up.railway.app'; // Railway API Server
        let currentUserId = null; // Store current user ID from Railway
        
        // Login persistence functions
        async function saveLoginState(userData) {
            try {
                await saveData('loginState', {
                    isLoggedIn: true,
                    userId: userData.id,
                    username: userData.username,
                    email: userData.email,
                    loginTime: new Date().toISOString()
                });
                console.log('‚úÖ Login state saved successfully');
            } catch (error) {
                console.error('‚ùå Failed to save login state:', error);
            }
        }
        
        async function restoreLoginState() {
            try {
                const loginState = await loadData('loginState');
                console.log('Checking login state:', loginState);
                
                if (loginState && loginState.isLoggedIn && loginState.username && loginState.email) {
                    console.log('Found valid saved login state, restoring...');
                    
                    // Set global variables
                    currentUser = loginState.email;
                    currentUserId = loginState.userId;
                    isLoggedIn = true;
                    
                    // Update UI to logged-in state (now async)
                    await updateUIForLoggedInUser(loginState.username);
                    
                    console.log('‚úÖ Login state restored successfully for:', loginState.username);
                } else {
                    console.log('No valid saved login state found, staying logged out');
                    // Clear any corrupted login state
                    if (loginState) {
                        console.log('Clearing corrupted login state');
                        await clearLoginState();
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to restore login state:', error);
                // Clear corrupted login state on error
                try {
                    await clearLoginState();
                } catch (clearError) {
                    console.error('‚ùå Failed to clear corrupted login state:', clearError);
                }
            }
        }
        
        async function clearLoginState() {
            try {
                await saveData('loginState', null);
                console.log('‚úÖ Login state cleared');
            } catch (error) {
                console.error('‚ùå Failed to clear login state:', error);
            }
        }

        // ===== RAILWAY MESSAGE API FUNCTIONS =====
        
        // Send message via Railway API
        async function sendMessageViaRailway(senderId, recipientId, content, conversationId) {
            try {
                console.log('üì§ Sending message via Railway:', { senderId, recipientId, content, conversationId });
                
                const response = await fetch(`${RAILWAY_API_URL}/api/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        senderId,
                        recipientId,
                        content,
                        conversationId
                    })
                });
                
                if (response.ok) {
                const result = await response.json();
                    console.log('‚úÖ Message sent via Railway:', result);
                    return result.message;
                } else {
                    console.error('‚ùå Railway message send failed:', response.status, response.statusText);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Railway message send error:', error);
                return null;
            }
        }
        
        // Get conversations via Railway API
        async function getConversationsViaRailway(userId) {
            try {
                console.log('üì• Getting conversations via Railway for user:', userId);
                
                const response = await fetch(`${RAILWAY_API_URL}/api/messages/conversations/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Conversations received via Railway:', result);
                    return result.conversations || [];
                } else {
                    console.error('‚ùå Railway conversations fetch failed:', response.status, response.statusText);
                    return [];
                }
            } catch (error) {
                console.error('‚ùå Railway conversations fetch error:', error);
                return [];
            }
        }

        // Get user ID from username via Railway API
        async function getUserIdFromUsername(username) {
            try {
                console.log('üîç Getting user ID for username:', username);
                
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(username)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                const result = await response.json();
                    console.log('‚úÖ User search result:', result);
                    
                    if (result.users && result.users.length > 0) {
                        const user = result.users.find(u => u.username === username);
                        if (user) {
                            console.log('‚úÖ Found user ID:', user.id);
                            return user.id;
                        }
                    }
                } else {
                    console.error('‚ùå User search failed:', response.status, response.statusText);
                }
                
                return null;
            } catch (error) {
                console.error('‚ùå User search error:', error);
                return null;
            }
        }

        // ===== RAILWAY API FUNCTIONS =====
        
        // Test Railway connection
        async function testRailwayConnection() {
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/health`);
                const result = await response.json();
                console.log('üöÄ Railway connection test:', result);
                return result.status === 'ok';
            } catch (error) {
                console.error('‚ùå Railway connection failed:', error);
                return false;
            }
        }

        // Test function to check Railway database users
        async function testRailwayUsers() {
            try {
                console.log('üîç Testing Railway users database...');
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìä Railway users database test:', result);
                    
                    if (result.success && result.users && Array.isArray(result.users)) {
                        console.log(`üë• Total users in Railway database: ${result.users.length}`);
                        if (result.users.length > 0) {
                            console.log('üë§ Railway users:', result.users.map(u => u.username));
                        } else {
                            console.log('‚ö†Ô∏è Railway database is empty - no users found');
                        }
                    }
                } else {
                    console.log('‚ùå Railway users test failed:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('‚ùå Railway users test error:', error);
            }
        }

        // Register user with Railway
        async function registerUser(username, email, password) {
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, email, password })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUserId = result.userId;
                    console.log('‚úÖ User registered with Railway:', username);
                    return true;
                } else {
                    console.error('‚ùå Registration failed:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Railway registration error:', error);
                return false;
            }
        }

        // Login user with Railway
        async function loginUser(username, password) {
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentUserId = result.user.id;
                    currentUser = result.user.email;
                    console.log('‚úÖ User logged in with Railway:', result.user.username);
                    return result.user;
                } else {
                    console.error('‚ùå Login failed:', result.message);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Railway login error:', error);
                return null;
            }
        }
        
        // Get user data from Railway
        async function getUserData() {
            if (!currentUserId) return null;
            
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/user/${currentUserId}/data`);
                const result = await response.json();
                
                if (result.success) {
                    return result.data;
                } else {
                    console.error('‚ùå Failed to get user data:', result.message);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Railway get user data error:', error);
                return null;
            }
        }
        
        // Update user data on Railway
        async function updateUserData(data) {
            if (!currentUserId) return false;
            
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/user/${currentUserId}/data`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('‚úÖ User data updated on Railway');
                    return true;
                } else {
                    console.error('‚ùå Failed to update user data:', result.message);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Railway update user data error:', error);
                return false;
            }
        }
        
        // Load user data from Railway database
        async function loadUserDataFromRailway() {
            if (!currentUserId) {
                console.log('‚ö†Ô∏è No currentUserId, cannot load from Railway');
                return false;
            }
            
            try {
                console.log('üîÑ Loading user data from Railway for user ID:', currentUserId);
                const userData = await getUserData();
                
                if (userData) {
                    console.log('‚úÖ Loaded user data from Railway:', userData);
                    
                    // Update global variables with Railway data
                    if (userData.currentCharacter) {
                        currentCharacter = userData.currentCharacter;
                        console.log('üîÑ Set currentCharacter from Railway:', currentCharacter);
                    }
                    
                    if (userData.ownedCharacters && Array.isArray(userData.ownedCharacters)) {
                        ownedCharacters = userData.ownedCharacters;
                        console.log('üîÑ Set ownedCharacters from Railway:', ownedCharacters);
                    }
                    
                    if (typeof userData.gameCredits === 'number') {
                        gameCredits = userData.gameCredits;
                        console.log('üîÑ Set gameCredits from Railway:', gameCredits);
                    }
                    
                    // Update character database
                    updateCharacterDatabase();
                    
                    return true;
                } else {
                    console.log('‚ö†Ô∏è No user data found on Railway, using defaults');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error loading user data from Railway:', error);
                return false;
            }
        }
        
        // ===== LEGACY FUNCTIONS (Fallback to local storage) =====
        async function getUsernameMappings() {
            const stored = await loadData('usernameMappings');
            return stored || {};
        }

        async function getEmailFromUsername(username) {
            const mappings = await getUsernameMappings();
            return mappings[username] || null;
        }

        async function getCurrentUsername() {
            if (!currentUser) return null;
            
            const mappings = await getUsernameMappings();
            for (const [username, email] of Object.entries(mappings)) {
                if (email === currentUser) {
                    return username;
                }
            }
            return null;
        }

        async function storeUsernameMapping(username, email) {
            const mappings = await getUsernameMappings();
            mappings[username] = email;
            await saveData('usernameMappings', mappings);
            console.log('Stored username mapping:', username, '->', email);
        }

        // ===== MESSAGING FUNCTIONS =====
        // Old Wix function removed - using Railway API instead

        // Old Wix functions removed - using Railway API instead

        // Function to manually set username for current user (for existing accounts)
        // Firebase function removed - using Railway API instead

        // Firebase Auth State Listener
        // Firebase auth state listener removed - using Railway API login persistence instead
        /*
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed - User:', user ? user.email : 'null');
            
            if (user) {
                // User is signed in
                isLoggedIn = true;
                currentUser = user.email;
                
                // Load saved character data and credits
                loadCharacterData();
                
                // Check activation status for this user
                const activationStatus = await getActivationStatus(user.email);
                console.log('Checking activation for email:', user.email);
                console.log('Activation status:', activationStatus);
                
                if (activationStatus.activated) {
                    isActivated = true;
                    console.log('User is already activated with code:', activationStatus.activationCode);
                    // Restore activation UI state with a small delay to ensure DOM is ready
                    setTimeout(() => {
                        restoreActivationUI();
                    }, 100);
                } else {
                    isActivated = false;
                    console.log('User is not activated');
                }
                
                // Find username from email
                let displayName = null;
                
                try {
                    const mappings = await getUsernameMappings();
                    // Look for username that matches this email
                    for (const [username, email] of Object.entries(mappings)) {
                        if (email === user.email) {
                            displayName = username;
                            console.log('Found username for email:', user.email, '->', username);
                            break;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching username mappings:', error);
                }
                
                // If no username found, extract username from email (before @)
                if (!displayName) {
                    displayName = user.email.split('@')[0];
                    console.log('No username mapping found for email:', user.email, 'using email prefix:', displayName);
                    console.log('Available mappings:', mappings);
                }
                
                // Update UI
                document.getElementById('userInfo').innerHTML = `
                    <div class="user-info-avatar logged-in" id="userInfoAvatar">${localStorage.getItem('userAvatar') || 'üë§'}</div>
                    <div><strong>User:</strong> ${displayName}</div>
                    <div><strong>Status:</strong> Online</div>
                `;
                document.getElementById('userInfo').classList.add('logged-in');
                
                // Update profile panel
                document.getElementById('profileUsername').textContent = displayName;
                
                // Set default avatar based on current character
                updateAvatar();
                
                // Show profile panel and hide login panel
                document.getElementById('login').classList.remove('active');
                document.getElementById('profile').classList.add('active');
                
                // Show all sidebar navigation
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.style.display = 'block';
                    item.classList.remove('active'); // Remove active from all items first
                });
                document.getElementById('loginSidebarItem').style.display = 'none';
                document.getElementById('profileSidebarItem').style.display = 'block';
                document.getElementById('profileSidebarItem').classList.add('active');
                document.getElementById('logoutBtn').style.display = 'block';
                
                // Show Quick Access section when logged in
                const quickAccessSection = document.querySelectorAll('.sidebar-section')[1];
                if (quickAccessSection) {
                    quickAccessSection.style.display = 'block';
                }
                
                // Change sidebar title to "Navigation"
                const sidebarTitle = document.getElementById('sidebarTitle');
                if (sidebarTitle) {
                    sidebarTitle.textContent = 'Navigation';
                }
                
                // Update credits display
                document.getElementById('creditsAmount').textContent = gameCredits;
                document.getElementById('gcBalance').textContent = gameCredits + ' GC';
                document.getElementById('creditsAmountSidebar').textContent = gameCredits + ' GC';
                
                // Show the credits info box when logged in
                document.getElementById('creditsInfo').style.display = 'block';
                
                // Show logout button
                document.getElementById('logoutBtn').style.display = 'block';
                
                // Update character card statuses for the logged-in user
                setTimeout(() => {
                    updateCharacterCardStatuses();
                }, 100);
                
                // Update DM notification dot for the logged-in user
                setTimeout(() => {
                    loadDMMessages().catch(console.error);
                    updateDMNotificationDot();
                }, 200);
                
                // Initialize mailbox for the logged-in user
                setTimeout(() => {
                    initializeMailbox();
                }, 300);
                
                // Initialize inventory for the logged-in user
                setTimeout(() => {
                    initializeInventory();
                }, 400);
                
                console.log('User successfully signed in:', user.email, 'as', displayName);
            } else {
                // User is signed out
                isLoggedIn = false;
                currentUser = '';
                gameCredits = 0;
                isActivated = false;
                
                // Update UI
                document.getElementById('userInfo').innerHTML = `
                    <div class="user-info-avatar" id="userInfoAvatar">üë§</div>
                    <div><strong>Status:</strong> Not Logged In</div>
                `;
                document.getElementById('userInfo').classList.remove('logged-in');
                
                // Hide all panels except login
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('login').classList.add('active');
                
                // Hide the credits info box when logged out
                document.getElementById('creditsInfo').style.display = 'none';
                
                // Hide all sidebar navigation except login
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.style.display = 'none';
                    item.classList.remove('active'); // Remove active from all items
                });
                document.getElementById('loginSidebarItem').style.display = 'block';
                document.getElementById('loginSidebarItem').classList.add('active');
                
                // Hide Quick Access section when logged out
                const quickAccessSection = document.querySelectorAll('.sidebar-section')[1];
                if (quickAccessSection) {
                    quickAccessSection.style.display = 'none';
                }
                
                // Change sidebar title to "Account"
                const sidebarTitle = document.getElementById('sidebarTitle');
                if (sidebarTitle) {
                    sidebarTitle.textContent = 'Account';
                }
                
                // Clear credits display
                document.getElementById('creditsAmount').textContent = '0';
                document.getElementById('gcBalance').textContent = '0 GC';
                document.getElementById('creditsAmountSidebar').textContent = '0 GC';
                
                // Hide logout button
                document.getElementById('logoutBtn').style.display = 'none';
                
                // Reset character card statuses to default state
                setTimeout(() => {
                    updateCharacterCardStatuses();
                }, 100);
                
                // Hide DM notification dot when logged out
                const notificationDot = document.getElementById('dmNotificationDot');
                if (notificationDot) {
                    notificationDot.style.display = 'none';
                }
                
                console.log('User signed out');
            }
        });
        */

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                if (section && section.classList) {
                    section.classList.remove('active');
                }
            });
            
            // Show selected section
            const targetSection = document.getElementById(sectionId);
            if (targetSection && targetSection.classList) {
                targetSection.classList.add('active');
            }
            
            // Refresh specific sections when shown
            if (sectionId === 'inventory') {
                // Ensure filtered items are in sync with inventory items
                filteredInventoryItems = [...inventoryItems];
                updateInventoryUI();
            } else if (sectionId === 'mailbox') {
                updateMailboxUI();
            }
            
            // Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                if (item && item.classList) {
                    item.classList.remove('active');
                }
            });
            
            // Only add active class if event.target exists and has classList
            if (event && event.target && event.target.classList) {
                event.target.classList.add('active');
            }
        }


        function openMyBase() {
            alert('üè† My Base\n\nThis feature will show your personal base, buildings, and resources.\n\nComing soon!');
        }

        function openFriends() {
            alert('üë• Friends\n\nThis feature will show your friends list, followers, and social features.\n\nComing soon!');
        }

        async function openDM() {
            if (!isLoggedIn) {
                alert('Please login first to access Direct Messages.');
                return;
            }
            
            console.log('Opening DM modal...');
            console.log('isLoggedIn:', isLoggedIn);
            
            // Check if modal element exists
            const dmModal = document.getElementById('dmModal');
            if (!dmModal) {
                console.error('DM modal element not found!');
                alert('Error: DM modal not found. Please refresh the page.');
                return;
            }
            
            console.log('DM modal element found:', dmModal);
            console.log('DM modal current display:', dmModal.style.display);
            console.log('DM modal computed display:', window.getComputedStyle(dmModal).display);
            
            // Load messages and show DM modal
            try {
                await loadDMMessages();
                console.log('loadDMMessages completed');
            } catch (error) {
                console.error('Error in loadDMMessages:', error);
            }
            
            dmModal.style.display = 'block';
            console.log('DM modal display set to block');
            
            // Check if it actually changed
            setTimeout(() => {
                console.log('After 100ms - DM modal computed style:', window.getComputedStyle(dmModal).display);
                console.log('DM modal z-index:', window.getComputedStyle(dmModal).zIndex);
                console.log('DM modal position:', window.getComputedStyle(dmModal).position);
            }, 100);
        }

        // Test function to force open DM modal
        function testOpenDM() {
            console.log('=== TESTING DM MODAL OPENING ===');
            const dmModal = document.getElementById('dmModal');
            if (!dmModal) {
                console.error('DM modal not found!');
                return;
            }
            
            console.log('DM modal found:', dmModal);
            console.log('Current style:', dmModal.style.cssText);
            console.log('Computed style:', window.getComputedStyle(dmModal).cssText);
            
            // Force open
            dmModal.style.display = 'block';
            dmModal.style.visibility = 'visible';
            dmModal.style.opacity = '1';
            dmModal.style.zIndex = '1000';
            
            console.log('Forced styles applied');
            console.log('New computed style:', window.getComputedStyle(dmModal).cssText);
        }

        // Debug function to check all modal elements
        async function debugDMModal() {
            console.log('=== DEBUGGING DM MODAL ===');
            
            // Check if user is logged in
            console.log('isLoggedIn:', isLoggedIn);
            console.log('currentUser:', currentUser);
            
            // Check DM modal element
            const dmModal = document.getElementById('dmModal');
            console.log('dmModal element:', dmModal);
            
            if (dmModal) {
                console.log('dmModal tagName:', dmModal.tagName);
                console.log('dmModal className:', dmModal.className);
                console.log('dmModal id:', dmModal.id);
                console.log('dmModal parentElement:', dmModal.parentElement);
                console.log('dmModal offsetParent:', dmModal.offsetParent);
                console.log('dmModal getBoundingClientRect:', dmModal.getBoundingClientRect());
                
                // Check all computed styles
                const computedStyle = window.getComputedStyle(dmModal);
                console.log('Computed styles:');
                console.log('- display:', computedStyle.display);
                console.log('- visibility:', computedStyle.visibility);
                console.log('- opacity:', computedStyle.opacity);
                console.log('- z-index:', computedStyle.zIndex);
                console.log('- position:', computedStyle.position);
                console.log('- top:', computedStyle.top);
                console.log('- left:', computedStyle.left);
                console.log('- width:', computedStyle.width);
                console.log('- height:', computedStyle.height);
            }
            
            // Check if there are any JavaScript errors
            console.log('Checking for JavaScript errors...');
            try {
                await loadDMMessages();
                console.log('loadDMMessages() executed successfully');
            } catch (error) {
                console.error('Error in loadDMMessages():', error);
            }
        }

        // Test function for start conversation
        function testStartConversation() {
            console.log('=== TESTING START CONVERSATION ===');
            
            // Check if we have a selected recipient
            console.log('selectedDMRecipient:', selectedDMRecipient);
            
            // Check if user is logged in
            console.log('isLoggedIn:', isLoggedIn);
            console.log('currentUser:', currentUser);
            
            // Check current username function
            const currentUsername = getCurrentUsername();
            console.log('getCurrentUsername() result:', currentUsername);
            
            // Check if we can create conversation ID
            if (selectedDMRecipient && currentUsername) {
                const conversationId = createConversationId(currentUsername, selectedDMRecipient);
                console.log('Conversation ID would be:', conversationId);
                
                // Check if conversation already exists
                const existingConversation = getConversation(conversationId);
                console.log('Existing conversation:', existingConversation);
            }
            
            // Check DM modal elements
            const dmModal = document.getElementById('dmModal');
            const welcomeScreen = document.getElementById('dmWelcomeScreen');
            const chatInterface = document.getElementById('dmChatInterface');
            
            console.log('DM modal:', dmModal);
            console.log('Welcome screen:', welcomeScreen);
            console.log('Chat interface:', chatInterface);
            
            if (dmModal) {
                console.log('DM modal display:', window.getComputedStyle(dmModal).display);
            }
            if (welcomeScreen) {
                console.log('Welcome screen display:', window.getComputedStyle(welcomeScreen).display);
            }
            if (chatInterface) {
                console.log('Chat interface display:', window.getComputedStyle(chatInterface).display);
            }
        }

        // Function to manually clean up corrupted conversation data
        function cleanupCorruptedConversations() {
            console.log('=== CLEANING UP CORRUPTED CONVERSATIONS ===');
            let cleanedCount = 0;
            
            // Get all conversation keys from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('conversation_')) {
                    try {
                        const conversationData = localStorage.getItem(key);
                        if (conversationData) {
                            JSON.parse(conversationData);
                            console.log('Valid conversation:', key);
                        }
                    } catch (error) {
                        console.log('Removing corrupted conversation:', key);
                        localStorage.removeItem(key);
                        cleanedCount++;
                    }
                }
            }
            
            console.log(`Cleaned up ${cleanedCount} corrupted conversations`);
            return cleanedCount;
        }

        function openWallet() {
            alert('üí∞ Wallet\n\nThis feature will show your crypto wallet, balances, and transactions.\n\nComing soon!');
        }

        function purchaseItem(itemType) {
            const items = {
                'premium': { name: 'Premium Pass', price: 500 },
                'boost': { name: 'XP Boost', price: 100 },
                'skin': { name: 'Character Skin', price: 250 },
                'weapon': { name: 'Legendary Weapon', price: 750 }
            };
            
            const item = items[itemType];
            if (!item) return;
            
            if (!isLoggedIn) {
                alert('Please login to purchase items.');
                return;
            }
            
            if (gameCredits >= item.price) {
                gameCredits -= item.price;
                document.getElementById('creditsAmount').textContent = gameCredits;
                document.getElementById('gcBalance').textContent = gameCredits + ' GC';
                
                alert(`‚úÖ Purchase Successful!\n\n${item.name} has been added to your inventory.\n\nRemaining Credits: ${gameCredits} GC`);
            } else {
                alert(`‚ùå Insufficient Credits\n\nYou need ${item.price} GC to purchase ${item.name}.\n\nCurrent Credits: ${gameCredits} GC`);
            }
        }

        function purchaseCredits(packType) {
            const packs = {
                'small': { name: '100 GC Pack', price: '$2.99', credits: 100 },
                'medium': { name: '500 GC Pack', price: '$9.99', credits: 500 },
                'large': { name: '1000 GC Pack', price: '$14.99', credits: 1000 },
                'mega': { name: '2500 GC Pack', price: '$29.99', credits: 2500 }
            };
            
            const pack = packs[packType];
            if (!pack) return;
            
            if (!isLoggedIn) {
                alert('Please login to purchase credits.');
                return;
            }
            
            alert(`üí≥ Credit Purchase\n\n${pack.name}\nPrice: ${pack.price}\nCredits: ${pack.credits} GC\n\nThis feature will integrate with payment processing.\n\nComing soon!`);
        }

        function activateSoftware() {
            if (!isLoggedIn) {
                alert('Please login first before activating SkyParty.');
                return;
            }
            
            const code1 = document.getElementById('activationCode1').value.toUpperCase();
            const code2 = document.getElementById('activationCode2').value.toUpperCase();
            const code3 = document.getElementById('activationCode3').value.toUpperCase();
            const code4 = document.getElementById('activationCode4').value.toUpperCase();
            
            const fullCode = `${code1}-${code2}-${code3}-${code4}`;
            console.log('Entered code:', fullCode);
            
            const validCodes = [
                'SKYP-ARTY-2024-GOLD', 
                'TEST-CODE-ABCD-1234', 
                'DEMO-FULL-ACCE-XYZ',
                'PREM-IUMU-SER2-024',
                'VIPM-EMBE-RCOD-E123',
                'BETA-TEST-ER20-24',
                'EARL-YBIR-DSPE-CIAL',
                'FOUN-DER2-024-CODE',
                'GOLD-ENTI-CKET-CODE',
                'PLAT-INUM-ACCE-SS24'
            ];
            
            console.log('Valid codes:', validCodes);
            
            if (validCodes.includes(fullCode)) {
                isActivated = true;
                
                // Save activation status for current user
                if (currentUser) {
                    saveActivationStatus(currentUser, fullCode);
                }
                
                // Update title bar - remove "(Unactivated)" text
                document.querySelector('.title-bar-text').textContent = 'SkyParty';
                
                // Show success message
                alert('üéâ SkyParty has been successfully activated!\n\nAll premium features are now unlocked.');
                
                // Disable activation code boxes and make them gray
                for (let i = 1; i <= 4; i++) {
                    const box = document.getElementById(`activationCode${i}`);
                    box.classList.add('activated');
                    box.disabled = true;
                }
                
                // Hide activate button and show activation status
                document.getElementById('activateBtn').style.display = 'none';
                document.getElementById('activationStatus').style.display = 'flex';
                
                // Hide activation warning
                document.getElementById('activationWarning').style.display = 'none';
                
                // Update license information
                document.getElementById('licenseStatus').textContent = 'Activated';
                document.getElementById('licenseStatus').style.color = '#228b22';
                document.getElementById('licenseType').textContent = 'Full License (All Features)';
                document.getElementById('licenseDays').textContent = 'Unlimited';
                
                // Switch to dashboard
                showSection('dashboard');
                // Manually set the dashboard sidebar item as active
                const dashboardItem = document.querySelectorAll('.sidebar-item')[2];
                if (dashboardItem && dashboardItem.classList) {
                    dashboardItem.classList.add('active');
                }
                
            } else if (fullCode === '---') {
                alert('Please enter an activation code.');
            } else {
                alert('‚ùå Invalid activation code.\n\nPlease check your code and try again, or contact support.');
            }
        }

        function cancelActivation() {
            if (confirm('Are you sure you want to cancel the activation?\n\nThis will deactivate SkyParty and return it to evaluation mode.')) {
                isActivated = false;
                
                // Clear activation status for current user
                if (currentUser) {
                    clearActivationStatus(currentUser);
                }
                
                // Update title bar - add "(Unactivated)" text
                document.querySelector('.title-bar-text').textContent = 'SkyParty (Unactivated)';
                
                // Re-enable activation code boxes
                for (let i = 1; i <= 4; i++) {
                    const box = document.getElementById(`activationCode${i}`);
                    box.classList.remove('activated');
                    box.disabled = false;
                    box.value = '';
                }
                
                // Show activate button and hide activation status
                document.getElementById('activateBtn').style.display = 'inline-block';
                document.getElementById('activationStatus').style.display = 'none';
                
                // Show activation warning
                document.getElementById('activationWarning').style.display = 'block';
                
                // Reset license information
                document.getElementById('licenseStatus').textContent = 'Unactivated';
                document.getElementById('licenseStatus').style.color = '#dc3545';
                document.getElementById('licenseType').textContent = 'Evaluation (Limited Features)';
                document.getElementById('licenseDays').textContent = '30 days';
                
                // Focus first activation box
                document.getElementById('activationCode1').focus();
                
                alert('SkyParty has been deactivated and returned to evaluation mode.');
            }
        }

        function moveToNext(boxNumber, event) {
            const currentBox = document.getElementById(`activationCode${boxNumber}`);
            const nextBox = document.getElementById(`activationCode${boxNumber + 1}`);
            
            // Convert to uppercase
            currentBox.value = currentBox.value.toUpperCase();
            
            // If current box is full and there's a next box, move to it
            if (currentBox.value.length === 4 && nextBox) {
                nextBox.focus();
            }
        }

        function handleKeyDown(boxNumber, event) {
            const currentBox = document.getElementById(`activationCode${boxNumber}`);
            const prevBox = document.getElementById(`activationCode${boxNumber - 1}`);
            
            // Handle backspace - if current box is empty, move to previous box
            if (event.key === 'Backspace' && currentBox.value === '' && prevBox) {
                prevBox.focus();
            }
            
            // Handle arrow keys
            if (event.key === 'ArrowLeft' && prevBox) {
                prevBox.focus();
            }
            if (event.key === 'ArrowRight') {
                const nextBox = document.getElementById(`activationCode${boxNumber + 1}`);
                if (nextBox) {
                    nextBox.focus();
                }
            }
        }

        function handlePaste(event) {
            event.preventDefault();
            const pastedData = (event.clipboardData || window.clipboardData).getData('text').toUpperCase();
            
            // Remove any non-alphanumeric characters except dashes
            const cleanData = pastedData.replace(/[^A-Z0-9-]/g, '');
            
            // Split by dashes or take first 4 characters of each segment
            let segments = cleanData.split('-');
            if (segments.length === 1) {
                // If no dashes, split into 4-character chunks
                segments = [];
                for (let i = 0; i < cleanData.length; i += 4) {
                    segments.push(cleanData.substr(i, 4));
                }
            }
            
            // Fill the boxes
            for (let i = 0; i < Math.min(4, segments.length); i++) {
                const box = document.getElementById(`activationCode${i + 1}`);
                if (box) {
                    box.value = segments[i].substr(0, 4);
                }
            }
            
            // Focus the last filled box or the first empty box
            for (let i = 0; i < 4; i++) {
                const box = document.getElementById(`activationCode${i + 1}`);
                if (box && box.value.length < 4) {
                    box.focus();
                    break;
                }
            }
        }

        function login() {
            const usernameOrEmail = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            console.log('Login attempt with:', usernameOrEmail);
            
            // Clear all previous errors
            clearAllLoginErrors();
            
            let hasErrors = false;
            
            // Validate each field
            if (!usernameOrEmail) {
                showLoginFieldError('username', 'Please fill in this field');
                hasErrors = true;
            }
            
            if (!password) {
                showLoginFieldError('password', 'Please fill in this field');
                hasErrors = true;
            }
            
            // If there are any errors, stop here
            if (hasErrors) {
                return;
            }
            
            // Determine if input is email or username
            const isEmail = usernameOrEmail.includes('@');
            let emailToUse = usernameOrEmail;
            
            // Railway loginUser can handle both usernames and emails directly
            performLogin(usernameOrEmail, password);
        }
        
        // Update UI for Railway login (copies Firebase auth state listener logic)
        async function updateUIForLoggedInUser(username) {
            console.log('Updating UI for logged in user:', username);
            
            // Load character data and credits from Railway database first
            console.log('üîÑ Loading user data from Railway...');
            await loadUserDataFromRailway();
            
            // Load character data from local storage as fallback
            console.log('üîÑ Loading character data from local storage as fallback...');
            loadCharacterData();
            
            // Update avatar based on current character
            updateAvatar();
            
            // Update user info box (avatar and status) - use unified avatar system
            const avatarEmoji = getCurrentUserAvatar();
            
            document.getElementById('userInfo').innerHTML = `
                <div class="user-info-avatar logged-in" id="userInfoAvatar">${avatarEmoji}</div>
                <div><strong>User:</strong> ${username}</div>
                <div><strong>Status:</strong> Online</div>
            `;
            document.getElementById('userInfo').classList.add('logged-in');
            
            // Update profile panel
            document.getElementById('profileUsername').textContent = username;
            
            // Show profile panel and hide login panel
            document.getElementById('login').classList.remove('active');
            document.getElementById('profile').classList.add('active');
            
            // Show all sidebar navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.style.display = 'block';
                item.classList.remove('active'); // Remove active from all items first
            });
            document.getElementById('loginSidebarItem').style.display = 'none';
            document.getElementById('profileSidebarItem').style.display = 'block';
            document.getElementById('profileSidebarItem').classList.add('active');
            document.getElementById('logoutBtn').style.display = 'block';
            
            // Show Quick Access section when logged in
            const quickAccessSection = document.querySelectorAll('.sidebar-section')[1];
            if (quickAccessSection) {
                quickAccessSection.style.display = 'block';
            }
            
            // Change sidebar title to "Navigation"
            const sidebarTitle = document.getElementById('sidebarTitle');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'Navigation';
            }
            
            // Update credits display with actual loaded data
            console.log('üîÑ Updating credits display with:', gameCredits);
            document.getElementById('creditsAmount').textContent = gameCredits;
            document.getElementById('gcBalance').textContent = gameCredits + ' GC';
            document.getElementById('creditsAmountSidebar').textContent = gameCredits + ' GC';
            
            // Show the credits info box when logged in
            document.getElementById('creditsInfo').style.display = 'block';
            
            // Show logout button
            document.getElementById('logoutBtn').style.display = 'block';
            
            // Update character card statuses for the logged-in user
            setTimeout(() => {
                updateCharacterCardStatuses();
                populateAllCharacters(); // Refresh character display
            }, 100);
            
            // Update DM notification dot for the logged-in user
            setTimeout(() => {
                loadDMMessages().catch(console.error);
                updateDMNotificationDot();
            }, 200);
            
            // Initialize mailbox for the logged-in user
            setTimeout(() => {
                initializeMailbox();
            }, 300);
            
            // Initialize inventory for the logged-in user
            setTimeout(() => {
                initializeInventory();
            }, 400);
            
            // Start avatar synchronization system
            startAvatarSyncSystem();
            
            console.log('‚úÖ User successfully signed in via Railway:', username, 'with', gameCredits, 'credits and character:', currentCharacter);
        }
        
        async function performLogin(usernameOrEmail, password) {
            try {
                // Check if it's a username or email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                const isEmail = emailRegex.test(usernameOrEmail);
                
                console.log('Attempting Railway login with:', usernameOrEmail, isEmail ? '(email)' : '(username)');
                
                // Login with Railway (can handle both username and email)
                const user = await loginUser(usernameOrEmail, password);
                
                if (user) {
                    console.log('Railway login successful:', user);
                    
                    // Set current user info
                    currentUser = user.email;
                    currentUserId = user.id;
                    isLoggedIn = true;
                    
                    // Load user data from Railway
                    const userData = await getUserData();
                    if (userData) {
                        currentCharacter = userData.currentCharacter || 'kitty';
                        ownedCharacters = userData.ownedCharacters || ['kitty'];
                        gameCredits = userData.gameCredits || 150;
                    }
                    
                    // Save login state for persistence
                    await saveLoginState(user);
                    
                    // Update UI to show logged in state (now async)
                    await updateUIForLoggedInUser(user.username);
                    
                    // Clear form
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    
                    // Show success message
                    alert('Login successful! Welcome to the Game Universe!');
                    
                    // Switch to dashboard
                    showSection('dashboard');
                    // Manually set the dashboard sidebar item as active
                    const dashboardItem = document.querySelectorAll('.sidebar-item')[2];
                    if (dashboardItem && dashboardItem.classList) {
                        dashboardItem.classList.add('active');
                    }
                } else {
                    console.log('Railway login failed');
                    alert('Login failed. Please check your username/email and password.');
                }
            } catch (error) {
                console.error('Railway login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        function register() {
            // Show registration modal
            document.getElementById('registrationModal').style.display = 'block';
            // Reset to first step
            showRegistrationStep('registrationForm');
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            // Clear form fields
            document.getElementById('regUsername').value = '';
            document.getElementById('regDateOfBirth').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
        }

        function showRegistrationStep(stepId) {
            // Hide all steps
            document.querySelectorAll('.registration-step').forEach(step => {
                step.classList.remove('active');
            });
            // Show selected step
            document.getElementById(stepId).classList.add('active');
        }

        async function nextRegistrationStep() {
            const username = document.getElementById('regUsername').value;
            const dateOfBirth = document.getElementById('regDateOfBirth').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            
            // Clear all previous errors
            clearAllErrors();
            
            let hasErrors = false;
            
            // Validate each field
            if (!username) {
                showFieldError('username', 'Please fill in this field');
                hasErrors = true;
            }
            
            if (!dateOfBirth) {
                showFieldError('date', 'Please fill in this field');
                hasErrors = true;
            }
            
            if (!email) {
                showFieldError('email', 'Please fill in this field');
                hasErrors = true;
            }
            
            if (!password) {
                showFieldError('password', 'Please fill in this field');
                hasErrors = true;
            } else if (password.length < 6) {
                showFieldError('password', 'Password must be at least 6 characters long');
                hasErrors = true;
            }
            
            // Validate date of birth (must be at least 13 years old)
            if (dateOfBirth) {
                const today = new Date();
                const birthDate = new Date(dateOfBirth);
                const age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (age < 13 || (age === 13 && monthDiff < 0)) {
                    showFieldError('date', 'You must be at least 13 years old to register');
                    hasErrors = true;
                }
            }
            
            // Check if username is already taken (Railway will handle this)
            // We'll let Railway API handle username uniqueness validation
            
            // If there are any errors, stop here
            if (hasErrors) {
                return;
            }
            
            console.log('Attempting registration with Railway:', { username, email, dateOfBirth });
            
            // Register user with Railway
            registerUser(username, email, password)
                .then((success) => {
                    if (success) {
                        console.log('Railway registration successful');
                        
                        // Store username mapping in local storage for search functionality
                    storeUsernameMapping(username, email);
                    
                    // Initialize character data for new user
                    currentCharacter = 'kitty';
                    ownedCharacters = ['kitty'];
                    gameCredits = 150;
                    
                        // Store initial user data on Railway
                        updateUserData({
                            currentCharacter: currentCharacter,
                            ownedCharacters: ownedCharacters,
                            gameCredits: gameCredits,
                            dateOfBirth: dateOfBirth
                        });
                    
                    // Success - show success step
                    showRegistrationStep('registrationSuccess');
                    } else {
                        showFieldError('username', 'Registration failed. Username or email may already exist.');
                    }
                })
                .catch((error) => {
                    console.error('Railway registration error:', error);
                    showFieldError('username', 'Registration failed. Please try again.');
                });
        }

        function logout() {
            auth.signOut()
                .then(() => {
                    alert('Logged out successfully!');
                    
                    // Reset activation UI to unactivated state
                    document.querySelector('.title-bar-text').textContent = 'SkyParty (Unactivated)';
                    
                    // Re-enable activation code boxes
                    for (let i = 1; i <= 4; i++) {
                        const box = document.getElementById(`activationCode${i}`);
                        if (box) {
                            box.classList.remove('activated');
                            box.disabled = false;
                            box.value = '';
                        }
                    }
                    
                    // Show activate button and hide activation status
                    const activateBtn = document.getElementById('activateBtn');
                    const activationStatus = document.getElementById('activationStatus');
                    if (activateBtn) activateBtn.style.display = 'block';
                    if (activationStatus) activationStatus.style.display = 'none';
                    
                    // Show activation warning
                    const activationWarning = document.getElementById('activationWarning');
                    if (activationWarning) activationWarning.style.display = 'block';
                    
                    // Update license information
                    const licenseStatus = document.getElementById('licenseStatus');
                    const licenseType = document.getElementById('licenseType');
                    const licenseDays = document.getElementById('licenseDays');
                    if (licenseStatus) {
                        licenseStatus.textContent = 'Unactivated';
                        licenseStatus.style.color = '#dc3545';
                    }
                    if (licenseType) licenseType.textContent = 'Evaluation (Limited Features)';
                    if (licenseDays) licenseDays.textContent = '30 days';
                    
                    // Force switch to login panel
                    showSection('login');
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                    alert('Error logging out: ' + error.message);
                });
        }

        function connectWallet() {
            if (!isLoggedIn) {
                alert('Please login first to connect your wallet.');
                return;
            }
            
            walletConnected = true;
            
            // Update wallet status
            document.getElementById('walletStatus').textContent = 'Connected (0x1234...abcd)';
            document.getElementById('walletStatus2').textContent = 'Connected (0x1234...abcd)';
            document.getElementById('walletIndicator').classList.add('connected');
            document.getElementById('walletIndicator2').classList.add('connected');
            document.getElementById('tokenBalance').textContent = '0.15 ETH';
            
            alert('Wallet connected successfully!');
        }

        function launchGame(gameType) {
            if (!isLoggedIn) {
                alert('Please login to play games.');
                return;
            }
            
            const earnedCredits = Math.floor(Math.random() * 50) + 10;
            gameCredits += earnedCredits;
            
            document.getElementById('creditsAmount').textContent = gameCredits;
            document.getElementById('gcBalance').textContent = gameCredits + ' GC';
            
            const gameNames = {
                'story': 'Main Story Mode',
                'p2e1': 'Play to Earn - Game 1',
                'p2e2': 'Play to Earn - Game 2',
                'p2e3': 'Play to Earn - Game 3',
                'p2e4': 'Play to Earn - Game 4',
                'event1': 'Event - Game 1',
                'event2': 'Event - Game 2',
                'event3': 'Event - Game 3',
                'event4': 'Event - Game 4',
                'user1': 'User Game 1',
                'user2': 'User Game 2',
                'user3': 'User Game 3',
                'user4': 'User Game 4'
            };
            
            alert(`Launching ${gameNames[gameType] || 'Game'}!\n\nYou earned ${earnedCredits} Game Credits for playing!`);
        }

        function launchMainGame() {
            launchGame('story');
        }

        function openCreditsPopup() {
            if (!isLoggedIn) {
                alert('Please login first to purchase credits.');
                return;
            }
            document.getElementById('creditsModal').style.display = 'block';
        }

        function closeCreditsModal() {
            document.getElementById('creditsModal').style.display = 'none';
        }

        async function purchaseCreditsPackage(amount) {
            const prices = {
                500: '$4.99',
                1000: '$8.99',
                2000: '$15.99',
                5000: '$29.99'
            };
            
            const price = prices[amount];
            
            if (confirm(`Purchase ${amount} Game Credits for ${price}?\n\nThis will add ${amount} GC to your account.`)) {
                // Add credits to user's account
                gameCredits += amount;
                
                // Update all credit displays
                document.getElementById('creditsAmount').textContent = gameCredits;
                document.getElementById('gcBalance').textContent = gameCredits + ' GC';
                document.getElementById('creditsAmountSidebar').textContent = gameCredits + ' GC';
                
                // Save character data
                await saveCharacterData();
                
                // Close modal
                closeCreditsModal();
                
                // Show success message
                alert(`‚úÖ Purchase Successful!\n\n${amount} Game Credits have been added to your account.\n\nTotal Credits: ${gameCredits} GC`);
            }
        }

        currentCharacter = 'kitty'; // Default character for everyone
        ownedCharacters = ['kitty']; // Characters the user owns

        // Character and credits persistence functions
        async function saveCharacterData() {
            if (!currentUser) {
                console.log('No current user to save character data for');
                return;
            }
            
            const characterData = {
                currentCharacter: currentCharacter,
                ownedCharacters: ownedCharacters,
                gameCredits: gameCredits
            };
            
            // Save to local storage
            const userStorageKey = `characterData_${currentUser}`;
            localStorage.setItem(userStorageKey, JSON.stringify(characterData));
            console.log('Saved character data to local storage for user:', currentUser, characterData);
            
            // Also save to Railway database
            if (currentUserId) {
                try {
                    const success = await updateUserData(characterData);
                    if (success) {
                        console.log('‚úÖ Character data saved to Railway for user:', currentUser);
                    } else {
                        console.log('‚ö†Ô∏è Failed to save character data to Railway for user:', currentUser);
                    }
                } catch (error) {
                    console.error('‚ùå Error saving character data to Railway:', error);
                }
            } else {
                console.log('‚ö†Ô∏è No currentUserId available to save to Railway');
            }
        }

        function loadCharacterData() {
            if (!currentUser) {
                console.log('No current user to load character data for');
                return;
            }
            
            // Use user-specific storage key
            const userStorageKey = `characterData_${currentUser}`;
            const savedData = localStorage.getItem(userStorageKey);
            
            if (savedData) {
                const characterData = JSON.parse(savedData);
                currentCharacter = characterData.currentCharacter || 'kitty';
                ownedCharacters = characterData.ownedCharacters || ['kitty'];
                gameCredits = characterData.gameCredits || 150;
                console.log('Loaded character data for user:', currentUser, characterData);
            } else {
                // Set default values for new users
                currentCharacter = 'kitty';
                ownedCharacters = ['kitty'];
                gameCredits = 150;
                console.log('No saved data found for user:', currentUser, '- using defaults');
            }
            
            // Update character database with current user's data
            updateCharacterDatabase();
        }

        function updateCharacterDatabase() {
            // Update the character database to reflect current user's ownership and selection
            characterDatabase.forEach(character => {
                character.owned = ownedCharacters.includes(character.id);
                character.selected = currentCharacter === character.id;
            });
            console.log('Updated character database for user:', currentUser);
        }

        // Function to update avatar based on current character
        function updateAvatar() {
            // Ensure we have a current character (default to kitty for new users)
            if (!currentCharacter) {
                currentCharacter = 'kitty';
            }
            
            // Find character in database to get the correct emoji
            const character = characterDatabase.find(char => char.id === currentCharacter);
            const avatarEmoji = character ? character.icon : 'üê±';
            
            console.log('Updating avatar to:', currentCharacter, 'with emoji:', avatarEmoji);
            
            // Update profile avatar
            const profileAvatar = document.querySelector('.avatar-box');
            if (profileAvatar) {
                profileAvatar.textContent = avatarEmoji;
            }
            
            // Update sidebar avatar
            const sidebarAvatar = document.getElementById('userInfoAvatar');
            if (sidebarAvatar) {
                sidebarAvatar.textContent = avatarEmoji;
            }
            
            // Save avatar preference
            localStorage.setItem('userAvatar', avatarEmoji);
        }

        function showCharacterDetails(characterName) {
            // Allow viewing character details even when logged out

            const character = characterDatabase.find(char => char.id === characterName);
            if (!character) return;

            // Update character ownership status based on current data
            character.owned = ownedCharacters.includes(characterName);
            character.selected = currentCharacter === characterName;

            // Update modal title bar
            const modalIcon = document.getElementById('characterModalIcon');
            const modalTitle = document.getElementById('characterModalTitle');
            if (modalIcon) modalIcon.textContent = character.icon;
            if (modalTitle) modalTitle.textContent = character.name;

            // Update character details
            const detailIcon = document.getElementById('characterDetailIcon');
            const detailName = document.getElementById('characterDetailName');
            const detailStatus = document.getElementById('characterDetailStatus');
            const detailDescription = document.getElementById('characterDetailDescription');
            
            if (detailIcon) detailIcon.textContent = character.icon;
            if (detailName) detailName.textContent = character.name;
            if (detailStatus) detailStatus.textContent = character.owned ? 'Owned' : `${character.price} GC`;
            if (detailDescription) detailDescription.textContent = character.description;
            
            // Calculate quantity in inventory
            const characterQuantity = inventoryItems.filter(item => 
                item.type === 'character' && item.name === character.name
            ).length;
            
            // Update quantity display with price reminder
            const priceReminder = characterQuantity > 0 ? `Price: ${character.price} GC` : '';
            const detailQuantity = document.getElementById('characterDetailQuantity');
            if (detailQuantity) {
                detailQuantity.innerHTML = 
                    characterQuantity > 0 ? 
                    `Quantity: ${characterQuantity}<br><span style="color: #999; font-size: 10px;">${priceReminder}</span>` : 
                    'Quantity: 0';
            }
            
            // Update action buttons
            const selectBtn = document.getElementById('characterSelectBtn');
            const giftBtn = document.getElementById('characterGiftBtn');
            
            if (!selectBtn || !giftBtn) {
                console.error('Character modal buttons not found');
                return;
            }
            
            if (!isLoggedIn) {
                selectBtn.textContent = 'Login to Use';
                selectBtn.onclick = () => {
                    closeCharacterDetailsModal();
                    showSection('login');
                };
                giftBtn.style.display = 'none';
            } else if (character.owned) {
                selectBtn.textContent = 'Select';
                selectBtn.onclick = () => selectCharacter(characterName).catch(console.error);
                giftBtn.textContent = 'Gift';
                giftBtn.onclick = () => giftCharacter(characterName);
                giftBtn.style.display = 'inline-block';
            } else {
                selectBtn.textContent = `Buy (${character.price} GC)`;
                selectBtn.onclick = () => purchaseCharacter(characterName);
                giftBtn.style.display = 'none';
            }

            // Show the modal
            document.getElementById('characterDetailsModal').style.display = 'block';
        }

        function closeCharacterDetailsModal() {
            document.getElementById('characterDetailsModal').style.display = 'none';
        }

        function showFieldError(fieldId, message) {
            const errorDiv = document.getElementById(fieldId + 'Error');
            let inputField;
            
            // Handle special case for date field
            if (fieldId === 'date') {
                inputField = document.getElementById('regDateOfBirth');
            } else {
                inputField = document.getElementById('reg' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
            }
            
            if (errorDiv && inputField) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                inputField.classList.add('field-error');
            }
        }

        function hideFieldError(fieldId) {
            const errorDiv = document.getElementById(fieldId + 'Error');
            let inputField;
            
            // Handle special case for date field
            if (fieldId === 'date') {
                inputField = document.getElementById('regDateOfBirth');
            } else {
                inputField = document.getElementById('reg' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1));
            }
            
            if (errorDiv && inputField) {
                errorDiv.classList.remove('show');
                inputField.classList.remove('field-error');
            }
        }

        function clearAllErrors() {
            const fields = ['username', 'date', 'email', 'password'];
            fields.forEach(field => hideFieldError(field));
        }

        function showLoginFieldError(fieldId, message) {
            const errorDiv = document.getElementById('login' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1) + 'Error');
            const inputField = document.getElementById(fieldId);
            
            if (errorDiv && inputField) {
                errorDiv.textContent = message;
                errorDiv.classList.add('show');
                inputField.classList.add('field-error');
            }
        }

        function hideLoginFieldError(fieldId) {
            const errorDiv = document.getElementById('login' + fieldId.charAt(0).toUpperCase() + fieldId.slice(1) + 'Error');
            const inputField = document.getElementById(fieldId);
            
            if (errorDiv && inputField) {
                errorDiv.classList.remove('show');
                inputField.classList.remove('field-error');
            }
        }

        function clearAllLoginErrors() {
            hideLoginFieldError('username');
            hideLoginFieldError('password');
        }

        // Character search functionality

        function searchCharacters() {
            const searchTerm = document.getElementById('characterSearch').value.toLowerCase().trim();
            const searchResultsPanel = document.getElementById('searchResultsPanel');
            const allCharactersPanel = document.getElementById('allCharactersPanel');
            const searchResults = document.getElementById('searchResults');
            
            if (searchTerm === '') {
                // Show all characters, hide search results
                searchResultsPanel.style.display = 'none';
                allCharactersPanel.style.display = 'block';
                return;
            }
            
            // Filter characters based on search term
            const filteredCharacters = characterDatabase.filter(character => 
                character.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredCharacters.length === 0) {
                // No results found
                searchResults.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üîç</div>
                        <div>No characters found matching "${searchTerm}"</div>
                    </div>
                `;
            } else {
                // Display search results
                searchResults.innerHTML = '';
                filteredCharacters.forEach(character => {
                    const characterCard = createCharacterCard(character);
                    searchResults.appendChild(characterCard);
                });
            }
            
            // Show search results, hide all characters
            searchResultsPanel.style.display = 'block';
            allCharactersPanel.style.display = 'none';
        }

        function createCharacterCard(character) {
            const card = document.createElement('div');
            card.className = 'character-card';
            
            // Check current ownership and selection status
            const isOwned = ownedCharacters.includes(character.id);
            const isSelected = currentCharacter === character.id;
            
            let statusText = '';
            let statusClass = '';
            
            if (isOwned) {
                if (isSelected) {
                    statusText = 'Selected';
                    statusClass = 'selected';
                } else {
                    statusText = 'Owned';
                    statusClass = 'owned';
                }
            } else {
                statusText = `${character.price} GC`;
                statusClass = '';
            }
            
            card.innerHTML = `
                <div class="character-icon">${character.icon}</div>
                <div class="character-name">${character.name}</div>
                <div class="character-status ${statusClass}">${statusText}</div>
            `;
            
            card.onclick = () => showCharacterDetails(character.id);
            
            return card;
        }

        function clearCharacterSearch() {
            document.getElementById('characterSearch').value = '';
            document.getElementById('searchResultsPanel').style.display = 'none';
            document.getElementById('allCharactersPanel').style.display = 'block';
        }

        function populateAllCharacters() {
            const allCharactersContainer = document.getElementById('allCharacters');
            allCharactersContainer.innerHTML = '';
            
            characterDatabase.forEach(character => {
                const characterCard = createCharacterCard(character);
                allCharactersContainer.appendChild(characterCard);
            });
        }

        // User search functionality
        async function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase().trim();
            const userSearchResults = document.getElementById('userSearchResults');
            const userResultsList = document.getElementById('userResultsList');
            
            console.log('üîç searchUsers called with term:', searchTerm);
            
            if (searchTerm === '') {
                userSearchResults.style.display = 'none';
                return;
            }
            
            console.log('üîç Searching for users:', searchTerm);
            
            // Try Railway API first
            try {
                console.log('üåê Searching Railway API:', `${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(searchTerm)}`);
                
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Railway response status:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Railway search result:', result);
                    
                    let filteredUsers = [];
                    if (result.success && result.users && Array.isArray(result.users)) {
                        // Remove duplicates by using Set
                        const uniqueUsernames = [...new Set(result.users.map(user => user.username))];
                        filteredUsers = uniqueUsernames;
                        console.log('üë• Found Railway users:', filteredUsers);
                    } else {
                        console.log('‚ùå Railway search returned no users or invalid format:', result);
                    }
                    
                    if (filteredUsers.length > 0) {
                        userResultsList.innerHTML = '';
                        for (const username of filteredUsers) {
                            const userCard = await createUserCard(username);
                            userResultsList.appendChild(userCard);
                        }
                        userSearchResults.style.display = 'block';
                        console.log('‚úÖ Showing Railway users in search results');
                        return;
                    } else {
                        console.log('‚ö†Ô∏è Railway search returned empty results, trying fallback');
                    }
                } else {
                    console.log('‚ùå Railway API returned error:', response.status, response.statusText);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Railway search failed:', error.message);
                console.error('Full error:', error);
            }
            
            // No users found
            userResultsList.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                    <div style="font-size: 24px; margin-bottom: 8px;">üë§</div>
                    <div>No registered users found matching "${searchTerm}"</div>
                    <div style="font-size: 12px; margin-top: 8px; color: #999;">
                        Only registered SkyParty users appear in search results
                    </div>
                </div>
            `;
            userSearchResults.style.display = 'block';
        }

        async function createUserCard(username) {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.style.cssText = `
                background: white;
                border: 1px outset #ece9d8;
                padding: 8px;
                text-align: center;
                cursor: pointer;
                transition: all 0.1s ease;
                border-radius: 3px;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            `;
            
            // Get user's avatar based on their character
            const userAvatar = await getUserAvatar(username);
            
            card.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 4px;">${userAvatar}</div>
                <div style="font-weight: bold; color: #1f4e79; font-size: 11px; margin-bottom: 2px;">${username}</div>
                <div style="font-size: 9px; color: #666;">View Profile</div>
            `;
            
            card.onclick = () => viewUserProfile(username);
            
            // Add hover effects
            card.addEventListener('mouseenter', function() {
                this.style.border = '1px outset #316ac5';
                this.style.background = '#f0f8ff';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.border = '1px outset #ece9d8';
                this.style.background = 'white';
            });
            
            return card;
        }


        async function viewUserProfile(username) {
            // Check if this is the current user's profile
            const mappings = await getUsernameMappings();
            const currentUserEmail = currentUser;
            const currentUsername = Object.keys(mappings).find(key => mappings[key] === currentUserEmail);
            
            if (currentUsername && currentUsername.toLowerCase() === username.toLowerCase()) {
                // This is the current user - go to their profile
                showSection('profile');
            } else {
                // This is another user - show their profile modal
                await showUserProfileModal(username);
            }
        }

        async function showUserProfileModal(username) {
            // Generate random stats for demo purposes
            const randomStats = {
                level: Math.floor(Math.random() * 50) + 1,
                gamesPlayed: Math.floor(Math.random() * 500) + 50,
                totalCredits: Math.floor(Math.random() * 5000) + 500,
                joinDate: 'Dec 2024'
            };
            
            // Get user's actual character and avatar
            const userAvatar = await getUserAvatar(username);
            
            // Update modal content
            document.getElementById('userProfileIcon').textContent = userAvatar;
            document.getElementById('userProfileTitle').textContent = `${username}'s Profile`;
            document.getElementById('userProfileAvatar').textContent = userAvatar;
            document.getElementById('userProfileName').textContent = username;
            document.getElementById('userProfileStatus').textContent = 'Online';
            document.getElementById('userProfileLevel').textContent = randomStats.level;
            document.getElementById('userProfileGames').textContent = randomStats.gamesPlayed;
            document.getElementById('userProfileCredits').textContent = `${randomStats.totalCredits} GC`;
            document.getElementById('userProfileJoinDate').textContent = randomStats.joinDate;
            
            // Store current viewed user for action buttons
            window.currentViewedUser = username;
            
            // Show the modal
            document.getElementById('userProfileModal').style.display = 'block';
        }

        function closeUserProfileModal() {
            document.getElementById('userProfileModal').style.display = 'none';
            window.currentViewedUser = null;
        }

        function visitUserBase() {
            const username = window.currentViewedUser;
            if (username) {
                alert(`üè† Visiting ${username}'s Base\n\nThis feature will show ${username}'s base, buildings, and resources.\n\nComing soon!`);
            }
        }

        function sendDirectMessage() {
            const username = window.currentViewedUser;
            if (username) {
                alert(`üí¨ Send Direct Message to ${username}\n\nThis feature will open a chat window to send private messages.\n\nComing soon!`);
            }
        }

        function sendGift() {
            const username = window.currentViewedUser;
            if (username) {
                alert(`üéÅ Send Gift to ${username}\n\nThis feature will allow you to send gifts, credits, or items to ${username}.\n\nComing soon!`);
            }
        }

        function reportUser() {
            const username = window.currentViewedUser;
            if (username) {
                if (confirm(`üö© Report ${username}\n\nAre you sure you want to report this user for inappropriate behavior?\n\nThis action will be reviewed by moderators.`)) {
                    alert(`‚úÖ Report Submitted\n\nThank you for reporting ${username}. Our moderation team will review this report.\n\nYou can continue using SkyParty normally.`);
                }
            }
        }

        function addFriend() {
            const username = window.currentViewedUser;
            if (username) {
                if (confirm(`üë• Send Friend Request to ${username}\n\nThis will send a friend request to ${username}. They will be notified and can accept or decline your request.\n\nDo you want to send this friend request?`)) {
                    alert(`‚úÖ Friend Request Sent!\n\nYour friend request has been sent to ${username}.\n\nThey will be notified and can accept your request when they're online.\n\nYou can check your friend requests in the Friends section.`);
                }
            }
        }

        function clearUserSearch() {
            document.getElementById('userSearch').value = '';
            document.getElementById('userSearchResults').style.display = 'none';
        }

        // Add event listeners to clear errors when user types
        // Initialize UI to logged-out state
        function initializeUI() {
            console.log('üîß Initializing UI to logged-out state');
            
            // Set initial state
            isLoggedIn = false;
            currentUser = '';
            currentUserId = null;
            gameCredits = 0;
            isActivated = false;
            
            // Show login panel and hide profile panel
            const loginPanel = document.getElementById('login');
            const profilePanel = document.getElementById('profile');
            if (loginPanel) loginPanel.classList.add('active');
            if (profilePanel) profilePanel.classList.remove('active');
            
            // Update user info to logged-out state
            const userInfo = document.getElementById('userInfo');
            if (userInfo) {
                userInfo.innerHTML = `
                    <div class="user-info-avatar" id="userInfoAvatar">üë§</div>
                    <div><strong>User:</strong> Not logged in</div>
                    <div><strong>Status:</strong> Offline</div>
                `;
                userInfo.classList.remove('logged-in');
            }
            
            // Hide all sidebar navigation except login
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.style.display = 'none';
                item.classList.remove('active');
            });
            const loginSidebarItem = document.getElementById('loginSidebarItem');
            if (loginSidebarItem) {
                loginSidebarItem.style.display = 'block';
                loginSidebarItem.classList.add('active');
            }
            
            // Hide profile sidebar item
            const profileSidebarItem = document.getElementById('profileSidebarItem');
            if (profileSidebarItem) {
                profileSidebarItem.style.display = 'none';
            }
            
            // Hide logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.style.display = 'none';
            }
            
            // Hide Quick Access section
            const quickAccessSection = document.querySelectorAll('.sidebar-section')[1];
            if (quickAccessSection) {
                quickAccessSection.style.display = 'none';
            }
            
            // Change sidebar title to "Account"
            const sidebarTitle = document.getElementById('sidebarTitle');
            if (sidebarTitle) {
                sidebarTitle.textContent = 'Account';
            }
            
            // Hide credits info box
            const creditsInfo = document.getElementById('creditsInfo');
            if (creditsInfo) {
                creditsInfo.style.display = 'none';
            }
            
            // Clear credits display
            const creditsAmount = document.getElementById('creditsAmount');
            const gcBalance = document.getElementById('gcBalance');
            const creditsAmountSidebar = document.getElementById('creditsAmountSidebar');
            if (creditsAmount) creditsAmount.textContent = '0';
            if (gcBalance) gcBalance.textContent = '0 GC';
            if (creditsAmountSidebar) creditsAmountSidebar.textContent = '0 GC';
            
            // Hide DM notification dot
            const notificationDot = document.getElementById('dmNotificationDot');
            if (notificationDot) {
                notificationDot.style.display = 'none';
            }
            
            console.log('‚úÖ UI initialized to logged-out state');
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize UI to logged-out state first
            initializeUI();
            
            // Restore login state if user was previously logged in
            restoreLoginState();
            
            // Test Railway connection on app load
            testRailwayConnection().then(isConnected => {
                if (isConnected) {
                    console.log('‚úÖ Railway API connected successfully!');
                    // Test Railway users database
                    testRailwayUsers();
                } else {
                    console.log('‚ö†Ô∏è Railway API not available, using local storage fallback');
                }
            });
            
            // Start avatar synchronization system
            startAvatarSyncSystem();
            
            // Registration fields
            const regFields = ['regUsername', 'regDateOfBirth', 'regEmail', 'regPassword'];
            regFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.addEventListener('input', function() {
                        const fieldName = fieldId.replace('reg', '').toLowerCase();
                        if (fieldName === 'dateofbirth') {
                            hideFieldError('date');
                        } else {
                            hideFieldError(fieldName);
                        }
                    });
                }
            });
            
            // Login fields
            const loginFields = ['username', 'password'];
            loginFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.addEventListener('input', function() {
                        hideLoginFieldError(fieldId);
                    });
                }
            });
            
            // Populate all characters on page load
            populateAllCharacters();
        });

        // Avatar Synchronization System
        let avatarSyncInterval = null;
        let lastSyncTime = 0;
        
        function startAvatarSyncSystem() {
            console.log('üîÑ Starting avatar synchronization system...');
            
            // Initial sync on startup
            syncAvatarsFromDatabase();
            
            // Set up periodic sync every 10 seconds
            avatarSyncInterval = setInterval(() => {
                syncAvatarsFromDatabase();
            }, 10000);
            
            console.log('‚úÖ Avatar synchronization system started');
        }
        
        function stopAvatarSyncSystem() {
            if (avatarSyncInterval) {
                clearInterval(avatarSyncInterval);
                avatarSyncInterval = null;
                console.log('‚èπÔ∏è Avatar synchronization system stopped');
            }
        }
        
        async function syncAvatarsFromDatabase() {
            if (!isLoggedIn || !currentUserId) {
                return;
            }
            
            try {
                console.log('üîÑ Syncing avatars from database...');
                
                // Get user data from Railway
                const response = await fetch(`${RAILWAY_API_URL}/api/user/${currentUserId}/data`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        const userData = result.data;
                        
                        // Check if character data has changed
                        if (userData.currentCharacter && userData.currentCharacter !== currentCharacter) {
                            console.log('üîÑ Character changed from', currentCharacter, 'to', userData.currentCharacter);
                            currentCharacter = userData.currentCharacter;
                            updateAvatar();
                        }
                        
                        // Check if owned characters have changed
                        if (userData.ownedCharacters && JSON.stringify(userData.ownedCharacters) !== JSON.stringify(ownedCharacters)) {
                            console.log('üîÑ Owned characters changed:', userData.ownedCharacters);
                            ownedCharacters = userData.ownedCharacters;
                            updateCharacterDatabase();
                            updateCharacterCardStatuses();
                            populateAllCharacters();
                        }
                        
                        // Check if game credits have changed
                        if (userData.gameCredits !== undefined && userData.gameCredits !== gameCredits) {
                            console.log('üîÑ Game credits changed from', gameCredits, 'to', userData.gameCredits);
                            gameCredits = userData.gameCredits;
                            
                            // Update credit displays
                            const creditsAmount = document.getElementById('creditsAmount');
                            const gcBalance = document.getElementById('gcBalance');
                            const creditsAmountSidebar = document.getElementById('creditsAmountSidebar');
                            if (creditsAmount) creditsAmount.textContent = gameCredits;
                            if (gcBalance) gcBalance.textContent = gameCredits + ' GC';
                            if (creditsAmountSidebar) creditsAmountSidebar.textContent = gameCredits + ' GC';
                        }
                        
                        lastSyncTime = Date.now();
                        console.log('‚úÖ Avatar sync completed');
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Avatar sync failed:', error.message);
            }
        }
        
        // Enhanced updateAvatar function that also syncs to database
        function updateAvatar() {
            const character = characterDatabase.find(char => char.id === currentCharacter);
            const avatarEmoji = character ? character.icon : 'üê±';
            
            // Update ALL avatar displays consistently
            updateAllAvatarDisplays(avatarEmoji);
            
            // Store in localStorage for quick access
            localStorage.setItem('userAvatar', avatarEmoji);
            
            // Sync to Railway database if logged in
            if (isLoggedIn && currentUserId) {
                syncAvatarToDatabase();
            }
            
            console.log('üîÑ Updated avatar to:', avatarEmoji, 'for character:', currentCharacter);
        }
        
        async function syncAvatarToDatabase() {
            if (!isLoggedIn || !currentUserId) return;
            
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/user/${currentUserId}/data`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentCharacter: currentCharacter,
                        ownedCharacters: ownedCharacters,
                        gameCredits: gameCredits
                    })
                });
                
                if (response.ok) {
                    console.log('‚úÖ Avatar synced to database');
                } else {
                    console.log('‚ö†Ô∏è Failed to sync avatar to database');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Error syncing avatar to database:', error.message);
            }
        }
        
        // Enhanced selectCharacter function that triggers sync
        async function selectCharacter(characterName) {
            if (!isLoggedIn) {
                alert('Please login first to select characters.');
                return;
            }
            
            console.log('üé≠ Selecting character:', characterName);
            currentCharacter = characterName;
            
            // Update avatar immediately
            updateAvatar();
            
            // Update character database
            updateCharacterDatabase();
            
            // Update all character cards to show correct status
            updateCharacterCardStatuses();
            
            // Refresh character cards to show updated status
            populateAllCharacters();
            
            // Save character data
            await saveCharacterData();
            
            // Sync to database immediately
            await syncAvatarToDatabase();
            
            console.log('‚úÖ Character selected successfully:', characterName);
            
            alert(`üéÆ ${characterName.charAt(0).toUpperCase() + characterName.slice(1)} selected!\n\nYour avatar has been updated to ${characterName}!`);
            
            // Close the modal
            closeCharacterDetailsModal();
        }

        function updateCharacterCardStatuses() {
            const characterCards = document.querySelectorAll('.character-card');
            characterCards.forEach(card => {
                const cardName = card.querySelector('.character-name').textContent.toLowerCase();
                const statusElement = card.querySelector('.character-status');
                
                // Find character in database to get the correct price
                const character = characterDatabase.find(char => char.id === cardName);
                
                if (cardName === currentCharacter) {
                    statusElement.textContent = 'Selected';
                    statusElement.className = 'character-status selected';
                } else if (ownedCharacters.includes(cardName)) {
                    statusElement.textContent = 'Owned';
                    statusElement.className = 'character-status owned';
                } else {
                    // Reset to original price for non-owned characters
                    if (character) {
                        statusElement.textContent = `${character.price} GC`;
                        statusElement.className = 'character-status';
                    }
                }
            });
        }

        async function purchaseCharacter(characterName) {
            if (!isLoggedIn) {
                alert('Please login first to purchase characters.');
                return;
            }
            
            const character = characterDatabase.find(char => char.id === characterName);
            if (!character) return;
            
            const price = character.price;
            
            if (gameCredits >= price) {
                if (confirm(`Purchase ${character.name} for ${price} GC?\n\nThis will unlock the ${character.name} character.`)) {
                    gameCredits -= price;
                    ownedCharacters.push(characterName);
                    
                    // Add character to inventory
                    const newInventoryItem = {
                        id: `character_${characterName}_${Date.now()}`,
                        type: 'character',
                        name: character.name,
                        icon: character.icon,
                        description: character.description,
                        price: character.price,
                        acquiredDate: new Date().toISOString(),
                        source: 'purchase',
                        quantity: 1
                    };
                    
                    inventoryItems.push(newInventoryItem);
                    saveInventory();
                    
                    // Update character in database
                    character.owned = true;
                    
                    // Update credit displays
                    document.getElementById('creditsAmount').textContent = gameCredits;
                    document.getElementById('gcBalance').textContent = gameCredits + ' GC';
                    document.getElementById('creditsAmountSidebar').textContent = gameCredits + ' GC';
                    
                    // Update character card statuses
                    updateCharacterCardStatuses();
                    
                    // Update inventory UI
                    updateInventoryUI();
                    
                    // Update the character details in the modal to show "Owned"
                    document.getElementById('characterDetailStatus').textContent = 'Owned';
                    
                    // Update quantity display
                    const characterQuantity = inventoryItems.filter(item =>
                        item.type === 'character' && item.name === character.name
                    ).length;
                    
                    const priceReminder = characterQuantity > 0 ? `Price: ${character.price} GC` : '';
                    document.getElementById('characterDetailQuantity').innerHTML =
                        characterQuantity > 0 ?
                        `Quantity: ${characterQuantity}<br><span style="color: #999; font-size: 10px;">${priceReminder}</span>` :
                        'Quantity: 0';
                    
                    // Update the character details modal buttons
                    const modalButtons = document.querySelector('#characterDetailsModal .modal-buttons');
                    if (modalButtons) {
                        // Clear existing buttons
                        modalButtons.innerHTML = '';
                        
                        // Add Cancel button
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'xp-button';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => closeCharacterDetailsModal();
                        modalButtons.appendChild(cancelBtn);
                        
                        // Add Select button with proper ID
                        const selectBtn = document.createElement('button');
                        selectBtn.className = 'xp-button';
                        selectBtn.id = 'characterSelectBtn';
                        selectBtn.textContent = 'Select';
                        selectBtn.onclick = () => selectCharacter(characterName).catch(console.error);
                        modalButtons.appendChild(selectBtn);
                        
                        // Add Gift button with proper ID
                        const giftBtn = document.createElement('button');
                        giftBtn.className = 'xp-button primary';
                        giftBtn.id = 'characterGiftBtn';
                        giftBtn.textContent = 'Gift';
                        giftBtn.onclick = () => giftCharacter(characterName);
                        modalButtons.appendChild(giftBtn);
                    }
                    
                    // Save character data
                    await saveCharacterData();
                    
                    alert(`‚úÖ Purchase Successful!\n\n${character.name} character unlocked!\n\nRemaining Credits: ${gameCredits} GC`);
                }
            } else {
                alert(`‚ùå Insufficient Credits\n\nYou need ${price} GC to purchase ${character.name}.\n\nCurrent Credits: ${gameCredits} GC`);
            }
        }

        async function purchaseCharacterAgain(characterName) {
            const character = characterDatabase.find(char => char.id === characterName);
            if (!character) return;
            
            const price = character.price;
            
            if (gameCredits >= price) {
                gameCredits -= price;
                
                // Add another instance to inventory directly
                const newInventoryItem = {
                    id: `character_${characterName}_${Date.now()}`,
                    type: 'character',
                    name: character.name,
                    icon: character.icon,
                    description: character.description,
                    price: character.price,
                    acquiredDate: new Date().toISOString(),
                    source: 'purchase',
                    quantity: 1
                };
                
                inventoryItems.push(newInventoryItem);
                saveInventory();
                
                // Update credit displays
                document.getElementById('creditsAmount').textContent = gameCredits;
                document.getElementById('gcBalance').textContent = gameCredits + ' GC';
                document.getElementById('creditsAmountSidebar').textContent = gameCredits + ' GC';
                
                // Update inventory UI
                updateInventoryUI();
                
                // Save character data
                await saveCharacterData();
                
                // Update the character details modal to show new quantity immediately
                const characterQuantity = inventoryItems.filter(item => 
                    item.type === 'character' && item.name === character.name
                ).length;
                
                // Update quantity display with price reminder
                const priceReminder = characterQuantity > 0 ? `Price: ${character.price} GC` : '';
                document.getElementById('characterDetailQuantity').innerHTML = 
                    characterQuantity > 0 ? 
                    `Quantity: ${characterQuantity}<br><span style="color: #999; font-size: 10px;">${priceReminder}</span>` : 
                    'Quantity: 0';
                
                alert(`‚úÖ Purchase Successful!\n\nAnother ${character.name} character added to inventory!\n\nRemaining Credits: ${gameCredits} GC`);
            } else {
                alert(`‚ùå Insufficient Credits\n\nYou need ${price} GC to purchase another ${character.name}.\n\nCurrent Credits: ${gameCredits} GC`);
            }
        }

        function giftCharacter(characterName) {
            const character = characterDatabase.find(char => char.id === characterName);
            if (!character) return;
            
            // Prevent gifting the default kitty character
            if (characterName === 'kitty') {
                alert('‚ùå You cannot gift the default Kitty character.');
                return;
            }
            
            // Check if current user has this character
            const characterQuantity = inventoryItems.filter(item => 
                item.type === 'character' && item.name === character.name
            ).length;
            
            if (characterQuantity === 0) {
                alert('‚ùå You don\'t have this character in your inventory to gift.');
                return;
            }
            
            // Store the character to gift
            window.giftCharacterData = {
                name: character.name,
                icon: character.icon,
                description: character.description,
                price: character.price,
                id: characterName
            };
            
            // Close character details modal and open gift sending modal
            closeCharacterDetailsModal();
            openGiftSendingModal();
        }

        function selectCharacterFromInventory() {
            // This will be called when clicking Select from inventory
            const characterName = window.currentInventoryCharacter;
            if (characterName) {
                selectCharacter(characterName);
                closeCharacterDetailsModal();
            }
        }

        function giftCharacterFromInventory() {
            // This will be called when clicking Gift from inventory
            const characterName = window.currentInventoryCharacter;
            if (characterName) {
                // Prevent gifting the default kitty character
                if (characterName === 'kitty') {
                    alert('‚ùå You cannot gift the default Kitty character.');
                    closeCharacterDetailsModal();
                    return;
                }
                giftCharacter(characterName);
                closeCharacterDetailsModal();
            }
        }

        function showCharacterDetailsFromInventory(characterName) {
            let character;
            if (characterName === 'kitty') {
                // Special case for Kitty since it's not in characterDatabase anymore
                character = {
                    id: 'kitty',
                    name: 'Kitty',
                    icon: 'üê±',
                    price: 0,
                    description: 'A cute and friendly kitty character. Perfect for beginners!'
                };
            } else {
                character = characterDatabase.find(char => char.id === characterName);
            }
            
            if (!character) return;

            // Update modal title bar
            document.getElementById('characterModalIcon').textContent = character.icon;
            document.getElementById('characterModalTitle').textContent = character.name;

            // Update character details
            document.getElementById('characterDetailIcon').textContent = character.icon;
            document.getElementById('characterDetailName').textContent = character.name;
            document.getElementById('characterDetailStatus').textContent = 'Owned';
            document.getElementById('characterDetailDescription').textContent = character.description;
            
            // Calculate quantity in inventory
            const characterQuantity = inventoryItems.filter(item => 
                item.type === 'character' && item.name === character.name
            ).length;
            
            // Update quantity display (no price reminder for inventory)
            document.getElementById('characterDetailQuantity').textContent = 
                characterQuantity > 0 ? `Quantity: ${characterQuantity}` : 'Quantity: 0';
            
            // Update action buttons for inventory (only Select and Gift)
            const selectBtn = document.getElementById('characterSelectBtn');
            const giftBtn = document.getElementById('characterGiftBtn');
            
            selectBtn.textContent = currentCharacter === characterName ? 'Selected' : 'Select';
            selectBtn.onclick = () => selectCharacterFromInventory();
            
            giftBtn.textContent = 'Gift';
            giftBtn.onclick = () => giftCharacterFromInventory();
            giftBtn.style.display = 'inline-block';

            // Show the modal
            document.getElementById('characterDetailsModal').style.display = 'block';
        }

        function handleCharacterAction() {
            // This function is called by the dynamic button onclick
            // The actual action is set in showCharacterDetails()
        }

        // Instagram-Style Direct Messages System
        let selectedDMRecipient = null;
        let currentConversation = null;
        let conversations = [];
        
        // Function to open the DM modal
        function openDM() {
            console.log('üì± Opening DM modal...');
            const dmModal = document.getElementById('dmModal');
            if (dmModal) {
                dmModal.style.display = 'block';
                console.log('üì± DM modal opened');
                
                // Load conversations when opening DM
                loadConversations().catch(console.error);
            } else {
                console.error('‚ùå DM modal not found');
            }
        }

        function closeDMModal() {
            document.getElementById('dmModal').style.display = 'none';
            selectedDMRecipient = null;
            currentConversation = null;
            showWelcomeScreen();
        }

        function showWelcomeScreen() {
            document.getElementById('dmWelcomeScreen').style.display = 'flex';
            document.getElementById('dmChatInterface').style.display = 'none';
            currentConversation = null;
            
            // Stop checking for new messages when leaving chat
            stopMessageChecking();
        }

        async function showChatInterface(conversationId) {
            console.log('üîÑ showChatInterface called with:', conversationId);
            
            // Hide welcome screen and show chat interface
            const welcomeScreen = document.getElementById('dmWelcomeScreen');
            const chatInterface = document.getElementById('dmChatInterface');
            
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
                console.log('üîÑ Welcome screen hidden');
            }
            
            if (chatInterface) {
                chatInterface.style.display = 'flex';
                console.log('üîÑ Chat interface shown');
            }
            
            // Find the conversation in the conversations array
            let conversation = conversations.find(conv => conv.id === conversationId);
            console.log('üîÑ Found conversation in array:', conversation);
            
            // If not found in array, try to load it directly from localStorage
            if (!conversation) {
                conversation = getConversation(conversationId);
                console.log('üîÑ Loaded conversation from localStorage:', conversation);
                if (conversation) {
                    // Add it to the conversations array
                    conversations.push(conversation);
                    console.log('üîÑ Added conversation to array');
                }
            }
            
            if (!conversation) {
                console.error('üîÑ Conversation not found:', conversationId);
                showWelcomeScreen();
                return;
            }
            
            currentConversation = conversation;
            console.log('üîÑ Set current conversation:', currentConversation);
            
            // Mark conversation as read when chat interface is shown
            markConversationAsRead(conversationId);
            
            // Update chat header
            const otherUser = await getOtherUserInConversation(conversation);
            console.log('üîÑ Other user:', otherUser);
            console.log('üîÑ Other user type:', typeof otherUser);
            console.log('üîÑ Conversation participants:', conversation.participants);
            console.log('üîÑ Current username from getCurrentUsername:', await getCurrentUsername());
            
            const chatAvatar = document.getElementById('dmChatAvatar');
            const chatName = document.getElementById('dmChatName');
            
            if (chatAvatar && otherUser) {
                const avatar = await getUserAvatar(otherUser);
                console.log('üîÑ Got avatar:', avatar);
                console.log('üîÑ Avatar type:', typeof avatar);
                chatAvatar.textContent = avatar;
                console.log('üîÑ Updated chat avatar');
            } else {
                console.log('üîÑ Chat avatar not updated - chatAvatar:', chatAvatar, 'otherUser:', otherUser);
            }
            
            if (chatName && otherUser) {
                chatName.textContent = otherUser;
                console.log('üîÑ Updated chat name');
            } else {
                console.log('üîÑ Chat name not updated - chatName:', chatName, 'otherUser:', otherUser);
            }
            
            // Load messages for this conversation
            console.log('üîÑ About to load messages for conversation:', conversationId);
            await loadConversationMessages(conversationId);
            console.log('üîÑ Loaded conversation messages');
            
            // Start checking for new messages
            startMessageChecking();
        }

        async function loadDMMessages() {
            console.log('üîÑ loadDMMessages called - loading DM messages...');
            try {
                await loadConversations();
                updateDMNotificationDot();
                console.log('üîÑ DM messages loaded successfully');
            } catch (error) {
                console.error('üîÑ Error loading DM messages:', error);
            }
        }

        async function loadConversations() {
            console.log('üîÑ loadConversations called');
            const conversationsList = document.getElementById('dmConversationsList');
            
            // Try to load conversations from Railway first
            if (currentUserId) {
                console.log('üîÑ Loading conversations from Railway for user:', currentUserId);
                const railwayConversations = await getConversationsViaRailway(currentUserId);
                if (railwayConversations && railwayConversations.length > 0) {
                    console.log('‚úÖ Loaded conversations from Railway:', railwayConversations.length);
                    conversations = railwayConversations;
                } else {
                    console.log('‚ö†Ô∏è No conversations from Railway, using local storage');
                    conversations = await getAllConversations();
                }
            } else {
                console.log('‚ö†Ô∏è No currentUserId, using local storage');
                conversations = await getAllConversations();
            }
            
            console.log('üîÑ Loaded conversations:', conversations.length);
            console.log('üîÑ Conversations:', conversations.map(c => ({ id: c.id, messages: c.messages.length })));
            
            if (conversations.length === 0) {
                conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                        <div>No conversations yet</div>
                        <div style="font-size: 10px; margin-top: 8px;">Start a conversation with someone!</div>
                    </div>
                `;
                return;
            }
            
            conversationsList.innerHTML = '';
            for (const conversation of conversations) {
                const conversationElement = await createConversationElement(conversation);
                conversationsList.appendChild(conversationElement);
            }
        }

        async function createConversationElement(conversation) {
            const conversationDiv = document.createElement('div');
            conversationDiv.style.cssText = `
                padding: 12px;
                border-bottom: 1px solid #e0e0e0;
                cursor: pointer;
                transition: background-color 0.1s ease;
                background: white;
                position: relative;
            `;
            
            const otherUser = await getOtherUserInConversation(conversation);
            const otherUserAvatar = await getUserAvatar(otherUser);
            const lastMessage = conversation.messages && conversation.messages.length > 0 ? conversation.messages[conversation.messages.length - 1] : null;
            const lastMessageTime = lastMessage && lastMessage.timestamp ? new Date(lastMessage.timestamp).toLocaleDateString() : 'No messages';
            const hasUnreadMessages = hasUnreadMessagesInConversation(conversation);
            
            conversationDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 20px;">${otherUserAvatar}</span>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: bold; color: #1f4e79; font-size: 11px; margin-bottom: 2px;">${otherUser}</div>
                        <div style="font-size: 10px; color: #666; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${lastMessage ? lastMessage.content : 'No messages yet'}
                        </div>
                    </div>
                    <div style="font-size: 9px; color: #999;">${lastMessageTime}</div>
                </div>
                ${hasUnreadMessages ? '<div class="conversation-notification-dot"></div>' : ''}
            `;
            
            conversationDiv.onclick = () => {
                showChatInterface(conversation.id).catch(console.error);
            };
            
            // Add hover effect
            conversationDiv.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f0f8ff';
            });
            
            conversationDiv.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'white';
            });
            
            return conversationDiv;
        }

        async function loadConversationMessages(conversationId) {
            console.log('üîÑ loadConversationMessages called with:', conversationId);
            const messagesArea = document.getElementById('dmMessagesArea');
            const conversation = conversations.find(conv => conv.id === conversationId);
            
            console.log('üîÑ Found conversation:', conversation);
            console.log('üîÑ Conversation messages:', conversation ? conversation.messages : 'No conversation');
            
            if (!conversation || conversation.messages.length === 0) {
                console.log('üîÑ No messages found, showing empty state');
                messagesArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üí¨</div>
                        <div>No messages yet</div>
                        <div style="font-size: 10px; margin-top: 8px;">Start the conversation!</div>
                    </div>
                `;
                return;
            }
            
            console.log('üîÑ Loading', conversation.messages.length, 'messages');
            messagesArea.innerHTML = '';
            for (const message of conversation.messages) {
                console.log('üîÑ Creating message element for:', message);
                const messageElement = await createChatMessageElement(message);
                messagesArea.appendChild(messageElement);
            }
            
            // Scroll to bottom
            messagesArea.scrollTop = messagesArea.scrollHeight;
            console.log('üîÑ Messages loaded and scrolled to bottom');
        }

        async function createChatMessageElement(message) {
            console.log('üé® Creating message element for:', message);
            const messageDiv = document.createElement('div');
            const currentUsername = await getCurrentUsername();
            
            // Handle both Railway API format and local format
            const messageSender = message.sender || message.senderUsername;
            const isOwnMessage = messageSender === currentUsername;
            
            console.log('üé® Current username:', currentUsername);
            console.log('üé® Message sender:', messageSender);
            console.log('üé® Message object keys:', Object.keys(message));
            console.log('üé® Is own message:', isOwnMessage);
            
            messageDiv.style.cssText = `
                margin-bottom: 8px;
                display: flex;
                ${isOwnMessage ? 'justify-content: flex-end;' : 'justify-content: flex-start;'}
            `;
            
            const messageBubble = document.createElement('div');
            messageBubble.style.cssText = `
                max-width: 70%;
                padding: 8px 12px;
                border-radius: 12px;
                font-size: 11px;
                line-height: 1.4;
                ${isOwnMessage ? 
                    'background: #316ac5; color: white; border-radius: 12px 12px 4px 12px;' : 
                    'background: white; color: #333; border: 1px solid #e0e0e0; border-radius: 12px 12px 12px 4px;'
                }
            `;
            
            messageBubble.textContent = message.content;
            messageDiv.appendChild(messageBubble);
            
            return messageDiv;
        }

        async function searchDMRecipients() {
            const searchTerm = document.getElementById('dmRecipientSearch').value.toLowerCase().trim();
            const recipientResults = document.getElementById('dmRecipientResults');
            const recipientList = document.getElementById('dmRecipientList');
            
            if (searchTerm === '') {
                recipientResults.style.display = 'none';
                return;
            }
            
            console.log('üîç DM Search: Searching for users:', searchTerm);
            
            // Try Railway API first
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ DM Railway search result:', result);
                    
                    let filteredUsers = [];
                    if (result.success && result.users && Array.isArray(result.users)) {
                        filteredUsers = result.users.map(user => user.username);
                        console.log('üë• DM Found Railway users:', filteredUsers);
                    }
                    
                    if (filteredUsers.length > 0) {
                        recipientList.innerHTML = '';
                        for (const username of filteredUsers) {
                            const recipientCard = await createRecipientCard(username);
                            recipientList.appendChild(recipientCard);
                        }
                        recipientResults.style.display = 'block';
                        console.log('‚úÖ DM Showing Railway users in search results');
                        return;
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è DM Railway search failed:', error.message);
            }
            
            // No users found
                recipientList.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 8px;">üë§</div>
                    <div>No registered users found matching "${searchTerm}"</div>
                    <div style="font-size: 12px; margin-top: 8px; color: #999;">
                        Only registered SkyParty users appear in search
                    </div>
                    </div>
                `;
            recipientResults.style.display = 'block';
        }

        async function createRecipientCard(username) {
            const card = document.createElement('div');
            card.className = 'recipient-card';
            card.style.cssText = `
                background: white;
                border: 1px outset #ece9d8;
                padding: 8px;
                text-align: center;
                cursor: pointer;
                transition: all 0.1s ease;
                border-radius: 3px;
                min-height: 50px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            `;
            
            const userAvatar = await getUserAvatar(username);
            
            card.innerHTML = `
                <div style="font-size: 16px; margin-bottom: 4px;">${userAvatar}</div>
                <div style="font-weight: bold; color: #1f4e79; font-size: 10px;">${username}</div>
            `;
            
            card.onclick = () => selectRecipient(username);
            
            // Add hover effects
            card.addEventListener('mouseenter', function() {
                this.style.border = '1px outset #316ac5';
                this.style.background = '#f0f8ff';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.border = '1px outset #ece9d8';
                this.style.background = 'white';
            });
            
            return card;
        }

        async function selectRecipient(username) {
            selectedDMRecipient = username;
            
            // Update selected recipient display
            document.getElementById('dmSelectedRecipientAvatar').textContent = await getUserAvatar(username);
            document.getElementById('dmSelectedRecipientName').textContent = username;
            document.getElementById('dmSelectedRecipient').style.display = 'block';
            
            // Show Start Conversation button
            document.getElementById('startConversationBtn').style.display = 'inline-block';
            
            // Hide search results
            document.getElementById('dmRecipientResults').style.display = 'none';
            document.getElementById('dmRecipientSearch').value = '';
        }

        function clearSelectedRecipient() {
            selectedDMRecipient = null;
            document.getElementById('dmSelectedRecipient').style.display = 'none';
            
            // Hide Start Conversation button
            document.getElementById('startConversationBtn').style.display = 'none';
        }

        function clearDMRecipientSearch() {
            document.getElementById('dmRecipientSearch').value = '';
            document.getElementById('dmRecipientResults').style.display = 'none';
        }

        function showNewMessageComposer() {
            document.getElementById('newMessageModal').style.display = 'block';
        }

        function closeNewMessageModal() {
            document.getElementById('newMessageModal').style.display = 'none';
            clearDMRecipientSearch();
            clearSelectedRecipient();
            
            // Hide Start Conversation button
            document.getElementById('startConversationBtn').style.display = 'none';
            
            // Note: dmInitialMessageText was removed, so no need to clear it
        }

        async function startNewConversation() {
            console.log('=== startNewConversation() CALLED ===');
            
            if (!selectedDMRecipient) {
                alert('Please select a recipient to start a conversation.');
                return;
            }
            
            console.log('Starting new conversation with:', selectedDMRecipient);
            
            // Get current user's username
            const currentUsername = await getCurrentUsername();
            if (!currentUsername) {
                alert('Error: Could not identify current user.');
                return;
            }
            
            console.log('Current username:', currentUsername);
            
            // Create or get existing conversation
            const conversationId = createConversationId(currentUsername, selectedDMRecipient);
            let conversation = getConversation(conversationId);
            
            console.log('Conversation ID:', conversationId);
            console.log('Existing conversation:', conversation);
            
            if (!conversation) {
                conversation = {
                    id: conversationId,
                    participants: [currentUsername, selectedDMRecipient],
                    messages: [],
                    lastActivity: new Date().toISOString()
                };
                
                // Save new conversation
                saveConversation(conversation);
                console.log('Created new conversation:', conversation);
            }
            
            // Close new message modal
            closeNewMessageModal();
            
            // Ensure DM modal is open
            const dmModal = document.getElementById('dmModal');
            if (dmModal) {
                dmModal.style.display = 'block';
                console.log('DM modal opened');
            }
            
            // Refresh conversations and then open the chat
            loadConversations();
            
            // Use setTimeout to ensure conversations array is updated
            setTimeout(() => {
                console.log('Attempting to show chat interface for:', conversationId);
                console.log('Available conversations:', conversations.map(c => c.id));
                showChatInterface(conversationId).catch(console.error);
            }, 100);
        }

        async function sendChatMessage() {
            if (!currentConversation) {
                alert('No active conversation.');
                return;
            }
            
            const messageText = document.getElementById('dmMessageText').value.trim();
            if (!messageText) {
                alert('Please enter a message.');
                return;
            }
            
            // Get current user's username
            const currentUsername = await getCurrentUsername();
            if (!currentUsername) {
                alert('Error: Could not identify current user.');
                return;
            }
            
            // Create message object
            const message = {
                id: Date.now().toString(),
                sender: currentUsername,
                recipient: await getOtherUserInConversation(currentConversation),
                content: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            console.log('üìù Created message:', message);
            console.log('üìù Current conversation before adding message:', currentConversation);
            
            // Get recipient user ID from username
            const recipientUserId = await getUserIdFromUsername(message.recipient);
            if (!recipientUserId) {
                console.error('‚ùå Could not find recipient user ID for:', message.recipient);
                alert('Error: Could not find recipient user.');
                return;
            }
            
            // Send message via Railway API
            const railwayMessage = await sendMessageViaRailway(
                currentUserId, // senderId
                recipientUserId, // recipientId (user ID)
                messageText, // content
                currentConversation.id // conversationId
            );
            
            if (railwayMessage) {
                console.log('‚úÖ Message sent via Railway successfully');
                
                // Add message to local conversation for immediate display
            currentConversation.messages.push(message);
            currentConversation.lastActivity = new Date().toISOString();
            
                console.log('üìù Current conversation after adding message:', currentConversation);
                console.log('üìù Messages count:', currentConversation.messages.length);
                
                // Save conversation locally (for offline fallback)
            saveConversation(currentConversation);
            
            // Update the conversations array to reflect the new message
            const conversationIndex = conversations.findIndex(conv => conv.id === currentConversation.id);
                console.log('üîÑ Conversation index in array:', conversationIndex);
                console.log('üîÑ Total conversations in array:', conversations.length);
            if (conversationIndex !== -1) {
                conversations[conversationIndex] = currentConversation;
                    console.log('üîÑ Updated conversation in array');
                } else {
                    console.log('üîÑ Conversation not found in array, adding it');
                    conversations.push(currentConversation);
            }
            
            // Clear input and refresh messages
            document.getElementById('dmMessageText').value = '';
                console.log('üîÑ About to call loadConversationMessages with ID:', currentConversation.id);
                await loadConversationMessages(currentConversation.id);
                console.log('üîÑ loadConversationMessages completed');
            
            // Refresh conversations list to update last message
                await loadConversations();
            } else {
                console.error('‚ùå Failed to send message via Railway');
                alert('Failed to send message. Please try again.');
            }
        }

        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function searchConversations() {
            const searchTerm = document.getElementById('dmConversationSearch').value.toLowerCase().trim();
            const conversationsList = document.getElementById('dmConversationsList');
            
            if (searchTerm === '') {
                await loadConversations();
                return;
            }
            
            const filteredConversations = [];
            for (const conversation of conversations) {
                const otherUser = await getOtherUserInConversation(conversation);
                if (otherUser && otherUser.toLowerCase().includes(searchTerm)) {
                    filteredConversations.push(conversation);
                }
            }
            
            if (filteredConversations.length === 0) {
                conversationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                        <div>No conversations found</div>
                        <div style="font-size: 10px; margin-top: 8px;">Try a different search term</div>
                    </div>
                `;
                return;
            }
            
            conversationsList.innerHTML = '';
            for (const conversation of filteredConversations) {
                const conversationElement = await createConversationElement(conversation);
                conversationsList.appendChild(conversationElement);
            }
        }

        // Helper functions
        async function getCurrentUsername() {
            // Try to get username from Railway login state first
            try {
                const loginState = await loadData('loginState');
                if (loginState && loginState.isLoggedIn && loginState.username) {
                    console.log('‚úÖ Got username from login state:', loginState.username);
                    return loginState.username;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not load login state:', error);
            }
            
            // Fallback: Try to get from Railway API using currentUserId
            if (currentUserId) {
                try {
                    const response = await fetch(`${RAILWAY_API_URL}/api/user/${currentUserId}/data`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.data && result.data.username) {
                            console.log('‚úÖ Got username from Railway API:', result.data.username);
                            return result.data.username;
                        }
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Could not get username from Railway API:', error);
                }
            }
            
            // Last fallback: Try local mappings (for backward compatibility)
            try {
                const mappings = await getUsernameMappings();
                const username = Object.keys(mappings).find(key => mappings[key] === currentUser);
                if (username) {
                    console.log('‚ö†Ô∏è Got username from local mappings (fallback):', username);
                    return username;
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not get username from local mappings:', error);
            }
            
            console.log('‚ùå Could not identify current user');
            return null;
        }


        function createConversationId(user1, user2) {
            // Create a consistent conversation ID regardless of order
            return [user1, user2].sort().join('_');
        }

        function getConversation(conversationId) {
            const conversationData = localStorage.getItem(`conversation_${conversationId}`);
            return conversationData ? JSON.parse(conversationData) : null;
        }

        function saveConversation(conversation) {
            localStorage.setItem(`conversation_${conversation.id}`, JSON.stringify(conversation));
        }

        async function getAllConversations() {
            const conversations = [];
            const currentUsername = await getCurrentUsername();
            
            console.log('üîÑ getAllConversations - Current username:', currentUsername);
            
            // Clean up corrupted read status data first
            cleanupCorruptedReadStatus();
            
            // Get all conversation keys from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Only process actual conversation data, not read status data
                if (key.startsWith('conversation_') && !key.startsWith('conversation_read_')) {
                    try {
                        const conversationData = localStorage.getItem(key);
                        if (conversationData) {
                            const conversation = JSON.parse(conversationData);
                            console.log('üîÑ Checking conversation:', conversation.id, 'participants:', conversation.participants);
                            if (conversation && conversation.participants && conversation.participants.includes(currentUsername)) {
                                console.log('üîÑ Adding conversation:', conversation.id);
                                conversations.push(conversation);
                            }
                        }
                    } catch (error) {
                        console.error('Error parsing conversation data for key:', key, error);
                        // Remove corrupted data
                        localStorage.removeItem(key);
                        console.log('Removed corrupted conversation data:', key);
                    }
                }
            }
            
            // Sort by last activity (most recent first)
            return conversations.sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity));
        }

        function hasUnreadMessagesInConversation(conversation) {
            const currentUsername = getCurrentUsername();
            
            // If no messages array or empty messages, no unread
            if (!conversation.messages || conversation.messages.length === 0) {
                console.log(`Conversation ${conversation.id}: No messages, not unread`);
                return false;
            }
            
            const lastMessage = conversation.messages[conversation.messages.length - 1];
            
            // If there are no messages, no unread
            if (!lastMessage) {
                console.log(`Conversation ${conversation.id}: No last message, not unread`);
                return false;
            }
            
            // If the last message is from the current user, no unread
            if (lastMessage.sender === currentUsername) {
                console.log(`Conversation ${conversation.id}: Last message from current user, not unread`);
                return false;
            }
            
            // Check if the conversation has been marked as read
            const readStatus = localStorage.getItem(`conversation_read_${conversation.id}`);
            if (!readStatus) {
                console.log(`Conversation ${conversation.id}: No read status, considered unread`);
                return true; // If no read status, consider unread
            }
            
            const lastReadTime = new Date(readStatus);
            const lastMessageTime = new Date(lastMessage.timestamp);
            const isUnread = lastMessageTime > lastReadTime;
            
            console.log(`Conversation ${conversation.id}:`);
            console.log('- Last message time:', lastMessageTime);
            console.log('- Last read time:', lastReadTime);
            console.log('- Is unread:', isUnread);
            
            return isUnread;
        }

        function markConversationAsRead(conversationId) {
            console.log('=== MARKING CONVERSATION AS READ ===');
            console.log('Conversation ID:', conversationId);
            
            // Clean up any corrupted read status data first
            cleanupCorruptedReadStatus();
            
            const readTime = new Date().toISOString();
            localStorage.setItem(`conversation_read_${conversationId}`, readTime);
            console.log('Set read time:', readTime);
            
            // Refresh conversations list to update individual conversation dots
            try {
                loadConversations();
            } catch (error) {
                console.error('Error loading conversations after marking as read:', error);
                // Try to clean up and reload
                cleanupCorruptedConversations();
                loadConversations();
            }
            
            // Update profile DM notification dot
            updateDMNotificationDot();
            
            console.log('Conversation marked as read and UI updated');
        }

        function updateDMNotificationDot() {
            const notificationDot = document.getElementById('dmNotificationDot');
            const hasUnreadConversations = conversations.some(conv => hasUnreadMessagesInConversation(conv));
            
            console.log('=== UPDATING PROFILE DM DOT ===');
            console.log('Notification dot element:', notificationDot);
            console.log('Has unread conversations:', hasUnreadConversations);
            console.log('Conversations count:', conversations.length);
            
            conversations.forEach(conv => {
                const hasUnread = hasUnreadMessagesInConversation(conv);
                console.log(`- Conversation ${conv.id}: hasUnread = ${hasUnread}`);
            });
            
            if (hasUnreadConversations) {
                notificationDot.style.display = 'block';
                console.log('Profile DM dot set to visible');
            } else {
                notificationDot.style.display = 'none';
                console.log('Profile DM dot set to hidden');
            }
            
            console.log('Profile DM dot final display:', notificationDot.style.display);
        }

        // Check for new messages periodically
        let messageCheckInterval = null;
        
        function startMessageChecking() {
            if (messageCheckInterval) {
                clearInterval(messageCheckInterval);
            }
            
            // Check for new messages every 3 seconds
            messageCheckInterval = setInterval(async () => {
                if (currentConversation && currentUserId) {
                    console.log('üîÑ Checking for new messages...');
                    await refreshCurrentConversation();
                }
            }, 3000);
            
            console.log('‚úÖ Started message checking interval');
        }
        
        function stopMessageChecking() {
            if (messageCheckInterval) {
                clearInterval(messageCheckInterval);
                messageCheckInterval = null;
                console.log('‚èπÔ∏è Stopped message checking interval');
            }
        }
        
        async function refreshCurrentConversation() {
            if (!currentConversation || !currentUserId) return;
            
            try {
                console.log('üîÑ Refreshing current conversation:', currentConversation.id);
                
                // Get updated conversations from Railway
                const railwayConversations = await getConversationsViaRailway(currentUserId);
                if (railwayConversations && railwayConversations.length > 0) {
                    // Find the current conversation in the updated data
                    const updatedConversation = railwayConversations.find(conv => conv.id === currentConversation.id);
                    if (updatedConversation) {
                        const oldMessageCount = currentConversation.messages.length;
                        const newMessageCount = updatedConversation.messages.length;
                        
                        if (newMessageCount > oldMessageCount) {
                            console.log(`üîÑ Found ${newMessageCount - oldMessageCount} new messages!`);
                            console.log('üîÑ Old messages:', currentConversation.messages.length);
                            console.log('üîÑ New messages:', updatedConversation.messages.length);
                            
                            // Update the current conversation
                            currentConversation.messages = updatedConversation.messages;
                            currentConversation.lastActivity = updatedConversation.lastActivity;
                            
                            console.log('üîÑ Updated currentConversation.messages:', currentConversation.messages.length);
                            
                            // Update conversations list first
                            const conversationIndex = conversations.findIndex(conv => conv.id === currentConversation.id);
                            if (conversationIndex !== -1) {
                                conversations[conversationIndex] = currentConversation;
                                console.log('üîÑ Updated conversations array');
                            }
                            
                            // Clear and reload the messages display
                            console.log('üîÑ About to reload messages display...');
                            const messagesArea = document.getElementById('dmMessagesArea');
                            if (messagesArea) {
                                messagesArea.innerHTML = '';
                                console.log('üîÑ Cleared messages area');
                                
                                // Reload all messages
                                for (const message of currentConversation.messages) {
                                    console.log('üîÑ Creating message element for:', message.content);
                                    const messageElement = await createChatMessageElement(message);
                                    messagesArea.appendChild(messageElement);
                                }
                                
                                // Scroll to bottom
                                messagesArea.scrollTop = messagesArea.scrollHeight;
                                console.log('üîÑ Messages reloaded and scrolled to bottom');
                            }
                            
                            // Refresh conversations list UI
                            await loadConversations();
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Error refreshing conversation:', error);
            }
        }

        function checkForNewMessages() {
            // This function can be called periodically to check for new messages
            // For now, we'll call it when loading conversations
            loadConversations();
            updateDMNotificationDot();
        }

        // Get the other user in a conversation (not the current user)
        async function getOtherUserInConversation(conversation) {
            console.log('üîç getOtherUserInConversation called with:', conversation);
            
            if (!conversation || !conversation.participants || !Array.isArray(conversation.participants)) {
                console.error('‚ùå Invalid conversation object:', conversation);
                return 'Unknown User';
            }
            
            const currentUsername = await getCurrentUsername();
            console.log('üîç Current username:', currentUsername);
            console.log('üîç Conversation participants:', conversation.participants);
            
            // Find the participant that is NOT the current user
            const otherUser = conversation.participants.find(participant => {
                // Handle different data formats
                if (typeof participant === 'string') {
                    return participant !== currentUsername;
                } else if (typeof participant === 'object' && participant.username) {
                    return participant.username !== currentUsername;
                } else if (typeof participant === 'number') {
                    // Handle case where participant is a user ID
                    return participant !== currentUserId;
                }
                return false;
            });
            
            console.log('üîç Found other user:', otherUser);
            
            // Return the other user, handling different formats
            if (typeof otherUser === 'string') {
                return otherUser;
            } else if (typeof otherUser === 'object' && otherUser.username) {
                return otherUser.username;
            } else if (typeof otherUser === 'number') {
                // If we have a user ID, try to get the username
                // For now, return the ID as string - this could be improved
                return `User${otherUser}`;
            }
            
            console.error('‚ùå Could not determine other user in conversation:', conversation);
            return 'Unknown User';
        }

        // Function to clean up corrupted read status data
        function cleanupCorruptedReadStatus() {
            console.log('=== CLEANING UP CORRUPTED READ STATUS ===');
            let cleanedCount = 0;
            
            // Get all read status keys from localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('conversation_read_')) {
                    try {
                        const readData = localStorage.getItem(key);
                        if (readData) {
                            // Try to parse as date
                            new Date(readData);
                            console.log('Valid read status:', key);
                        }
                    } catch (error) {
                        console.log('Removing corrupted read status:', key);
                        localStorage.removeItem(key);
                        cleanedCount++;
                    }
                }
            }
            
            console.log(`Cleaned up ${cleanedCount} corrupted read status entries`);
            return cleanedCount;
        }

        // Manual cleanup function for all corrupted data
        function cleanupAllCorruptedData() {
            console.log('=== CLEANING UP ALL CORRUPTED DATA ===');
            let totalCleaned = 0;
            
            // Clean up corrupted conversations
            totalCleaned += cleanupCorruptedConversations();
            
            // Clean up corrupted read status
            totalCleaned += cleanupCorruptedReadStatus();
            
            console.log(`Total cleaned up: ${totalCleaned} corrupted entries`);
            
            // Refresh conversations
            loadConversations();
            updateDMNotificationDot();
            
            return totalCleaned;
        }

        // Function to manually check and update profile DM dot
        function checkProfileDMDot() {
            console.log('=== CHECKING PROFILE DM DOT ===');
            
            // Check if the dot element exists
            const profileDot = document.getElementById('dmNotificationDot');
            console.log('Profile DM dot element:', profileDot);
            
            if (!profileDot) {
                console.error('Profile DM dot element not found!');
                return;
            }
            
            // Check current display
            console.log('Current display:', profileDot.style.display);
            console.log('Computed display:', window.getComputedStyle(profileDot).display);
            
            // Force update
            updateDMNotificationDot();
            
            // Check again after update
            console.log('After update - display:', profileDot.style.display);
            console.log('After update - computed:', window.getComputedStyle(profileDot).display);
        }

        // Debug function to check notification status
        function debugNotifications() {
            console.log('=== DEBUGGING NOTIFICATIONS ===');
            console.log('All conversations:', conversations);
            
            conversations.forEach(conv => {
                const hasUnread = hasUnreadMessagesInConversation(conv);
                const readStatus = localStorage.getItem(`conversation_read_${conv.id}`);
                console.log(`Conversation ${conv.id}:`);
                console.log('- Has unread messages:', hasUnread);
                console.log('- Read status:', readStatus);
                console.log('- Messages count:', conv.messages ? conv.messages.length : 0);
                if (conv.messages && conv.messages.length > 0) {
                    const lastMessage = conv.messages[conv.messages.length - 1];
                    console.log('- Last message:', lastMessage);
                }
            });
            
            const profileDot = document.getElementById('dmNotificationDot');
            console.log('Profile DM dot display:', profileDot.style.display);
        }

        // Mailbox System
        let mailboxItems = [];

        async function loadMailbox() {
            if (!currentUser || !currentUserId) return;

            try {
                console.log('üìÆ Loading mailbox from database for user:', currentUserId);
                
                const response = await fetch(`${RAILWAY_API_URL}/api/user/${currentUserId}/gifts`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.gifts) {
                        // Convert database gifts to mailbox format
                        mailboxItems = result.gifts.map(gift => ({
                            id: gift.id.toString(),
                            sender: gift.sender_username,
                            recipient: currentUser,
                            itemType: gift.item_type,
                            itemData: {
                                name: gift.item_name,
                                icon: gift.item_icon,
                                description: gift.item_description,
                                price: gift.item_price
                            },
                            message: gift.message,
                            timestamp: gift.created_at,
                            read: false, // Will be updated when user opens the gift
                            claimed: gift.status === 'claimed'
                        }));
                        
                        console.log('üìÆ Loaded', mailboxItems.length, 'gifts from database');
                    } else {
                        console.log('üìÆ No gifts found in database');
                        mailboxItems = [];
                    }
                } else {
                    console.error('‚ùå Failed to load mailbox from database');
                    mailboxItems = [];
                }
            } catch (error) {
                console.error('‚ùå Error loading mailbox:', error);
                mailboxItems = [];
            }

            updateMailboxUI();
            updateMailboxNotificationDot();
        }

        function saveMailbox() {
            if (!currentUser) return;

            localStorage.setItem(`mailbox_${currentUser}`, JSON.stringify(mailboxItems));
        }

        function addMailItem(sender, itemType, itemData, message = '') {
            if (!currentUser) return;

            const mailItem = {
                id: Date.now().toString(),
                sender: sender,
                recipient: currentUser,
                itemType: itemType, // 'character', 'credits', 'message'
                itemData: itemData,
                message: message,
                timestamp: new Date().toISOString(),
                read: false,
                claimed: false
            };

            mailboxItems.unshift(mailItem); // Add to beginning
            saveMailbox();
            updateMailboxUI();
            updateMailboxNotificationDot();
        }

        function updateMailboxUI() {
            const mailboxContainer = document.getElementById('mailboxItems');
            const unreadCount = document.getElementById('unreadMailCount');
            const totalCount = document.getElementById('totalMailCount');

            if (!mailboxContainer) return;

            // Update counts
            const unreadItems = mailboxItems.filter(item => !item.read);
            unreadCount.textContent = unreadItems.length;
            totalCount.textContent = mailboxItems.length;

            // Update mailbox notification dot
            updateMailboxNotificationDot();

            // Update items list
            if (mailboxItems.length === 0) {
                mailboxContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÆ</div>
                        <div>No mail items yet</div>
                        <div style="font-size: 10px; margin-top: 8px;">Gifts and items from other players will appear here</div>
                    </div>
                `;
            } else {
                mailboxContainer.innerHTML = '';
                // Create mail elements asynchronously
                mailboxItems.forEach(async item => {
                    const mailElement = await createMailItemElement(item);
                    mailboxContainer.appendChild(mailElement);
                });
            }
        }

        async function createMailItemElement(item) {
            const div = document.createElement('div');
            div.className = 'mail-item';
            div.style.cssText = `
                background: ${item.read ? '#f8f8f8' : 'white'};
                border: 1px solid ${item.read ? '#d0d0d0' : '#316ac5'};
                border-radius: 3px;
                padding: 12px;
                margin-bottom: 8px;
                cursor: pointer;
                transition: all 0.1s ease;
                position: relative;
            `;

            const itemIcon = getItemIcon(item.itemType);
            const itemName = getItemName(item.itemType, item.itemData);
            const senderAvatar = await getUserAvatar(item.sender);

            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;">${senderAvatar}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #1f4e79; font-size: 11px; margin-bottom: 2px;">
                            ${item.sender} sent you ${itemName}
                        </div>
                        <div style="font-size: 10px; color: #666; margin-bottom: 4px;">
                            ${new Date(item.timestamp).toLocaleString()}
                        </div>
                        ${item.message ? `<div style="font-size: 10px; color: #333; font-style: italic;">"${item.message}"</div>` : ''}
                    </div>
                    <div style="font-size: 24px; position: relative;">${itemIcon}
                        ${!item.read ? '<div class="conversation-notification-dot"></div>' : ''}
                    </div>
                </div>
            `;

            div.onclick = () => openMailItem(item);
            return div;
        }

        function getItemIcon(itemType) {
            switch (itemType) {
                case 'character': return 'üë§';
                case 'credits': return 'üí∞';
                case 'message': return 'üí¨';
                default: return 'üéÅ';
            }
        }

        function getItemName(itemType, itemData) {
            switch (itemType) {
                case 'character': return itemData.name || 'a character';
                case 'credits': return `${itemData.amount} Game Credits`;
                case 'message': return 'a message';
                default: return 'a gift';
            }
        }

        function openMailItem(item) {
            // Mark as read
            item.read = true;
            saveMailbox();
            updateMailboxUI();
            updateMailboxNotificationDot();

            // Show item details and claim option
            if (item.itemType === 'character' && !item.claimed) {
                showCharacterGiftModal(item);
            } else if (item.itemType === 'credits' && !item.claimed) {
                showCreditsGiftModal(item);
            } else {
                showMessageGiftModal(item);
            }
        }

        function showCharacterGiftModal(item) {
            const character = item.itemData;
            
            // Store the current gift item for the modal
            window.currentGiftItem = item;
            
            // Update modal content
            document.getElementById('giftAcceptanceIcon').textContent = character.icon;
            document.getElementById('giftAcceptanceFrom').textContent = `From: ${item.sender}`;
            document.getElementById('giftAcceptanceItem').textContent = character.name;
            document.getElementById('giftAcceptanceDescription').textContent = character.description;
            
            // Show message if available
            const messageElement = document.getElementById('giftAcceptanceMessage');
            if (item.message) {
                messageElement.textContent = `"${item.message}"`;
                messageElement.style.display = 'block';
            } else {
                messageElement.style.display = 'none';
            }
            
            // Show the modal
            document.getElementById('giftAcceptanceModal').style.display = 'block';
        }

        function showCreditsGiftModal(item) {
            alert(`üí∞ Credits Gift Received!\n\nFrom: ${item.sender}\nAmount: ${item.itemData.amount} GC\n\n${item.message ? `Message: "${item.message}"` : ''}\n\nClick OK to claim these credits!`);
            
            // Claim the credits
            claimCreditsGift(item);
        }

        function showMessageGiftModal(item) {
            alert(`üí¨ Message Received!\n\nFrom: ${item.sender}\n\nMessage: "${item.message}"`);
        }

        async function acceptCharacterGift(item) {
            const character = item.itemData;
            
            try {
                console.log('üéÅ Claiming character gift:', character.name);
                
                // Claim gift via database API
                const response = await fetch(`${RAILWAY_API_URL}/api/gifts/${item.id}/claim`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Gift claimed successfully:', result);
                    
                    // Find the character ID from the character database
                    const characterFromDB = characterDatabase.find(char => char.name === character.name);
                    const characterId = characterFromDB ? characterFromDB.id : character.name.toLowerCase().replace(/\s+/g, '');
                    
                    // Add character to owned characters
                    if (!ownedCharacters.includes(characterId)) {
                        ownedCharacters.push(characterId);
                        await saveCharacterData();
                        updateCharacterCardStatuses();
                    }
                    
                    // Add character to inventory
                    const newInventoryItem = {
                        id: `character_${characterId}_${Date.now()}`,
                        type: 'character',
                        name: character.name,
                        icon: character.icon,
                        description: character.description,
                        price: character.price,
                        acquiredDate: new Date().toISOString(),
                        source: 'gift',
                        quantity: 1
                    };
                    
                    inventoryItems.push(newInventoryItem);
                    saveInventory();
                    
                    // Update filtered items to include the new item
                    filteredInventoryItems = [...inventoryItems];
                    
                    // Update inventory UI immediately
                    updateInventoryUI();
                    
                    // Reload mailbox to get updated status
                    await loadMailbox();
                    
                    alert(`‚úÖ Character "${character.name}" has been added to your collection!`);
                } else {
                    const errorResult = await response.json();
                    console.error('‚ùå Failed to claim gift:', errorResult);
                    alert('‚ùå Failed to claim gift. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error claiming gift:', error);
                alert('‚ùå Error claiming gift. Please try again.');
            }
        }

        async function rejectCharacterGift(item) {
            const character = item.itemData;
            const sender = item.sender;
            
            try {
                console.log('‚ùå Rejecting character gift:', character.name);
                
                // Reject gift via database API
                const response = await fetch(`${RAILWAY_API_URL}/api/gifts/${item.id}/reject`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Gift rejected successfully:', result);
                    
                    // Reload mailbox to get updated status
                    await loadMailbox();
                    
                    alert(`‚ùå Gift rejected! The character has been returned to ${sender}.`);
                } else {
                    const errorResult = await response.json();
                    console.error('‚ùå Failed to reject gift:', errorResult);
                    alert('‚ùå Failed to reject gift. Please try again.');
                }
            } catch (error) {
                console.error('‚ùå Error rejecting gift:', error);
                alert('‚ùå Error rejecting gift. Please try again.');
            }
        }

        async function claimCreditsGift(item) {
            const creditsAmount = item.itemData.amount;
            
            // Add credits to user's account
            gameCredits += creditsAmount;
            await saveCharacterData();
            
            // Update credits display
            document.getElementById('creditsAmount').textContent = gameCredits;
            document.getElementById('gcBalance').textContent = gameCredits + ' GC';
            document.getElementById('creditsAmountSidebar').textContent = gameCredits + ' GC';
            
            // Mark as claimed and read
            item.claimed = true;
            item.read = true;
            saveMailbox();
            updateMailboxUI();
            updateMailboxNotificationDot();
            
            alert(`‚úÖ ${creditsAmount} Game Credits have been added to your account!`);
        }

        function updateMailboxNotificationDot() {
            const notificationDot = document.getElementById('mailboxNotificationDot');
            const unreadItems = mailboxItems.filter(item => !item.read);
            
            if (unreadItems.length > 0) {
                notificationDot.style.display = 'block';
            } else {
                notificationDot.style.display = 'none';
            }
        }

        function acceptAllGifts() {
            const unclaimedGifts = mailboxItems.filter(item => !item.claimed);
            
            if (unclaimedGifts.length === 0) {
                alert('No unclaimed gifts to accept.');
                return;
            }
            
            if (confirm(`Accept all ${unclaimedGifts.length} unclaimed gifts?`)) {
                unclaimedGifts.forEach(item => {
                    if (item.itemType === 'character') {
                        acceptCharacterGift(item);
                    } else if (item.itemType === 'credits') {
                        claimCreditsGift(item);
                    }
                });
                
                alert(`‚úÖ All ${unclaimedGifts.length} gifts have been accepted!`);
            }
        }

        function rejectAllGifts() {
            const unclaimedGifts = mailboxItems.filter(item => !item.claimed);
            
            if (unclaimedGifts.length === 0) {
                alert('No unclaimed gifts to reject.');
                return;
            }
            
            if (confirm(`Reject all ${unclaimedGifts.length} unclaimed gifts? They will be returned to the senders.`)) {
                unclaimedGifts.forEach(item => {
                    if (item.itemType === 'character') {
                        rejectCharacterGift(item);
                    }
                });
                
                alert(`‚ùå All ${unclaimedGifts.length} gifts have been rejected and returned to senders!`);
            }
        }

        function refreshMailbox() {
            loadMailbox();
        }

        // Gift Sending Modal Functions
        let selectedGiftRecipient = null;

        function openGiftSendingModal() {
            if (!window.giftCharacterData) return;
            
            // Update gift item display
            document.getElementById('giftItemIcon').textContent = window.giftCharacterData.icon;
            document.getElementById('giftItemName').textContent = window.giftCharacterData.name;
            
            // Clear previous selections
            clearGiftRecipientSearch();
            selectedGiftRecipient = null;
            document.getElementById('giftSelectedRecipient').style.display = 'none';
            document.getElementById('sendGiftBtn').style.display = 'none';
            document.getElementById('giftMessage').value = '';
            
            // Show modal
            document.getElementById('giftSendingModal').style.display = 'block';
        }

        function closeGiftSendingModal() {
            document.getElementById('giftSendingModal').style.display = 'none';
            clearGiftRecipientSearch();
            selectedGiftRecipient = null;
            window.giftCharacterData = null;
        }

        async function searchGiftRecipients() {
            const searchTerm = document.getElementById('giftRecipientSearch').value.toLowerCase().trim();
            const recipientResults = document.getElementById('giftRecipientResults');
            const recipientList = document.getElementById('giftRecipientList');
            
            console.log('üéÅ Gift Search: Function called with term:', searchTerm);
            console.log('üéÅ Gift Search: DOM elements found:', {
                searchInput: !!document.getElementById('giftRecipientSearch'),
                resultsDiv: !!recipientResults,
                listDiv: !!recipientList
            });
            
            if (searchTerm === '') {
                console.log('üéÅ Gift Search: Empty search term, hiding results');
                recipientResults.style.display = 'none';
                return;
            }
            
            console.log('üéÅ Gift Search: Searching for users:', searchTerm);
            
            // Try Railway API first
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(searchTerm)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Gift Railway search result:', result);
                    
                    let filteredUsers = [];
                    if (result.success && result.users && Array.isArray(result.users)) {
                        filteredUsers = result.users.map(user => user.username);
                        console.log('üë• Gift Found Railway users:', filteredUsers);
                    } else {
                        console.log('‚ùå Gift Railway search: Invalid result format or no users found');
                    }
                    
                    if (filteredUsers.length > 0) {
                        console.log('üéÅ Gift Search: Creating cards for', filteredUsers.length, 'users');
                        recipientList.innerHTML = '';
                        
                        // Create cards for each user (await all async operations)
                        for (const username of filteredUsers) {
                            console.log('üéÅ Gift Search: Creating card for:', username);
                            const recipientCard = await createGiftRecipientCard(username);
                            recipientList.appendChild(recipientCard);
                        }
                        
                        recipientResults.style.display = 'block';
                        console.log('‚úÖ Gift Showing Railway users in search results');
                        return;
                    } else {
                        console.log('üéÅ Gift Search: No users found, showing no results message');
                    }
                } else {
                    console.log('‚ùå Gift Railway search: HTTP error:', response.status, response.statusText);
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Gift Railway search failed:', error.message);
            }
            
            // No users found
            recipientList.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #666;">
                    <div style="font-size: 24px; margin-bottom: 8px;">üë§</div>
                    <div>No registered users found matching "${searchTerm}"</div>
                    <div style="font-size: 12px; margin-top: 8px; color: #999;">
                        Only registered SkyParty users can receive gifts
                    </div>
                </div>
            `;
            recipientResults.style.display = 'block';
        }

        async function createGiftRecipientCard(username) {
            const card = document.createElement('div');
            card.className = 'user-card';
            card.style.cssText = `
                background: white;
                border: 1px outset #ece9d8;
                padding: 8px;
                text-align: center;
                cursor: pointer;
                transition: all 0.1s ease;
                border-radius: 3px;
                min-height: 60px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            `;

            const userAvatar = await getUserAvatar(username);

            card.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 4px;">${userAvatar}</div>
                <div style="font-weight: bold; color: #1f4e79; font-size: 11px;">${username}</div>
            `;

            card.onclick = () => selectGiftRecipient(username);
            return card;
        }

        async function selectGiftRecipient(username) {
            selectedGiftRecipient = username;
            
            // Update selected recipient display
            const userAvatar = await getUserAvatar(username);
            document.getElementById('giftSelectedRecipientAvatar').textContent = userAvatar;
            document.getElementById('giftSelectedRecipientName').textContent = username;
            document.getElementById('giftSelectedRecipient').style.display = 'block';
            
            // Show Send Gift button
            document.getElementById('sendGiftBtn').style.display = 'inline-block';
            
            // Hide search results
            document.getElementById('giftRecipientResults').style.display = 'none';
            document.getElementById('giftRecipientSearch').value = '';
        }

        function clearGiftRecipientSearch() {
            document.getElementById('giftRecipientSearch').value = '';
            document.getElementById('giftRecipientResults').style.display = 'none';
        }

        async function sendGiftToRecipient() {
            if (!selectedGiftRecipient || !window.giftCharacterData) return;
            
            // Check if recipient exists in Railway database
            try {
                const response = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(selectedGiftRecipient)}`);
                if (response.ok) {
                    const result = await response.json();
                    if (!result.success || !result.users || result.users.length === 0) {
                        alert('‚ùå User not found. Please check the username and try again.');
                        return;
                    }
                    
                    const recipientExists = result.users.some(user => user.username === selectedGiftRecipient);
                    if (!recipientExists) {
                        alert('‚ùå User not found. Please check the username and try again.');
                        return;
                    }
                } else {
                    alert('‚ùå Error checking user. Please try again.');
                    return;
                }
            } catch (error) {
                console.error('Error checking recipient:', error);
                alert('‚ùå Error checking user. Please try again.');
                return;
            }
            
            // Remove one character from inventory
            console.log('Looking for character to remove:', window.giftCharacterData.name);
            console.log('Current inventory items:', inventoryItems);
            
            const characterIndex = inventoryItems.findIndex(item => 
                item.type === 'character' && item.name === window.giftCharacterData.name
            );
            
            console.log('Found character at index:', characterIndex);
            
            if (characterIndex !== -1) {
                console.log('Removing character:', inventoryItems[characterIndex]);
                
                // Check if this is the currently equipped character and if we'll have any left
                const characterId = window.giftCharacterData.name.toLowerCase().replace(/\s+/g, '');
                const isCurrentlyEquipped = currentCharacter === characterId;
                
                // Count how many copies of this character we currently have
                const currentQuantity = inventoryItems.filter(item => 
                    item.type === 'character' && item.name === window.giftCharacterData.name
                ).length;
                
                console.log('Current quantity of', window.giftCharacterData.name, ':', currentQuantity);
                
                // Only switch to kitty if this is our current character AND we'll have 0 left after gifting
                if (isCurrentlyEquipped && currentQuantity <= 1) {
                    console.log('‚ö†Ô∏è Sending last copy of currently equipped character, switching to kitty');
                    currentCharacter = 'kitty';
                    updateAvatar();
                    
                    // Update owned characters list
                    if (ownedCharacters.includes(characterId)) {
                        ownedCharacters = ownedCharacters.filter(char => char !== characterId);
                        updateCharacterDatabase();
                    }
                    
                    // Save character data changes
                    await saveCharacterData();
                } else if (isCurrentlyEquipped && currentQuantity > 1) {
                    console.log('‚úÖ Sending character but still have', currentQuantity - 1, 'copies left, keeping current character');
                }
                
                inventoryItems.splice(characterIndex, 1);
                saveInventory();
                
                // Update filtered items to reflect the removal
                filteredInventoryItems = [...inventoryItems];
                
                updateInventoryUI();
                console.log('Character removed successfully');
            } else {
                console.log('Character not found in inventory!');
                alert('‚ùå Error: Character not found in inventory. Please try again.');
                return; // Exit early if character not found
            }
            
            // Send gift to recipient via Railway database
            const giftMessage = document.getElementById('giftMessage').value || '';
            
            try {
                // Get recipient's user data from Railway
                const recipientResponse = await fetch(`${RAILWAY_API_URL}/api/users/search?query=${encodeURIComponent(selectedGiftRecipient)}`);
                if (recipientResponse.ok) {
                    const recipientResult = await recipientResponse.json();
                    if (recipientResult.success && recipientResult.users && recipientResult.users.length > 0) {
                        const recipientUser = recipientResult.users.find(user => user.username === selectedGiftRecipient);
                        if (recipientUser) {
                            console.log('üéÅ Sending gift to:', selectedGiftRecipient, 'ID:', recipientUser.id);
                            
                            // Send gift via Railway database API
                            const giftResponse = await fetch(`${RAILWAY_API_URL}/api/gifts/send`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    senderId: currentUserId,
                                    recipientId: recipientUser.id,
                                    itemType: 'character',
                                    itemData: {
                                        name: window.giftCharacterData.name,
                                        icon: window.giftCharacterData.icon,
                                        description: window.giftCharacterData.description,
                                        price: window.giftCharacterData.price
                                    },
                                    message: giftMessage
                                })
                            });
                            
                            if (giftResponse.ok) {
                                const giftResult = await giftResponse.json();
                                console.log('‚úÖ Gift sent successfully:', giftResult);
                                
                                alert(`‚úÖ Gift Sent!\n\n${window.giftCharacterData.name} has been sent to ${selectedGiftRecipient}!\n\nThey will receive it in their mailbox immediately.`);
                                
                                // Close modal
                                closeGiftSendingModal();
                            } else {
                                const errorResult = await giftResponse.json();
                                console.error('‚ùå Failed to send gift:', errorResult);
                                alert('‚ùå Failed to send gift. Please try again.');
                            }
                        } else {
                            alert('‚ùå User not found. Please check the username and try again.');
                        }
                    } else {
                        alert('‚ùå User not found. Please check the username and try again.');
                    }
                } else {
                    alert('‚ùå Error sending gift. Please try again.');
                }
            } catch (error) {
                console.error('Error sending gift:', error);
                alert('‚ùå Error sending gift. Please try again.');
            }
        }

        // Gift Acceptance Modal Functions
        function closeGiftAcceptanceModal() {
            document.getElementById('giftAcceptanceModal').style.display = 'none';
            window.currentGiftItem = null;
        }

        function acceptGiftFromModal() {
            if (window.currentGiftItem) {
                acceptCharacterGift(window.currentGiftItem);
                closeGiftAcceptanceModal();
            }
        }

        function rejectGiftFromModal() {
            if (window.currentGiftItem) {
                rejectCharacterGift(window.currentGiftItem);
                closeGiftAcceptanceModal();
            }
        }

        // Initialize mailbox on login
        function initializeMailbox() {
            setTimeout(() => {
                loadMailbox();
            }, 300);
        }

        // Inventory System
        let inventoryItems = [];
        let filteredInventoryItems = [];

        function loadInventory() {
            if (!currentUser) return;

            // Load inventory items from localStorage first
            const inventoryData = localStorage.getItem(`inventory_${currentUser}`);
            if (inventoryData) {
                try {
                    inventoryItems = JSON.parse(inventoryData);
                } catch (error) {
                    console.error('Error parsing inventory data:', error);
                    inventoryItems = [];
                }
            } else {
                inventoryItems = [];
            }

            // Add owned characters that are not already in inventory
            console.log('üîÑ Loading inventory - ownedCharacters:', ownedCharacters);
            console.log('üîÑ Loading inventory - current inventoryItems:', inventoryItems.map(item => ({name: item.name, type: item.type})));
            
            ownedCharacters.forEach(characterId => {
                console.log('üîÑ Checking character:', characterId);
                
                // Check if character is already in inventory using multiple matching strategies
                const alreadyInInventory = inventoryItems.some(item => {
                    if (item.type !== 'character') return false;
                    
                    // Strategy 1: Match by character ID (most reliable)
                    const itemCharacterId = item.name.toLowerCase().replace(/\s+/g, '');
                    if (itemCharacterId === characterId) return true;
                    
                    // Strategy 2: Match by exact name
                    const character = characterDatabase.find(char => char.id === characterId);
                    if (character && item.name === character.name) return true;
                    
                    return false;
                });
                
                console.log('üîÑ Character', characterId, 'already in inventory:', alreadyInInventory);
                
                if (!alreadyInInventory) {
                    let character;
                    if (characterId === 'kitty') {
                        // Special case for Kitty since it's not in characterDatabase anymore
                        character = {
                            id: 'kitty',
                            name: 'Kitty',
                            icon: 'üê±',
                            price: 0,
                            description: 'A cute and friendly kitty character. Perfect for beginners!'
                        };
                    } else {
                        character = characterDatabase.find(char => char.id === characterId);
                    }
                    
                    if (character) {
                        console.log('‚úÖ Adding character to inventory:', character.name);
                        inventoryItems.push({
                            id: `character_${characterId}_${Date.now()}`,
                            type: 'character',
                            name: character.name,
                            icon: character.icon,
                            description: character.description,
                            price: character.price,
                            acquiredDate: new Date().toISOString(),
                            source: characterId === 'kitty' ? 'default' : 'purchase',
                            quantity: 1
                        });
                    } else {
                        console.log('‚ùå Character not found in database:', characterId);
                    }
                } else {
                    console.log('‚ö†Ô∏è Character already in inventory:', characterId);
                }
            });

            // Save the updated inventory
            saveInventory();

            // Initialize filtered items
            filteredInventoryItems = [...inventoryItems];
            updateInventoryUI();
        }

        function saveInventory() {
            if (!currentUser) return;

            // Save all inventory items
            localStorage.setItem(`inventory_${currentUser}`, JSON.stringify(inventoryItems));
        }

        function addInventoryItem(itemType, itemData, source = 'purchase', quantity = 1) {
            if (!currentUser) return;

            const inventoryItem = {
                id: `${itemType}_${Date.now()}`,
                type: itemType,
                name: itemData.name || itemData.title || 'Unknown Item',
                icon: itemData.icon || 'üéÅ',
                description: itemData.description || '',
                price: itemData.price || 0,
                acquiredDate: new Date().toISOString(),
                source: source, // 'purchase', 'gift', 'reward'
                quantity: quantity,
                ...itemData
            };

            inventoryItems.push(inventoryItem);
            saveInventory();
            updateInventoryUI();
        }

        function updateInventoryUI() {
            const inventoryContainer = document.getElementById('inventoryItems');
            const totalCount = document.getElementById('totalItemsCount');
            const charactersCount = document.getElementById('charactersCount');
            const otherItemsCount = document.getElementById('otherItemsCount');

            if (!inventoryContainer) return;

            // Update counts
            const characters = inventoryItems.filter(item => item.type === 'character');
            const otherItems = inventoryItems.filter(item => item.type !== 'character');
            
            totalCount.textContent = inventoryItems.length;
            charactersCount.textContent = characters.length;
            otherItemsCount.textContent = otherItems.length;

            // Update items display
            if (filteredInventoryItems.length === 0) {
                inventoryContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üéí</div>
                        <div>No items found</div>
                        <div style="font-size: 10px; margin-top: 8px;">Try adjusting your search or check if you have any items</div>
                    </div>
                `;
            } else {
                inventoryContainer.innerHTML = '';
                filteredInventoryItems.forEach(item => {
                    const itemElement = createInventoryItemElement(item);
                    inventoryContainer.appendChild(itemElement);
                });
            }
        }

        function searchInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            
            if (searchTerm === '') {
                filteredInventoryItems = [...inventoryItems];
            } else {
                filteredInventoryItems = inventoryItems.filter(item => 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.type.toLowerCase().includes(searchTerm) ||
                    item.description.toLowerCase().includes(searchTerm)
                );
            }
            
            updateInventoryUI();
        }

        function clearInventorySearch() {
            document.getElementById('inventorySearch').value = '';
            filteredInventoryItems = [...inventoryItems];
            updateInventoryUI();
        }

        function createInventoryItemElement(item) {
            const div = document.createElement('div');
            div.className = 'inventory-item';
            div.style.cssText = `
                background: white;
                border: 1px solid #d0d0d0;
                border-radius: 3px;
                padding: 12px;
                cursor: pointer;
                transition: all 0.1s ease;
                position: relative;
                text-align: center;
            `;

            const sourceIcon = getSourceIcon(item.source);
            const typeIcon = getTypeIcon(item.type);

            div.innerHTML = `
                <div style="font-size: 32px; margin-bottom: 8px;">${item.icon}</div>
                <div style="font-weight: bold; color: #1f4e79; font-size: 11px; margin-bottom: 4px;">${item.name}</div>
                <div style="font-size: 9px; color: #666; margin-bottom: 4px;">${item.type}</div>
                <div style="font-size: 8px; color: #999; margin-bottom: 8px;">${new Date(item.acquiredDate).toLocaleDateString()}</div>
                <div style="position: absolute; top: 4px; right: 4px; font-size: 12px;" title="${item.source}">${sourceIcon}</div>
                ${item.quantity > 1 ? `<div style="position: absolute; top: 4px; left: 4px; background: #316ac5; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 8px; display: flex; align-items: center; justify-content: center;">${item.quantity}</div>` : ''}
            `;

            div.onclick = () => showInventoryItemDetails(item);
            return div;
        }

        function getSourceIcon(source) {
            switch (source) {
                case 'purchase': return 'üõí';
                case 'gift': return 'üéÅ';
                case 'reward': return 'üèÜ';
                case 'default': return '‚≠ê';
                case 'returned': return '‚Ü©Ô∏è';
                default: return '‚ùì';
            }
        }

        function getTypeIcon(type) {
            switch (type) {
                case 'character': return 'üë§';
                case 'credits': return 'üí∞';
                case 'item': return 'üéÅ';
                default: return 'üì¶';
            }
        }

        function showInventoryItemDetails(item) {
            if (item.type === 'character') {
                // For characters, open the character details modal with inventory-specific buttons
                window.currentInventoryCharacter = item.name.toLowerCase().replace(/\s+/g, '');
                showCharacterDetailsFromInventory(item.name.toLowerCase().replace(/\s+/g, ''));
            } else {
                // For other items, show details in alert
                let message = `üì¶ ${item.name}\n\n`;
                message += `Type: ${item.type}\n`;
                message += `Source: ${item.source}\n`;
                message += `Acquired: ${new Date(item.acquiredDate).toLocaleString()}\n`;
                if (item.quantity > 1) {
                    message += `Quantity: ${item.quantity}\n`;
                }
                if (item.description) {
                    message += `\nDescription: ${item.description}`;
                }
                
                alert(message);
            }
        }

        function refreshInventory() {
            loadInventory();
        }

        // Initialize inventory on login
        function initializeInventory() {
            setTimeout(() => {
                loadInventory();
            }, 400);
        }

        // Logout Functions
        function logout() {
            // Show the logout confirmation modal instead of logging out immediately
            document.getElementById("logoutModal").style.display = "block";
        }

        function closeLogoutModal() {
            document.getElementById("logoutModal").style.display = "none";
        }

        async function confirmLogout() {
            // Hide modal
            closeLogoutModal();

            // Clear login state
            await clearLoginState();
            
            // Reset global variables
            currentUser = '';
            currentUserId = null;
            isLoggedIn = false;
            gameCredits = 0;
            isActivated = false;
            
                    // Reset activation UI to unactivated state
                    document.querySelector('.title-bar-text').textContent = 'SkyParty (Unactivated)';
                    
                    // Re-enable activation code boxes
                    for (let i = 1; i <= 4; i++) {
                        const box = document.getElementById(`activationCode${i}`);
                        if (box) {
                            box.classList.remove('activated');
                            box.disabled = false;
                            box.value = '';
                        }
                    }
                    
                    // Show activate button and hide activation status
                    const activateBtn = document.getElementById('activateBtn');
                    const activationStatus = document.getElementById('activationStatus');
                    if (activateBtn) activateBtn.style.display = 'block';
                    if (activationStatus) activationStatus.style.display = 'none';
                    
                    // Show activation warning
                    const activationWarning = document.getElementById('activationWarning');
                    if (activationWarning) activationWarning.style.display = 'block';
                    
                    // Update license information
                    const licenseStatus = document.getElementById('licenseStatus');
                    const licenseType = document.getElementById('licenseType');
                    const licenseDays = document.getElementById('licenseDays');
                    if (licenseStatus) {
                        licenseStatus.textContent = 'Unactivated';
                        licenseStatus.style.color = '#dc3545';
                    }
                    if (licenseType) licenseType.textContent = 'Evaluation (Limited Features)';
                    if (licenseDays) licenseDays.textContent = '30 days';
                    
            // Reset UI to logged-out state
            initializeUI();
            
            console.log('‚úÖ Logout successful');
        }

        // Universal Custom Popup System
        let customPopupResolve = null;
        let customPopupInput = null;

        function showCustomAlert(message, title = "Information", icon = "‚ÑπÔ∏è") {
            return new Promise((resolve) => {
                const overlay = document.getElementById("customPopupOverlay");
                const popupIcon = document.getElementById("customPopupIcon");
                const popupTitle = document.getElementById("customPopupTitle");
                const popupMessage = document.getElementById("customPopupMessage");
                const popupInput = document.getElementById("customPopupInput");
                const popupButtons = document.getElementById("customPopupButtons");

                popupIcon.textContent = icon;
                popupTitle.textContent = title;
                popupMessage.textContent = message;
                popupInput.style.display = "none";
                popupButtons.innerHTML = '<button class="xp-button" onclick="closeCustomPopup()">OK</button>';

                customPopupResolve = resolve;
                overlay.style.display = "flex";
            });
        }

        function showCustomConfirm(message, title = "Confirmation", icon = "‚ùì") {
            return new Promise((resolve) => {
                const overlay = document.getElementById("customPopupOverlay");
                const popupIcon = document.getElementById("customPopupIcon");
                const popupTitle = document.getElementById("customPopupTitle");
                const popupMessage = document.getElementById("customPopupMessage");
                const popupInput = document.getElementById("customPopupInput");
                const popupButtons = document.getElementById("customPopupButtons");

                popupIcon.textContent = icon;
                popupTitle.textContent = title;
                popupMessage.textContent = message;
                popupInput.style.display = "none";
                popupButtons.innerHTML = `
                    <button class="xp-button" onclick="closeCustomPopup(false)">Cancel</button>
                    <button class="xp-button primary" onclick="closeCustomPopup(true)">OK</button>
                `;

                customPopupResolve = resolve;
                overlay.style.display = "flex";
            });
        }

        function showCustomPrompt(message, defaultValue = "", title = "Input", icon = "‚úèÔ∏è") {
            return new Promise((resolve) => {
                const overlay = document.getElementById("customPopupOverlay");
                const popupIcon = document.getElementById("customPopupIcon");
                const popupTitle = document.getElementById("customPopupTitle");
                const popupMessage = document.getElementById("customPopupMessage");
                const popupInput = document.getElementById("customPopupInput");
                const popupButtons = document.getElementById("customPopupButtons");

                popupIcon.textContent = icon;
                popupTitle.textContent = title;
                popupMessage.textContent = message;
                popupInput.value = defaultValue;
                popupInput.style.display = "block";
                popupButtons.innerHTML = `
                    <button class="xp-button" onclick="closeCustomPopup(null)">Cancel</button>
                    <button class="xp-button primary" onclick="closeCustomPopup(customPopupInput.value)">OK</button>
                `;

                customPopupResolve = resolve;
                customPopupInput = popupInput;
                overlay.style.display = "flex";
                popupInput.focus();
            });
        }

        function closeCustomPopup(result = null) {
            const overlay = document.getElementById("customPopupOverlay");
            overlay.style.display = "none";
            if (customPopupResolve) {
                customPopupResolve(result);
                customPopupResolve = null;
            }
        }

        // Override native browser functions
        window.alert = showCustomAlert;
        window.confirm = showCustomConfirm;
        window.prompt = showCustomPrompt;

        // Electron API Bridge
        if (typeof require !== 'undefined') {
            const { ipcRenderer } = require('electron');
            window.electronAPI = {
                invoke: (channel, ...args) => ipcRenderer.invoke(channel, ...args),
                send: (channel, ...args) => ipcRenderer.send(channel, ...args),
                on: (channel, callback) => ipcRenderer.on(channel, callback)
            };
        }

        // Electron Data Persistence Functions
        async function saveData(key, data) {
            if (window.electronAPI) {
                try {
                    const result = await window.electronAPI.invoke('data:save', key, data);
                    if (result.success) {
                        console.log('Data saved successfully:', key);
                        return true;
                    } else {
                        console.error('Failed to save data:', result.error);
                        // Fallback to localStorage
                        localStorage.setItem(key, JSON.stringify(data));
                        return false;
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                    // Fallback to localStorage
                    localStorage.setItem(key, JSON.stringify(data));
                    return false;
                }
            } else {
                // Browser fallback
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            }
        }

        async function loadData(key) {
            if (window.electronAPI) {
                try {
                    const result = await window.electronAPI.invoke('data:load', key);
                    if (result.success) {
                        return result.data;
                    } else {
                        console.error('Failed to load data:', result.error);
                        // Fallback to localStorage
                        const stored = localStorage.getItem(key);
                        return stored ? JSON.parse(stored) : null;
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Fallback to localStorage
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : null;
                }
            } else {
                // Browser fallback
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : null;
            }
        }

        async function loadAllData() {
            if (window.electronAPI) {
                try {
                    const result = await window.electronAPI.invoke('data:load-all');
                    if (result.success) {
                        return result.data;
                    } else {
                        console.error('Failed to load all data:', result.error);
                        return {};
                    }
                } catch (error) {
                    console.error('Error loading all data:', error);
                    return {};
                }
            } else {
                // Browser fallback - return empty object
                return {};
            }
        }

        // Window Control Functions
        function minimizeWindow() {
            if (window.electronAPI) {
                window.electronAPI.invoke('app:minimize-window');
            } else {
                // Fallback for browser
                window.blur();
            }
        }

        function maximizeWindow() {
            if (window.electronAPI) {
                window.electronAPI.invoke('app:maximize-window');
            } else {
                // Fallback for browser
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    document.documentElement.requestFullscreen();
                }
            }
        }

        function closeWindow() {
            if (window.electronAPI) {
                window.electronAPI.invoke('app:close-window');
            } else {
                // Fallback for browser
                window.close();
            }
        }

        // Make window draggable (for frameless window)
        if (window.electronAPI) {
            document.addEventListener('DOMContentLoaded', () => {
                // Make the title bar draggable
                const titleBar = document.querySelector('.title-bar');
                if (titleBar) {
                    titleBar.style.webkitAppRegion = 'drag';
                    titleBar.style.cursor = 'move';
                }
                
                // Make window control buttons non-draggable
                const windowControls = document.querySelectorAll('.title-bar-button');
                windowControls.forEach(button => {
                    button.style.webkitAppRegion = 'no-drag';
                });
            });
        }

        // Logout Functions
        function confirmLogout() {
            console.log('üö™ Confirming logout...');
            
            // Stop avatar synchronization system
            stopAvatarSyncSystem();
            
            // Reset all user data
            isLoggedIn = false;
            currentUser = '';
            currentUserId = null;
            currentCharacter = 'kitty';
            ownedCharacters = ['kitty'];
            gameCredits = 0;
            isActivated = false;
            
            // Reset all avatar displays to default
            updateAllAvatarDisplays('üë§');
            
            // Clear localStorage
            localStorage.removeItem('userAvatar');
            
            // Initialize UI to logged-out state
            initializeUI();
            
            // Close logout modal
            closeLogoutModal();
            
            console.log('‚úÖ Logout completed successfully');
        }

        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        function openLogoutModal() {
            document.getElementById('logoutModal').style.display = 'block';
        }

        // Enhanced alert/confirm/prompt functions for Electron
        if (window.electronAPI) {
            const originalAlert = window.alert;
            const originalConfirm = window.confirm;
            const originalPrompt = window.prompt;

            window.alert = async (message) => {
                if (window.electronAPI) {
                    await window.electronAPI.invoke('app:show-message', {
                        type: 'info',
                        title: 'SkyParty',
                        message: message
                    });
                } else {
                    originalAlert(message);
                }
            };

            window.confirm = async (message) => {
                if (window.electronAPI) {
                    return await window.electronAPI.invoke('app:show-confirm', {
                        title: 'Confirm',
                        message: message
                    });
                } else {
                    return originalConfirm(message);
                }
            };

            window.prompt = async (message, defaultValue = '') => {
                if (window.electronAPI) {
                    // For now, use the custom popup system
                    return await showCustomPrompt(message, defaultValue);
                } else {
                    return originalPrompt(message, defaultValue);
                }
            };
        }
    </script>
</body>
</html>